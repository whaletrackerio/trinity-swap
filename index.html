<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TRINITY Swap ‚Äî PulseChain</title>

  <!-- Ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

  <style>
    :root{
      --bg:#050816;
      --card:#0f172a;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#a855f7;
      --accent2:#ec4899;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --radius:18px;
      --shadow:0 18px 45px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(11,16,42,.82) 0%, rgba(5,8,22,.92) 55%, rgba(2,6,23,.98) 100%);
      overflow-x:hidden;
    }

    /* ‚úÖ watermark image visible partout */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:url("./bg.png") center / cover no-repeat;
      opacity:.20;
      filter:saturate(1.05) contrast(1.05);
      pointer-events:none;
      z-index:-2;
    }
    /* ‚úÖ vignette overlay pour rendre lisible */
    body::after{
      content:"";
      position:fixed;
      inset:0;
      background:
        radial-gradient(900px 600px at 50% 25%, rgba(0,0,0,.30), rgba(0,0,0,.78)),
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.55));
      pointer-events:none;
      z-index:-1;
    }

    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:22px 14px 90px}

    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      position:sticky;top:0;z-index:50;
      backdrop-filter: blur(10px);
      background:linear-gradient(180deg, rgba(5,8,22,.78), rgba(5,8,22,.35));
      border-bottom:1px solid rgba(31,41,55,.55);
      padding:14px 10px;margin:-22px -14px 18px;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.4px}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 10px 25px rgba(168,85,247,.25);
    }
    .top-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid rgba(31,41,55,.9);
      background:rgba(2,6,23,.55);
      padding:8px 10px;border-radius:999px;
    }
    .btn{
      cursor:pointer;border:none;
      padding:10px 14px;border-radius:999px;
      background:linear-gradient(120deg,var(--accent),var(--accent2));
      color:#fff;font-weight:900;
      box-shadow:0 12px 30px rgba(236,72,153,.15);
      white-space:nowrap;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn2{
      cursor:pointer;border:1px solid rgba(31,41,55,.9);
      padding:10px 14px;border-radius:999px;
      background:rgba(2,6,23,.55);
      color:var(--text);font-weight:900;
      white-space:nowrap;
    }

    .grid2{display:grid;grid-template-columns:1.25fr .75fr;gap:14px;align-items:stretch}
    @media(max-width:980px){.grid2{grid-template-columns:1fr}}

    .card{
      background:linear-gradient(180deg, rgba(15,23,42,.90), rgba(15,23,42,.68));
      border:1px solid rgba(31,41,55,.85);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    h1{font-size:34px;line-height:1.05}
    .sub{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.55}
    .hr{height:1px;background:rgba(31,41,55,.7);margin:14px 0}
    .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .chip{
      font-size:12px;color:var(--text);
      border:1px solid rgba(31,41,55,.9);
      background:rgba(2,6,23,.55);
      padding:7px 10px;border-radius:999px;
      display:flex;align-items:center;gap:8px;
    }
    .okdot{width:10px;height:10px;border-radius:999px;background:var(--good);box-shadow:0 0 0 3px rgba(34,197,94,.15)}
    .warnbox{
      border:1px solid rgba(245,158,11,.35);
      background:rgba(245,158,11,.08);
      padding:10px 12px;border-radius:14px;
      font-size:12px;color:var(--muted);
    }
    .ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .ctaRow .btn2, .ctaRow .btn{display:inline-flex;align-items:center;gap:8px}

    .sectionTitle{
      margin-top:18px;font-weight:900;font-size:14px;letter-spacing:.35px;color:var(--text);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .sectionTitle small{color:var(--muted);font-weight:800}

    .swaps{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:12px;padding-bottom:30px}
    @media(max-width:980px){.swaps{grid-template-columns:1fr}}

    label{font-size:12px;color:var(--muted)}
    input,select{
      width:100%;margin-top:6px;
      padding:10px 11px;border-radius:14px;
      background:rgba(2,6,23,.65);
      border:1px solid rgba(31,41,55,.9);
      color:var(--text);outline:none;
    }
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .swap-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .swap-title b{font-size:13px}
    .swap-title span{font-size:12px;color:var(--muted)}
    .switch{display:flex;justify-content:center;margin:10px 0;}
    .switch button{
      border:1px solid rgba(31,41,55,.9);
      background:rgba(2,6,23,.55);
      color:var(--text);border-radius:12px;
      padding:7px 10px;cursor:pointer;
    }

    .balRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px}
    .balText{font-size:12px;color:var(--muted)}
    .balText b{color:var(--text)}
    .maxBtn,.pctBtn{
      border:1px solid rgba(31,41,55,.9);
      background:rgba(2,6,23,.55);
      color:var(--text);
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .maxBtn:disabled,.pctBtn:disabled{opacity:.55;cursor:not-allowed}
    .pctRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .status{margin-top:10px;font-size:12px;color:var(--muted)}
    .status.good{color:var(--good)}
    .status.bad{color:var(--bad)}
    .status.warn{color:var(--warn)}
    .quoteLine{margin-top:8px;font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .txlink{font-weight:900;text-decoration:none;border-bottom:1px dotted rgba(229,231,235,.35)}
    .bottomGrid{display:grid;grid-template-columns:1fr .9fr;gap:14px;margin-top:14px}
    @media(max-width:980px){.bottomGrid{grid-template-columns:1fr}}
    .linkItem{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;border-radius:16px;
      border:1px solid rgba(31,41,55,.9);
      background:rgba(2,6,23,.45);
      margin-top:10px;
    }
    .linkItem b{font-size:13px}
    .linkItem span{display:block;color:var(--muted);font-size:12px;margin-top:2px}
    .linkBtn{padding:8px 12px;border-radius:999px}
    footer{margin-top:26px;text-align:center;color:var(--muted);font-size:11px;line-height:1.6}

    /* Token modal */
    #tokenModal{display:none; position:fixed; inset:0; z-index:9999;}
    #tmBackdrop{position:absolute; inset:0; background:rgba(0,0,0,.65);}
    .tmBox{
      position:relative; max-width:760px; margin:5vh auto;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(31,41,55,.9);
      border-radius:18px; box-shadow:0 18px 45px rgba(0,0,0,.55);
      padding:14px;
    }
    @media(max-width:820px){ .tmBox{ margin:0; max-width:none; height:100vh; border-radius:0; } }

    .tmTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
    .tmClose{cursor:pointer; border:none; background:transparent; color:#22c55e; font-size:28px; font-weight:900;}
    .tmSearch{
      width:100%; padding:12px 12px; border-radius:14px; outline:none;
      background:rgba(2,6,23,.65); border:1px solid rgba(34,197,94,.45); color:#e5e7eb;
    }
    .tmList{margin-top:10px; max-height:62vh; overflow:auto; padding-right:6px;}
    @media(max-width:820px){ .tmList{max-height:72vh;} }

    .tmRow{
      display:grid;
      grid-template-columns:42px 1fr auto auto;
      align-items:center;
      gap:12px;
      padding:12px;
      border-radius:16px;
      margin-bottom:10px;
      border:1px solid rgba(31,41,55,.9);
      background:rgba(2,6,23,.45);
      cursor:pointer;
    }
    .tmName{display:flex; flex-direction:column; gap:4px;}
    .tmName b{font-size:15px}
    .tmName small{color:var(--muted)}
    .tmBal{
      text-align:right;
      min-width:130px;
      color:var(--muted);
      font-size:12px;
      line-height:1.2;
    }
    .tmBal b{display:block; color:var(--text); font-size:13px}
    .tmActions{display:flex; gap:8px; align-items:center;}
    .tmIconBtn{
      border:1px solid rgba(31,41,55,.9); background:rgba(2,6,23,.55);
      color:#e5e7eb; border-radius:12px; padding:8px 10px; cursor:pointer;
    }
    .tmLogo{
      width:38px;height:38px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .tmLogo img{width:100%;height:100%;object-fit:cover;display:block}
    .tmFoot{
      margin-top:10px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      color:#9ca3af;font-size:12px;flex-wrap:wrap;
    }
    .tmRefresh{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(31,41,55,.9); background:rgba(2,6,23,.55);
      color:#e5e7eb;border-radius:999px;padding:9px 12px;cursor:pointer;font-weight:900;
    }
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="brand"><div class="logo"></div><div>TRINITY Swap</div></div>
    <div class="top-right">
      <div class="pill" id="netPill">R√©seau : ‚Äî</div>
      <div class="pill" id="walletPill">Wallet : non connect√©</div>
      <button class="btn" id="connectBtn">Connect Wallet</button>
    </div>
  </header>

  <section class="grid2">
    <div class="card">
      <h1>Swap 3 tokens en parall√®le.<br/>Une interface, trois actions.</h1>
      <p class="sub">
        TRINITY = MultiSwap : tu pr√©pares 3 swaps diff√©rents et tu lances chaque swap avec son propre bouton.
        Mode 1 (PulseX-like) : UI au-dessus du router PulseX ‚Ä¢ non-custodial ‚Ä¢ 0 fee TRINITY.
      </p>

      <div class="chips">
        <div class="chip"><span class="okdot"></span>3 swaps ind√©pendants</div>
        <div class="chip"><span class="okdot"></span>Quotes live</div>
        <div class="chip"><span class="okdot"></span>Approve auto</div>
        <div class="chip"><span class="okdot"></span>Balances partout</div>
      </div>

      <div class="ctaRow">
        <button class="btn" id="openMultiBtn">üöÄ Ouvrir le MultiSwap</button>
        <button class="btn2" id="execTrinityBtn" disabled>‚ö° Ex√©cuter TRINITY (A‚ÜíB‚ÜíC)</button>
        <a class="btn2" href="https://whaletrackerio.github.io/autopilot-pulsechain/" target="_blank" rel="noreferrer">‚ö° AutoPilot</a>
        <a class="btn2" href="https://whaletrackerio.github.io/dca-pulsechain/" target="_blank" rel="noreferrer">üìà DCA</a>
      </div>

      <div class="hr"></div>
      <div class="warnbox">‚ö†Ô∏è Teste avec de petits montants. TRINITY ne garde pas tes fonds : c‚Äôest ton wallet qui signe.</div>
    </div>

    <div class="card">
      <div style="font-weight:900;font-size:14px">R√©glages</div>
      <p class="sub">Slippage + deadline pour calculer le minOut sur chaque swap.</p>

      <div class="hr"></div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>Slippage (%)</label>
          <input id="slippage" type="number" min="0" step="0.1" value="2.0" />
        </div>
        <div>
          <label>Deadline (minutes)</label>
          <input id="deadlineM" type="number" min="1" step="1" value="10" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="warnbox">
        Explorer : <a class="txlink" target="_blank" rel="noreferrer" href="https://otter.pulsechain.com/">otter.pulsechain.com</a>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn2" id="refreshBtn">‚Üª Refresh balances/quotes</button>
        <button class="btn2" id="openTokenListBtn">ü™ô Ouvrir la liste tokens</button>
      </div>

      <div class="status" id="tokenListStatus" style="margin-top:10px">Tokenlist : chargement‚Ä¶</div>
    </div>
  </section>

  <div class="sectionTitle" id="multiswap">
    <div>MULTISWAP</div>
    <small>Pr√©pare 3 swaps puis clique sur le bouton de celui que tu veux ex√©cuter.</small>
  </div>

  <section class="swaps" id="swaps"></section>

  <section class="bottomGrid">
    <div class="card">
      <div style="font-weight:900;font-size:14px">Notes</div>
      <p class="sub">
        Mode 1 = pas de fee TRINITY, pas de smart contract maison, chaque swap = 1 transaction.
        Si une quote √©choue : souvent liquidit√© / route / token non list√©.
      </p>
      <div class="hr"></div>
      <div class="warnbox">Astuce : si la route directe √©choue, TRINITY tente une route via WPLS automatiquement.</div>
    </div>

    <div class="card">
      <div style="font-weight:900;font-size:14px">LIENS RAPIDES</div>

      <div class="linkItem">
        <div><b>PulseX</b><span>Swap officiel PulseChain.</span></div>
        <a class="btn2 linkBtn" href="https://pulsex.com" target="_blank" rel="noreferrer">Ouvrir</a>
      </div>

      <div class="linkItem">
        <div><b>Otter</b><span>Explorer / tx / contrats.</span></div>
        <a class="btn2 linkBtn" href="https://otter.pulsechain.com/" target="_blank" rel="noreferrer">Explorer</a>
      </div>

      <div class="linkItem">
        <div><b>AutoPilot</b><span>Tes bots HEX/ATROPA.</span></div>
        <a class="btn2 linkBtn" href="https://whaletrackerio.github.io/autopilot-pulsechain/" target="_blank" rel="noreferrer">Aller</a>
      </div>

      <div class="linkItem">
        <div><b>DCA PulseChain</b><span>8 bots DCA (achat √† l‚Äôunit√©).</span></div>
        <a class="btn2 linkBtn" href="https://whaletrackerio.github.io/dca-pulsechain/" target="_blank" rel="noreferrer">Aller</a>
      </div>
    </div>
  </section>

  <footer>
    TRINITY Swap ‚Äî PulseChain ‚Ä¢ Mode 1 (PulseX-like) ‚Ä¢ Aucun frais TRINITY<br/>
    Utilise √† tes risques. V√©rifie les adresses et teste petit.
  </footer>

</div>

<!-- TOKEN MODAL -->
<div id="tokenModal">
  <div id="tmBackdrop"></div>
  <div class="tmBox">
    <div class="tmTop">
      <div style="font-weight:900;font-size:22px;">Select a token</div>
      <button class="tmClose" id="tmClose">‚úï</button>
    </div>
    <input class="tmSearch" id="tmSearch" placeholder="Search name or paste address" />
    <div class="tmList" id="tmList"></div>

    <div class="tmFoot">
      <div>Cliquer sur un token pour le s√©lectionner. üìã copie l‚Äôadresse. ü¶ä ajoute √† MetaMask. <span style="opacity:.75">Balance = ton solde</span></div>
      <button class="tmRefresh" id="tmRefresh">‚Üª Refresh</button>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const PULSECHAIN_ID = 369;
const PULSECHAIN_HEX = "0x171"; // 369
const TOKENLIST_URL = "https://tokens.app.pulsex.com/pulsex-extended-v0.1.2.tokenlist.json";

// Router PulseX
const PULSEX_ROUTER = "0x98bf93ebf5c380C0e6Ae8e192A7e2AE08edAcc02";

// WPLS (officiel PulseChain)
const WPLS_ADDR = "0xA1077a294dDE1B09bB078844df40758a5D0f9a27";

// r√©serve gas
const PLS_GAS_RESERVE = ethers.parseUnits("0.05", 18);

/* ================= TOKENS (seed) =================
   On va charger la tokenlist PulseX pour avoir logos/decimals, puis on "merge" tes tokens.
*/
const CUSTOM_TOKENS = [
  // base utiles (PulseChain)
  { symbol:"PLS",  address:null, decimals:18, name:"PulseChain (Native)" },
  { symbol:"WPLS", address:WPLS_ADDR, decimals:18, name:"Wrapped PLS" },

  // existants projet
  { symbol:"PHEX", address:"0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39", decimals:8,  name:"HEX (PulseChain)" },
  { symbol:"PLSX", address:"0x95B303987A60C71504D99Aa1b13B4DA07b0790ab", decimals:18, name:"PulseX" },
  { symbol:"ATROPA", address:"0xCc78A0acDF847A2C1714D2A925bB4477df5d48a6", decimals:18, name:"ATROPA" },

  // bloc 1 (comme tu as donn√©)
  { symbol:"EHEX", address:"0x57fde0a71132198BBeC939B98976993d8D89D225", decimals:8,  name:"eHEX" },
  { symbol:"INC",  address:"0x2fa878Ab3F87CC1C9737Fc071108F904c0B0C95d", decimals:18, name:"Incentive" },

  // ‚ö†Ô∏è ici tu as donn√© des adresses PulseChain (DAI/USDC/WETH) => on met celles-l√†
  { symbol:"DAI",  address:"0xefD766cCb38EaF1dfd701853BFCe31359239F305", decimals:18, name:"DAI (PulseChain)" },
  { symbol:"USDC", address:"0x15D38573d2feeb82e7ad5187aB8c1D52810B1f07", decimals:6,  name:"USDC (PulseChain)" },
  { symbol:"WETH", address:"0x02DcdD04e3F455D838cd1249292C58f3B79e3C3C", decimals:18, name:"WETH (PulseChain)" },

  { symbol:"AXIS",    address:"0x8BDB63033b02C15f113De51EA1C3a96Af9e8ecb5", decimals:18, name:"AXIS" },
  { symbol:"BANANAS", address:"0xC6B28B2E3Bf9fF26299D540a4D654F7ade4dFdB0", decimals:18, name:"BANANAS" },
  { symbol:"CST",     address:"0x600136dA8cc6D1Ea07449514604dc4ab7098dB82", decimals:18, name:"CST" },
  { symbol:"EARN",    address:"0xb513038BbFdF9D40B676F41606f4F61D4b02c4A2", decimals:18, name:"EARN" },
  { symbol:"ELIXIR",  address:"0xeCd465A15fac825B0Fe69416A4c7BfE03A50c12E", decimals:18, name:"ELIXIR" },
  { symbol:"HDRN",    address:"0x3819f64f282bf135d62168C1e513280dAF905e06", decimals:9,  name:"HDRN" },
  { symbol:"HELGO",   address:"0x0567CA0dE35606E9C260CC2358404B11DE21DB44", decimals:18, name:"HELGO" },
  { symbol:"IM",      address:"0xBBcF895BFCb57d0f457D050bb806d1499436c0CE", decimals:18, name:"IM" },
  { symbol:"LINK",    address:"0x514910771AF9Ca656af840dff83E8264EcF986CA", decimals:18, name:"LINK" },
  { symbol:"pBSKR",   address:"0x1DcbF345bC44696BbBed402367f7C62e524Fe8B5", decimals:18, name:"pBSKR" },
  { symbol:"PEPE",    address:"0x6982508145454Ce325dDbE47a25d4ec3d2311933", decimals:18, name:"PEPE" },

  // bloc 2
  { symbol:"LOAN",   address:"0x9159f1D2a9f51998Fc9Ab03fbd8f265ab14A1b3B", decimals:18, name:"LOAN" },
  { symbol:"PHUX",   address:"0x9663c2d75ffd5F4017310405fCe61720aF45B829", decimals:18, name:"PHUX" },
  { symbol:"PRS",    address:"0xb6B57227150a7097723e0C013752001AaD01248F", decimals:18, name:"PRS" },
  { symbol:"pTGC",   address:"0x94534EeEe131840b1c0F61847c572228bdfDDE93", decimals:18, name:"pTGC" },
  { symbol:"PTS",    address:"0x2A06a971fE6ffa002fd242d437E3db2b5cC5B433", decimals:18, name:"PTS" },
  { symbol:"PXDC",   address:"0xeB6b7932Da20c6D7B3a899D5887d86dfB09A6408", decimals:18, name:"PXDC" },
  { symbol:"RFX",    address:"0xF876BDf9D6403AA7D5bF7F523E8f440A841CC596", decimals:18, name:"RFX" },
  { symbol:"SHIB",   address:"0x95aD61b0a150d79219dCF64E1E6Cc01f0B64C4cE", decimals:18, name:"SHIB" },
  { symbol:"SOUNDX", address:"0xA301c1871Dbf414261946281C7F62213fae22CfE", decimals:18, name:"SOUNDX" },
  { symbol:"TETRAp", address:"0xAeC4C07537B03E3E62fc066EC62401Aed5Fdd361", decimals:18, name:"TETRAp" },
  { symbol:"TEXAN",  address:"0xcFCFfE432A48dB53F59c301422d2EdD77B2A88d7", decimals:18, name:"TEXAN" },
  { symbol:"TIME",   address:"0xCA35638A3fdDD02fEC597D8c1681198C06b23F58", decimals:18, name:"TIME" },
  { symbol:"UFO",    address:"0x456548A9B56eFBbD89Ca0309edd17a9E20b04018", decimals:18, name:"UFO" },
  { symbol:"UNI",    address:"0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984", decimals:18, name:"UNI" },
  { symbol:"USDL",   address:"0x0dEEd1486bc52aA0d3E6f8849cEC5adD6598A162", decimals:18, name:"USDL" },
  { symbol:"USDT",   address:"0xdAC17F958D2ee523a2206206994597C13D831ec7", decimals:6,  name:"USDT" },
  { symbol:"VORTEX", address:"0x73d8a4D01d658E565cF83068397FD39Baf386C48", decimals:18, name:"VORTEX" },
  { symbol:"WATT",   address:"0xDfdc2836FD2E63Bba9f0eE07901aD465Bff4DE71", decimals:18, name:"WATT" },
  { symbol:"WBTC",   address:"0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599", decimals:8,  name:"WBTC" },
];

/* ================= ABIs ================= */
const ERC20_ABI = [
  "function approve(address spender,uint256 amount) external returns (bool)",
  "function allowance(address owner,address spender) external view returns (uint256)",
  "function balanceOf(address owner) external view returns (uint256)",
  "function decimals() external view returns (uint8)",
  "function symbol() external view returns (string)",
  "function name() external view returns (string)",
];
const ROUTER_ABI = [
  "function getAmountsOut(uint256 amountIn, address[] calldata path) external view returns (uint256[] memory amounts)",
  "function swapExactTokensForTokens(uint256 amountIn,uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) external returns (uint256[] memory amounts)",
  "function swapExactETHForTokens(uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) external payable returns (uint256[] memory amounts)",
  "function swapExactTokensForETH(uint256 amountIn,uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) external returns (uint256[] memory amounts)"
];

/* ================= HELPERS ================= */
const $ = (id) => document.getElementById(id);
function shortAddr(a){ return a ? (a.slice(0,6)+"‚Ä¶"+a.slice(-4)) : ""; }
function norm(x){ return (x||"").toLowerCase(); }
function isAddr(x){ return /^0x[a-fA-F0-9]{40}$/.test(x); }
function txUrl(hash){ return `https://otter.pulsechain.com/tx/${hash}`; }

function setStatus(card, txt, cls=""){
  const el = card.querySelector(".status");
  el.className = "status" + (cls ? " "+cls : "");
  el.textContent = txt;
}
function getSettings(){
  const sl = parseFloat($("slippage").value || "2");
  const dl = parseInt($("deadlineM").value || "10", 10);
  return { slippage: Math.max(0, sl), deadlineMin: Math.max(1, dl) };
}
function formatUnits(dec, raw){
  const s = ethers.formatUnits(raw, dec);
  const num = Number(s);
  if(!isFinite(num)) return s;
  if(num === 0) return "0";
  if(num < 0.0001) return num.toExponential(3);
  return num.toLocaleString(undefined, { maximumFractionDigits: 6 });
}

/* ================= STATE ================= */
let provider, signer, userAddress, networkOk = false;
let TOKEN_LIST = [];              // array tokens for UI
let TOKEN_BY_ADDR = new Map();    // addrLower -> token
let BAL_CACHE = new Map();        // addrLower or "PLS" -> {raw, ts}

/* ================= WEB3 HELPERS ================= */
function getRouter(readOnly=true){
  return new ethers.Contract(PULSEX_ROUTER, ROUTER_ABI, readOnly ? provider : signer);
}
function getErc20(tokenAddr, readOnly=true){
  return new ethers.Contract(ethers.getAddress(tokenAddr), ERC20_ABI, readOnly ? provider : signer);
}

/* ================= TOKENLIST LOAD ================= */
async function loadTokenList(){
  try{
    $("tokenListStatus").textContent = "Tokenlist : chargement‚Ä¶";
    const r = await fetch(TOKENLIST_URL, { cache:"no-store" });
    const j = await r.json();
    const tokens = (j.tokens || []).filter(t => Number(t.chainId) === PULSECHAIN_ID);

    // Map by address
    const byAddr = new Map();
    for(const t of tokens){
      if(!t.address) continue;
      byAddr.set(norm(t.address), {
        symbol: t.symbol || "???",
        name: t.name || t.symbol || "Token",
        address: ethers.getAddress(t.address),
        decimals: Number(t.decimals ?? 18),
        logoURI: t.logoURI || "",
        chainId: Number(t.chainId)
      });
    }

    // merge custom tokens (keep tokenlist logo/decimals if found)
    const merged = [];
    const pushToken = (tk) => {
      if(tk.address){
        const key = norm(tk.address);
        const fromList = byAddr.get(key);
        if(fromList){
          merged.push(fromList);
          return;
        }
        merged.push({
          symbol: tk.symbol,
          name: tk.name || tk.symbol,
          address: ethers.getAddress(tk.address),
          decimals: Number(tk.decimals ?? 18),
          logoURI: "",
          chainId: PULSECHAIN_ID
        });
      }else{
        // Native PLS
        merged.push({
          symbol:"PLS",
          name:"PulseChain (Native)",
          address:null,
          decimals:18,
          logoURI:"",
          chainId:PULSECHAIN_ID
        });
      }
    };

    // start with "custom important first"
    for(const tk of CUSTOM_TOKENS) pushToken(tk);

    // then add the rest tokenlist (avoid duplicates)
    const seen = new Set(merged.filter(x=>x.address).map(x=>norm(x.address)));
    for(const t of tokens){
      const key = norm(t.address);
      if(seen.has(key)) continue;
      merged.push({
        symbol: t.symbol || "???",
        name: t.name || t.symbol || "Token",
        address: ethers.getAddress(t.address),
        decimals: Number(t.decimals ?? 18),
        logoURI: t.logoURI || "",
        chainId: Number(t.chainId)
      });
    }

    // build globals
    TOKEN_LIST = merged;
    TOKEN_BY_ADDR = new Map();
    for(const t of TOKEN_LIST){
      if(t.address) TOKEN_BY_ADDR.set(norm(t.address), t);
    }

    $("tokenListStatus").textContent = `Tokenlist : OK ‚úÖ (${TOKEN_LIST.length} tokens)`;
  }catch(e){
    console.error(e);
    $("tokenListStatus").textContent = "Tokenlist : erreur ‚ùå";
  }
}

/* ================= BALANCES ================= */
async function getBalanceToken(token){
  if(!networkOk || !userAddress) return null;

  const now = Date.now();
  const key = token.address ? norm(token.address) : "PLS";
  const cached = BAL_CACHE.get(key);
  if(cached && (now - cached.ts) < 12000) return cached.raw;

  let raw;
  if(!token.address){
    raw = await provider.getBalance(userAddress);
  }else{
    raw = await getErc20(token.address, true).balanceOf(userAddress);
  }

  BAL_CACHE.set(key, { raw, ts: now });
  return raw;
}

async function refreshCardBalances(card){
  if(!networkOk || !userAddress){
    card.querySelector(".balIn").textContent = "Connect wallet";
    card.querySelector(".balOut").textContent = "Connect wallet";
    return;
  }
  const fromAddr = card.querySelector(".from").value;
  const toAddr   = card.querySelector(".to").value;

  const tFrom = fromAddr === "PLS" ? TOKEN_LIST.find(t=>t.symbol==="PLS" && !t.address) : TOKEN_BY_ADDR.get(norm(fromAddr));
  const tTo   = toAddr === "PLS"   ? TOKEN_LIST.find(t=>t.symbol==="PLS" && !t.address) : TOKEN_BY_ADDR.get(norm(toAddr));

  if(tFrom){
    const b = await getBalanceToken(tFrom);
    card.querySelector(".balIn").textContent = b==null ? "‚Äî" : `${formatUnits(tFrom.decimals, b)} ${tFrom.symbol}`;
  }else{
    card.querySelector(".balIn").textContent = "‚Äî";
  }

  if(tTo){
    const b2 = await getBalanceToken(tTo);
    card.querySelector(".balOut").textContent = b2==null ? "‚Äî" : `${formatUnits(tTo.decimals, b2)} ${tTo.symbol}`;
  }else{
    card.querySelector(".balOut").textContent = "‚Äî";
  }
}

async function refreshAll(){
  if(!networkOk) return;
  const cards = document.querySelectorAll(".swapbox");
  for(const card of cards){
    await refreshCardBalances(card);
    await updateQuote(card);
  }
  // modal (si ouverte)
  if($("tokenModal").style.display === "block"){
    await renderTokenList(($("tmSearch").value||"").trim());
  }
}

/* ================= ROUTING ================= */
function buildPath(tokenIn, tokenOut){
  // tokenIn/out: token objects (PLS => address null)
  if(!tokenIn || !tokenOut) return null;
  if(tokenIn.symbol === tokenOut.symbol && tokenIn.address === tokenOut.address) return null;

  // Native PLS via WPLS
  if(!tokenIn.address && tokenOut.address){
    return [WPLS_ADDR, ethers.getAddress(tokenOut.address)];
  }
  if(tokenIn.address && !tokenOut.address){
    return [ethers.getAddress(tokenIn.address), WPLS_ADDR];
  }
  if(tokenIn.address && tokenOut.address){
    return [ethers.getAddress(tokenIn.address), ethers.getAddress(tokenOut.address)];
  }
  return null;
}

// fallback route via WPLS for token-token
function buildPathViaWPLS(tokenIn, tokenOut){
  if(!tokenIn.address || !tokenOut.address) return null;
  const a = ethers.getAddress(tokenIn.address);
  const b = ethers.getAddress(tokenOut.address);
  const w = ethers.getAddress(WPLS_ADDR);
  if(a === w || b === w) return null;
  return [a, w, b];
}

/* ================= ALLOWANCE / APPROVE ================= */
async function checkAllowance(tokenIn, amountRaw){
  if(!tokenIn.address) return true;
  const allowance = await getErc20(tokenIn.address, true).allowance(userAddress, PULSEX_ROUTER);
  return allowance >= amountRaw;
}
async function doApprove(tokenIn, card){
  const erc = getErc20(tokenIn.address, false);
  setStatus(card, "Approving‚Ä¶ (MetaMask)", "warn");
  const tx = await erc.approve(PULSEX_ROUTER, ethers.MaxUint256);
  setStatus(card, "Approve pending‚Ä¶", "warn");
  await tx.wait();
  setStatus(card, "Approve OK ‚úÖ", "good");
}

/* ================= UI BUILD ================= */
const swapsEl = $("swaps");

function swapCardTemplate(i, label){
  return `
    <div class="card swapbox" id="swap${i}">
      <div class="swap-title">
        <b>${label}</b>
        <span>TX #${i}</span>
      </div>

      <label>Tu payes</label>
      <div class="row2">
        <select class="from"></select>
        <input class="amount" inputmode="decimal" placeholder="Montant" />
      </div>

      <div class="balRow">
        <div class="balText">Solde: <b class="balIn">Connect wallet</b></div>
        <button class="maxBtn" type="button" disabled>MAX</button>
      </div>

      <div class="pctRow">
        <button class="pctBtn" type="button" data-p="25" disabled>25%</button>
        <button class="pctBtn" type="button" data-p="50" disabled>50%</button>
        <button class="pctBtn" type="button" data-p="75" disabled>75%</button>
      </div>

      <div class="switch"><button class="invert" title="Inverser">‚Üï</button></div>

      <label>Tu re√ßois</label>
      <div class="row2">
        <select class="to"></select>
        <input class="out" placeholder="Estimation" readonly />
      </div>

      <div class="balRow">
        <div class="balText">Solde: <b class="balOut">Connect wallet</b></div>
        <span></span>
      </div>

      <div class="quoteLine">
        <span>Quote:</span>
        <span class="quoteText">‚Äî</span>
      </div>

      <div class="actions">
        <button class="btn2 approveBtn" style="display:none" disabled>Approve</button>
        <button class="btn swapBtn" disabled>Ex√©cuter ${label}</button>
      </div>

      <div class="status">Ready (connect wallet)</div>
      <div class="quoteLine" style="margin-top:10px">
        <a class="txlink txA" target="_blank" rel="noreferrer" style="display:none">Voir TX</a>
      </div>
    </div>
  `;
}

swapsEl.insertAdjacentHTML("beforeend", swapCardTemplate(1,"Swap A"));
swapsEl.insertAdjacentHTML("beforeend", swapCardTemplate(2,"Swap B"));
swapsEl.insertAdjacentHTML("beforeend", swapCardTemplate(3,"Swap C"));

function setConnectedUI(isOk){
  document.querySelectorAll(".swapBtn").forEach(b => b.disabled = !isOk);
  document.querySelectorAll(".approveBtn").forEach(b => b.disabled = !isOk);
  document.querySelectorAll(".maxBtn").forEach(b => b.disabled = !isOk);
  document.querySelectorAll(".pctBtn").forEach(b => b.disabled = !isOk);
  $("execTrinityBtn").disabled = !isOk;

  document.querySelectorAll(".swapbox").forEach(card => {
    card.querySelector(".balIn").textContent = isOk ? "‚Äî" : "Connect wallet";
    card.querySelector(".balOut").textContent = isOk ? "‚Äî" : "Connect wallet";
    if(!isOk) setStatus(card, "Ready (connect wallet)", "");
  });
}

function fillSelectByTokens(sel, selectedValue){
  // value = "PLS" for native, else address
  sel.innerHTML = "";
  // native first
  const optPLS = document.createElement("option");
  optPLS.value = "PLS";
  optPLS.textContent = "PLS";
  sel.appendChild(optPLS);

  for(const t of TOKEN_LIST){
    if(!t.address) continue;
    const opt = document.createElement("option");
    opt.value = t.address;
    opt.textContent = t.symbol;
    sel.appendChild(opt);
  }

  sel.value = selectedValue;
}

function getTokenFromSelectValue(v){
  if(v === "PLS") return TOKEN_LIST.find(t=>t.symbol==="PLS" && !t.address) || {symbol:"PLS",address:null,decimals:18,name:"PulseChain"};
  return TOKEN_BY_ADDR.get(norm(v));
}

function initCardsDefaults(){
  const defaults = [
    {from:"PLS",   to:"0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39"}, // PHEX
    {from:"PLS",   to:"0xCc78A0acDF847A2C1714D2A925bB4477df5d48a6"}, // ATROPA
    {from:"0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39", to:"0x95B303987A60C71504D99Aa1b13B4DA07b0790ab"}, // PHEX->PLSX
  ];

  document.querySelectorAll(".swapbox").forEach((card, idx)=>{
    const fromSel = card.querySelector(".from");
    const toSel   = card.querySelector(".to");

    fillSelectByTokens(fromSel, defaults[idx].from);
    fillSelectByTokens(toSel, defaults[idx].to);

    card.querySelector(".invert").addEventListener("click", async ()=>{
      const a = fromSel.value;
      fromSel.value = toSel.value;
      toSel.value = a;
      await refreshCardBalances(card).catch(()=>{});
      triggerQuote(card);
    });

    fromSel.addEventListener("change", async ()=>{
      await refreshCardBalances(card).catch(()=>{});
      triggerQuote(card);
    });
    toSel.addEventListener("change", async ()=>{
      await refreshCardBalances(card).catch(()=>{});
      triggerQuote(card);
    });
    card.querySelector(".amount").addEventListener("input", ()=> triggerQuote(card));
  });
}

/* ================= SCROLL BTN ================= */
$("openMultiBtn").addEventListener("click", ()=>{
  $("multiswap").scrollIntoView({behavior:"smooth", block:"start"});
  window.scrollBy(0, -90);
});

/* ================= CONNECT ================= */
async function connectWallet(){
  if(!window.ethereum){
    alert("Wallet requis : MetaMask");
    return;
  }

  await window.ethereum.request({ method:"eth_requestAccounts" });
  provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();
  userAddress = await signer.getAddress();

  const net = await provider.getNetwork();
  let ok = (Number(net.chainId) === PULSECHAIN_ID);

  if(!ok){
    try{
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: PULSECHAIN_HEX }]
      });
      const net2 = await provider.getNetwork();
      ok = (Number(net2.chainId) === PULSECHAIN_ID);
    }catch(e){
      console.error(e);
    }
  }

  networkOk = ok;
  $("walletPill").textContent = "Wallet : " + shortAddr(userAddress);
  $("netPill").textContent = "R√©seau : " + (ok ? "PulseChain ‚úÖ" : "Mauvais r√©seau ‚ùå");

  // bouton devient adresse + copie
  const btn = $("connectBtn");
  btn.textContent = shortAddr(userAddress);
  btn.onclick = async () => {
    await navigator.clipboard.writeText(userAddress);
    alert("Adresse copi√©e ‚úÖ");
  };

  setConnectedUI(ok);

  if(!ok){
    alert("Passe sur PulseChain (chainId 369) puis reconnecte.");
    return;
  }

  BAL_CACHE.clear();
  await refreshAll();

  window.ethereum.on?.("accountsChanged", ()=> location.reload());
  window.ethereum.on?.("chainChanged", ()=> location.reload());
}
$("connectBtn").addEventListener("click", connectWallet);
$("refreshBtn").addEventListener("click", ()=> { BAL_CACHE.clear(); refreshAll(); });

/* ================= MAX + % ================= */
async function setAmountFromPercent(card, pct){
  if(!networkOk) return alert("Connecte ton wallet d‚Äôabord");

  const fromVal = card.querySelector(".from").value;
  const tFrom = getTokenFromSelectValue(fromVal);
  if(!tFrom) return;

  let bal = await getBalanceToken(tFrom);
  if(bal == null) return;

  // r√©serve gas si PLS
  if(!tFrom.address){
    if(bal <= PLS_GAS_RESERVE){
      alert("Balance PLS insuffisante pour le gas");
      return;
    }
    bal = bal - PLS_GAS_RESERVE;
  }

  const amount = bal * BigInt(pct) / 100n;
  card.querySelector(".amount").value = ethers.formatUnits(amount, tFrom.decimals);
  await updateQuote(card);
}

document.querySelectorAll(".swapbox").forEach(card=>{
  card.querySelector(".maxBtn").addEventListener("click", ()=> setAmountFromPercent(card, 100).catch(console.error));
  card.querySelectorAll(".pctBtn").forEach(b=>{
    b.addEventListener("click", ()=> setAmountFromPercent(card, parseInt(b.dataset.p,10)).catch(console.error));
  });
});

/* ================= QUOTES ================= */
let quoteTimer = null;
function triggerQuote(card){
  if(quoteTimer) clearTimeout(quoteTimer);
  quoteTimer = setTimeout(()=> updateQuote(card).catch(()=>{}), 250);
}

async function updateQuote(card){
  const fromVal = card.querySelector(".from").value;
  const toVal   = card.querySelector(".to").value;
  const amtStr  = (card.querySelector(".amount").value || "").trim();

  const outInp = card.querySelector(".out");
  const quoteText = card.querySelector(".quoteText");
  const approveBtn = card.querySelector(".approveBtn");

  outInp.value = "";
  quoteText.textContent = "‚Äî";
  approveBtn.style.display = "none";

  if(!networkOk || !userAddress){
    setStatus(card, "Ready (connect wallet)", "");
    return;
  }

  const tFrom = getTokenFromSelectValue(fromVal);
  const tTo   = getTokenFromSelectValue(toVal);

  if(!tFrom || !tTo){
    setStatus(card, "Token invalide", "bad");
    return;
  }

  if(!amtStr || Number(amtStr) <= 0){
    setStatus(card, "Ready ‚úÖ", "good");
    return;
  }

  if((tFrom.address || "PLS") === (tTo.address || "PLS")){
    setStatus(card, "Paire invalide (tokens identiques)", "bad");
    return;
  }

  try{
    setStatus(card, "Quoting‚Ä¶", "warn");
    const amountIn = ethers.parseUnits(amtStr, tFrom.decimals);
    const router = getRouter(true);

    let path = buildPath(tFrom, tTo);
    if(!path) throw new Error("Invalid path");

    let amounts;
    try{
      amounts = await router.getAmountsOut(amountIn, path);
    }catch(_){
      // fallback via WPLS for token-token
      const alt = buildPathViaWPLS(tFrom, tTo);
      if(!alt) throw _;
      path = alt;
      amounts = await router.getAmountsOut(amountIn, path);
    }

    const outRaw = amounts[amounts.length - 1];

    outInp.value = formatUnits(tTo.decimals, outRaw);
    quoteText.textContent = `${amtStr} ${tFrom.symbol} ‚Üí ~${formatUnits(tTo.decimals, outRaw)} ${tTo.symbol}`;

    if(tFrom.address){
      const ok = await checkAllowance(tFrom, amountIn);
      if(!ok){
        approveBtn.style.display = "inline-flex";
        approveBtn.disabled = false;
        approveBtn.textContent = "Approve " + tFrom.symbol;
        approveBtn.onclick = async ()=>{
          try{
            await doApprove(tFrom, card);
            await updateQuote(card);
          }catch(e){
            console.error(e);
            setStatus(card, "Approve error", "bad");
          }
        };
        setStatus(card, "Allowance insuffisante ‚Üí Approve requis", "warn");
        return;
      }
    }

    setStatus(card, "Ready ‚úÖ", "good");
  }catch(e){
    console.error(e);
    setStatus(card, "Quote error (liquidit√©/route/token)", "bad");
  }
}

/* ================= SWAP EXECUTION ================= */
async function executeSwap(card){
  if(!networkOk || !userAddress) return alert("Connecte ton wallet sur PulseChain");

  const fromVal = card.querySelector(".from").value;
  const toVal   = card.querySelector(".to").value;
  const amtStr  = (card.querySelector(".amount").value || "").trim();

  const txLink = card.querySelector(".txA");
  txLink.style.display = "none";

  const tFrom = getTokenFromSelectValue(fromVal);
  const tTo   = getTokenFromSelectValue(toVal);

  if(!tFrom || !tTo) return setStatus(card, "Token invalide", "bad");
  if(!amtStr || Number(amtStr) <= 0) return setStatus(card, "Montant manquant", "bad");
  if((tFrom.address || "PLS") === (tTo.address || "PLS")) return setStatus(card, "Paire invalide", "bad");

  const { slippage, deadlineMin } = getSettings();

  try{
    const routerWrite = getRouter(false);
    const routerRead  = getRouter(true);
    const amountIn = ethers.parseUnits(amtStr, tFrom.decimals);

    // approve si besoin
    if(tFrom.address){
      const ok = await checkAllowance(tFrom, amountIn);
      if(!ok) await doApprove(tFrom, card);
    }

    setStatus(card, "Calcul minOut‚Ä¶", "warn");

    let path = buildPath(tFrom, tTo);
    if(!path) throw new Error("Invalid path");

    let amounts;
    try{
      amounts = await routerRead.getAmountsOut(amountIn, path);
    }catch(_){
      const alt = buildPathViaWPLS(tFrom, tTo);
      if(!alt) throw _;
      path = alt;
      amounts = await routerRead.getAmountsOut(amountIn, path);
    }

    const outRaw  = amounts[amounts.length - 1];
    const bps = Math.round(slippage * 100); // 2.0% => 200 bps
    const minOut = outRaw * BigInt(10000 - bps) / 10000n;
    const deadline = Math.floor(Date.now()/1000) + (deadlineMin * 60);

    let tx;
    setStatus(card, "Signature (MetaMask)‚Ä¶", "warn");

    if(!tFrom.address){
      // PLS -> token
      tx = await routerWrite.swapExactETHForTokens(minOut, path, userAddress, deadline, { value: amountIn });
    }else if(!tTo.address){
      // token -> PLS
      tx = await routerWrite.swapExactTokensForETH(amountIn, minOut, path, userAddress, deadline);
    }else{
      // token -> token
      tx = await routerWrite.swapExactTokensForTokens(amountIn, minOut, path, userAddress, deadline);
    }

    setStatus(card, "Pending‚Ä¶", "warn");
    txLink.href = txUrl(tx.hash);
    txLink.textContent = "Voir TX";
    txLink.style.display = "inline-flex";

    await tx.wait();

    setStatus(card, "Success ‚úÖ", "good");
    BAL_CACHE.clear();
    await refreshAll();

  }catch(e){
    console.error(e);
    setStatus(card, "Swap error (cancel/liquidit√©/route)", "bad");
  }
}

document.querySelectorAll(".swapbox").forEach(card=>{
  card.querySelector(".swapBtn").addEventListener("click", ()=> executeSwap(card));
});

/* ================= EXECUTE TRINITY (A‚ÜíB‚ÜíC) ================= */
$("execTrinityBtn").addEventListener("click", async ()=>{
  if(!networkOk) return alert("Connecte ton wallet sur PulseChain");
  const cards = [ $("swap1"), $("swap2"), $("swap3") ];

  $("multiswap").scrollIntoView({behavior:"smooth", block:"start"});
  window.scrollBy(0, -90);

  for(const card of cards){
    const amt = (card.querySelector(".amount").value || "").trim();
    const fromVal = card.querySelector(".from").value;
    const toVal = card.querySelector(".to").value;
    if(!amt || Number(amt) <= 0){
      setStatus(card, "Skip (montant vide)", "");
      continue;
    }
    if(fromVal === toVal){
      setStatus(card, "Skip (tokens identiques)", "bad");
      continue;
    }

    await executeSwap(card);

    const st = (card.querySelector(".status").textContent || "").toLowerCase();
    if(st.includes("error") || st.includes("cancel")){
      alert("TRINITY stopp√© (erreur sur un swap).");
      break;
    }
  }
});

/* ================= Token modal ================= */
let tokenModalTarget = null;

function openTokenModal(card, side){
  tokenModalTarget = { card, side };
  $("tokenModal").style.display = "block";
  $("tmSearch").value = "";
  renderTokenList("").catch(()=>{});
  setTimeout(()=>$("tmSearch").focus(), 30);
}
function closeTokenModal(){
  $("tokenModal").style.display = "none";
  tokenModalTarget = null;
}
$("tmClose").onclick = closeTokenModal;
$("tmBackdrop").onclick = closeTokenModal;
$("tmSearch").addEventListener("input", (e)=> renderTokenList((e.target.value||"").trim()));
$("tmRefresh").addEventListener("click", ()=>{ BAL_CACHE.clear(); renderTokenList(($("tmSearch").value||"").trim()); });

async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); }
  catch{
    const ta=document.createElement("textarea");
    ta.value=txt; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
  }
}

async function addTokenToMetaMask(token){
  if(!window.ethereum) return alert("MetaMask requis");
  if(!token.address) return alert("PLS = token natif (pas ERC20)");

  try{
    const wasAdded = await window.ethereum.request({
      method: "wallet_watchAsset",
      params: {
        type: "ERC20",
        options: {
          address: token.address,
          symbol: token.symbol,
          decimals: token.decimals,
          image: token.logoURI || undefined
        }
      }
    });

    if(wasAdded) alert("Token ajout√© ‚úÖ");
    else alert("Ajout refus√© (cancel)");
  }catch(e){
    console.error(e);
    try{ await copyText(token.address); }catch(_){}
    alert("Impossible d‚Äôajouter automatiquement.\n‚úÖ Adresse copi√©e.\n‚û°Ô∏è Ajoute-la via Import token dans MetaMask.");
    window.open("https://otter.pulsechain.com/address/" + token.address, "_blank");
  }
}

function logoHtml(token){
  // si on a logoURI => <img>, sinon fallback lettre
  if(token.logoURI){
    const safe = token.logoURI.replaceAll('"','');
    return `<div class="tmLogo"><img src="${safe}" alt="${token.symbol}" onerror="this.style.display='none'; this.parentElement.textContent='${token.symbol[0] || "?"}'; this.parentElement.style.fontWeight='900';"></div>`;
  }
  return `<div class="tmLogo" style="font-weight:900">${(token.symbol||"?")[0]}</div>`;
}

async function renderTokenList(q){
  const list = $("tmList");
  const nq = norm(q);

  // filtre
  let filtered = TOKEN_LIST.filter(t=>{
    if(!q) return true;
    if(isAddr(q)) return t.address && norm(t.address) === nq;
    return norm(t.symbol).includes(nq) || norm(t.name).includes(nq);
  });

  // option: si l'user colle une address inconnue, on la propose
  if(isAddr(q) && !filtered.length){
    filtered = [{
      symbol:"CUSTOM",
      name:"Token (custom)",
      address: ethers.getAddress(q),
      decimals:18,
      logoURI:"",
      chainId:PULSECHAIN_ID
    }];
  }

  // balances (si connect√©)
  const balMap = new Map();
  if(networkOk && userAddress){
    for(const t of filtered.slice(0, 60)){ // limite pour √©viter spam r√©seau
      try{
        const b = await getBalanceToken(t);
        balMap.set(t.address ? norm(t.address) : "PLS", b);
      }catch(_){}
    }
  }

  list.innerHTML = filtered.map(t=>{
    const addrShort = t.address ? shortAddr(t.address) : "Native";
    const key = t.address ? norm(t.address) : "PLS";
    const b = balMap.get(key);
    const balTxt = (b==null || !networkOk) ? "‚Äî" : formatUnits(t.decimals, b);

    return `
      <div class="tmRow" data-addr="${t.address || "PLS"}">
        ${logoHtml(t)}
        <div class="tmName">
          <b>${t.symbol}</b>
          <small>${addrShort}</small>
        </div>
        <div class="tmBal">
          <small>Balance</small>
          <b>${balTxt}</b>
        </div>
        <div class="tmActions">
          ${t.address ? `
            <button class="tmIconBtn tmCopy" title="Copy address">üìã</button>
            <button class="tmIconBtn tmAdd" title="Add to MetaMask">ü¶ä</button>
          ` : `<small style="color:var(--muted)">‚Äî</small>`}
        </div>
      </div>
    `;
  }).join("");

  // select
  list.querySelectorAll(".tmRow").forEach(row=>{
    row.addEventListener("click", async (e)=>{
      const addr = row.dataset.addr;
      if(e.target.classList.contains("tmCopy") || e.target.classList.contains("tmAdd")) return;
      if(!tokenModalTarget) return;

      const { card, side } = tokenModalTarget;
      const sel = card.querySelector(side === "from" ? ".from" : ".to");

      if(addr === "PLS"){
        sel.value = "PLS";
      }else{
        sel.value = ethers.getAddress(addr);
      }

      closeTokenModal();
      await refreshCardBalances(card).catch(()=>{});
      await updateQuote(card).catch(()=>{});
    });
  });

  // copy
  list.querySelectorAll(".tmCopy").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      const addr = btn.closest(".tmRow").dataset.addr;
      await copyText(addr);
      btn.textContent="‚úÖ";
      setTimeout(()=>btn.textContent="üìã", 700);
    });
  });

  // add MM
  list.querySelectorAll(".tmAdd").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      const addr = btn.closest(".tmRow").dataset.addr;
      const token = (addr === "PLS")
        ? TOKEN_LIST.find(t=>t.symbol==="PLS" && !t.address)
        : TOKEN_BY_ADDR.get(norm(addr)) || {symbol:"CUSTOM", address:ethers.getAddress(addr), decimals:18, name:"Token", logoURI:""};
      await addTokenToMetaMask(token);
    });
  });
}

// hook selects => modal
function hookSelectsToModal(){
  document.querySelectorAll(".swapbox").forEach(card=>{
    const fromSel = card.querySelector(".from");
    const toSel   = card.querySelector(".to");
    fromSel.addEventListener("mousedown", (e)=>{ e.preventDefault(); openTokenModal(card,"from"); });
    toSel.addEventListener("mousedown", (e)=>{ e.preventDefault(); openTokenModal(card,"to"); });
  });
}

/* ================= token list button ================= */
$("openTokenListBtn").addEventListener("click", ()=>{
  // ouvre modal "libre" (sans cibler un swap)
  // on cible swap1/from par d√©faut
  openTokenModal($("swap1"), "from");
});

/* ================= INIT ================= */
(async function init(){
  setConnectedUI(false);
  await loadTokenList();
  initCardsDefaults();
  hookSelectsToModal();

  // Quand tokenlist est pr√™te, refresh select content
  // (on remplit d√©j√†, mais ici on force au cas o√π)
  document.querySelectorAll(".swapbox").forEach((card, idx)=>{
    const fromSel = card.querySelector(".from");
    const toSel   = card.querySelector(".to");
    const curFrom = fromSel.value || "PLS";
    const curTo = toSel.value || "PLS";
    fillSelectByTokens(fromSel, curFrom);
    fillSelectByTokens(toSel, curTo);
  });
})();
</script>
</body>
</html>
