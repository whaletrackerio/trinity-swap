<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TRINITY Swap — PulseChain</title>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

<style>
:root{
  --bg:#020617;
  --card:#0f172a;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --accent:#a855f7;
  --success:#22c55e;
  --error:#ef4444;
  --radius:16px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:system-ui,Segoe UI,Roboto,sans-serif;
  background:var(--bg);
  color:var(--text);
}
.page{
  max-width:1100px;
  margin:auto;
  padding:24px 16px 60px;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
.brand{font-size:20px;font-weight:700}
button{
  cursor:pointer;
  border:none;
}
.btn{
  padding:10px 16px;
  border-radius:999px;
  background:linear-gradient(120deg,#a855f7,#ec4899);
  color:white;
  font-weight:600;
}
.hero h1{font-size:28px;margin-bottom:6px}
.hero p{color:var(--muted);font-size:14px}

.swaps{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
  margin-top:24px;
}
@media(max-width:900px){.swaps{grid-template-columns:1fr}}

.swap{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
}
.swap h3{margin-bottom:10px;font-size:14px}
label{font-size:12px;color:var(--muted)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
select,input{
  width:100%;
  padding:10px;
  border-radius:12px;
  background:#020617;
  border:1px solid var(--border);
  color:var(--text);
}
.switch{text-align:center;margin:6px 0}
.switch button{
  background:#020617;
  border:1px solid var(--border);
  border-radius:10px;
  padding:6px 10px;
  color:var(--text);
}
.status{font-size:12px;margin-top:8px;color:var(--muted)}
.success{color:var(--success)}
.error{color:var(--error)}

footer{
  margin-top:40px;
  font-size:11px;
  color:var(--muted);
  text-align:center;
  border-top:1px solid var(--border);
  padding-top:12px;
}
</style>
</head>

<body>
<div class="page">

<header>
  <div class="brand">TRINITY Swap</div>
  <button class="btn" onclick="connectWallet()">Connect Wallet</button>
</header>

<section class="hero">
  <h1>Swap 3 tokens. One interface.</h1>
  <p>PulseX router • Non-custodial • Mode 1</p>
</section>

<section class="swaps" id="swaps"></section>

<footer>
TRINITY Swap — PulseChain<br>
Uses PulseX router • No fees • Use at your own risk
</footer>

</div>

<script>
/* =========================
   CONSTANTES
========================= */
const PULSECHAIN_ID = 369;
const ROUTER = "0x98bf93ebf5c380C0e6Ae8e192A7e2b4bF4cFfC2e";
const WPLS = "0xA1077a294dDE1B09bB078844df40758a5D0f9a27";

const TOKENS = {
  PLS:{symbol:"PLS",address:null,decimals:18},
  WPLS:{symbol:"WPLS",address:WPLS,decimals:18},
  PHEX:{symbol:"PHEX",address:"0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39",decimals:8},
  ATROPA:{symbol:"ATROPA",address:"0xCc78A0acDF847A2C1714D2A925bB4477df5d48a6",decimals:18},
  PLSX:{symbol:"PLSX",address:"0x95B303987A60C71504D99Aa1b13B4DA07b0790ab",decimals:18},
  DAI:{symbol:"DAI",address:"0x6B175474E89094C44Da98b954EedeAC495271d0F",decimals:18}
};

const ERC20_ABI=[
  "function approve(address,uint) returns(bool)",
  "function allowance(address,address) view returns(uint)"
];
const ROUTER_ABI=[
  "function getAmountsOut(uint,address[]) view returns(uint[])",
  "function swapExactTokensForTokens(uint,uint,address[],address,uint)",
  "function swapExactETHForTokens(uint,address[],address,uint) payable",
  "function swapExactTokensForETH(uint,uint,address[],address,uint)"
];

let provider, signer, user;

/* =========================
   WALLET
========================= */
async function connectWallet(){
  if(!window.ethereum) return alert("Wallet requis");
  await ethereum.request({method:"eth_requestAccounts"});
  provider=new ethers.BrowserProvider(window.ethereum);
  signer=await provider.getSigner();
  user=await signer.getAddress();
  const net=await provider.getNetwork();
  if(Number(net.chainId)!==PULSECHAIN_ID){
    alert("Passe sur PulseChain");
    return;
  }
  alert("Connecté : "+user);
}

/* =========================
   UI
========================= */
const swapsEl=document.getElementById("swaps");

for(let i=1;i<=3;i++){
  swapsEl.innerHTML+=`
  <div class="swap" id="swap${i}">
    <h3>Swap ${i}</h3>
    <label>From</label>
    <div class="row">
      <select class="from"></select>
      <input class="amount" placeholder="Amount">
    </div>
    <div class="switch"><button class="invert">↕</button></div>
    <label>To</label>
    <div class="row">
      <select class="to"></select>
      <input class="out" placeholder="Estimated" readonly>
    </div>
    <button class="btn" onclick="doSwap(${i})">Swap ${i}</button>
    <div class="status">Ready</div>
  </div>`;
}

document.querySelectorAll(".swap").forEach(card=>{
  const f=card.querySelector(".from");
  const t=card.querySelector(".to");
  Object.keys(TOKENS).forEach(k=>{
    f.innerHTML+=`<option>${k}</option>`;
    t.innerHTML+=`<option>${k}</option>`;
  });
  f.value="PLS"; t.value="PHEX";
  card.querySelector(".invert").onclick=()=>[f.value,t.value]=[t.value,f.value];
});

/* =========================
   SWAP LOGIC
========================= */
async function doSwap(i){
  if(!signer) return alert("Connect wallet");
  const card=document.getElementById("swap"+i);
  const status=card.querySelector(".status");
  const from=card.querySelector(".from").value;
  const to=card.querySelector(".to").value;
  const amt=card.querySelector(".amount").value;
  if(!amt) return;

  try{
    status.textContent="Processing...";
    const router=new ethers.Contract(ROUTER,ROUTER_ABI,signer);
    const inTok=TOKENS[from];
    const outTok=TOKENS[to];
    const amountIn=ethers.parseUnits(amt,inTok.decimals);

    if(from!=="PLS"){
      const erc=new ethers.Contract(inTok.address,ERC20_ABI,signer);
      const allowance=await erc.allowance(user,ROUTER);
      if(allowance<amountIn){
        status.textContent="Approving...";
        const txa=await erc.approve(ROUTER,ethers.MaxUint256);
        await txa.wait();
      }
    }

    const path = from==="PLS"
      ? [WPLS,outTok.address]
      : to==="PLS"
        ? [inTok.address,WPLS]
        : [inTok.address,outTok.address];

    const amounts=await router.getAmountsOut(amountIn,path);
    const minOut=amounts[1]*98n/100n;
    const deadline=Math.floor(Date.now()/1000)+600;

    let tx;
    if(from==="PLS"){
      tx=await router.swapExactETHForTokens(minOut,path,user,deadline,{value:amountIn});
    }else if(to==="PLS"){
      tx=await router.swapExactTokensForETH(amountIn,minOut,path,user,deadline);
    }else{
      tx=await router.swapExactTokensForTokens(amountIn,minOut,path,user,deadline);
    }

    await tx.wait();
    status.textContent="Success ✓";
    status.className="status success";
  }catch(e){
    status.textContent="Error";
    status.className="status error";
    console.error(e);
  }
}
</script>
</body>
</html>
