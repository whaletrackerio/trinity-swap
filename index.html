<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TRINITY Swap — PulseChain</title>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

<style>
:root{
  --bg:#020617;
  --card:#0b1020;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --accent:#d946ef;
  --ok:#22c55e;
  --bad:#ef4444;
  --radius:16px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:radial-gradient(1200px 600px at 20% -10%,#2e1065 0%,transparent 60%),var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
}
.page{max-width:1200px;margin:auto;padding:20px}
header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:20px;
}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.logo{
  width:34px;height:34px;border-radius:10px;
  background:linear-gradient(135deg,#ec4899,#a855f7);
}
.btn{
  border:none;cursor:pointer;
  padding:10px 16px;border-radius:999px;
  background:linear-gradient(135deg,#ec4899,#a855f7);
  color:white;font-weight:700;
}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0));
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
@media(max-width:900px){.grid3{grid-template-columns:1fr}}
label{font-size:12px;color:var(--muted)}
select,input{
  width:100%;padding:10px;border-radius:12px;
  background:#020617;border:1px solid var(--border);
  color:var(--text);
}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:6px}
.balRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.bal{font-size:12px;color:var(--muted)}
.maxBtn,.pctBtn{
  background:#020617;border:1px solid var(--border);
  border-radius:999px;padding:5px 10px;
  color:var(--text);cursor:pointer;font-weight:700;
}
.pcts{display:flex;gap:6px;margin-bottom:8px}
.status{font-size:12px;margin-top:6px}
.ok{color:var(--ok)} .bad{color:var(--bad)}
.swapBtn{margin-top:8px}
.topInfo{display:flex;gap:10px;align-items:center}
.pill{
  padding:6px 10px;border-radius:999px;
  border:1px solid var(--border);font-size:12px;
}
</style>
</head>

<body>
<div class="page">

<header>
  <div class="brand"><div class="logo"></div>TRINITY Swap</div>
  <div class="topInfo">
    <div id="net" class="pill">Réseau : —</div>
    <button id="connectBtn" class="btn">Connect Wallet</button>
  </div>
</header>

<div class="card" style="margin-bottom:16px">
  Prépare 3 swaps indépendants. Chaque bouton = 1 transaction.  
  TRINITY est une UI au-dessus du router PulseX (non-custodial).
</div>

<div class="grid3" id="swaps"></div>

</div>

<script>
/* ================= CONFIG ================= */
const CHAIN_ID = 369;
const PULSEX_ROUTER = "0x98bf93ebf5c380C0e6Ae8e192A7e2AE08edAcc02";
const WPLS = "0xA1077a294dDE1B09bB078844df40758a5D0f9a27";
const GAS_RESERVE = ethers.parseUnits("0.05",18);

const TOKENS={
  PLS:{address:null,decimals:18},
  WPLS:{address:WPLS,decimals:18},
  PHEX:{address:"0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39",decimals:8},
  ATROPA:{address:"0xCc78A0acDF847A2C1714D2A925bB4477df5d48a6",decimals:18},
  PLSX:{address:"0x95B303987A60C71504D99Aa1b13B4DA07b0790ab",decimals:18}
};

const ERC20_ABI=[
  "function balanceOf(address) view returns(uint)",
  "function allowance(address,address) view returns(uint)",
  "function approve(address,uint) returns(bool)"
];
const ROUTER_ABI=[
  "function getAmountsOut(uint,address[]) view returns(uint[])",
  "function swapExactETHForTokens(uint,address[],address,uint) payable",
  "function swapExactTokensForETH(uint,uint,address[],address,uint)",
  "function swapExactTokensForTokens(uint,uint,address[],address,uint)"
];

let provider,signer,user;

/* ================= WALLET ================= */
async function connectWallet(){
  if(!window.ethereum) return alert("Wallet requis");
  await ethereum.request({method:"eth_requestAccounts"});
  provider=new ethers.BrowserProvider(window.ethereum);
  signer=await provider.getSigner();
  user=await signer.getAddress();

  const net=await provider.getNetwork();
  document.getElementById("net").textContent =
    Number(net.chainId)===CHAIN_ID ? "Réseau : PulseChain ✅" : "Mauvais réseau ❌";

  const btn=document.getElementById("connectBtn");
  btn.textContent=user.slice(0,6)+"..."+user.slice(-4);
  btn.onclick=()=>navigator.clipboard.writeText(user);

  refreshAll();
}

/* ================= UI ================= */
const swapsEl=document.getElementById("swaps");

function makeSwap(id,from,to){
  const c=document.createElement("div");
  c.className="card";
  c.innerHTML=`
  <h3>Swap ${id}</h3>
  <label>Tu payes</label>
  <div class="row2">
    <select class="from"></select>
    <input class="amt" placeholder="Montant">
  </div>
  <div class="balRow">
    <div class="bal">Balance: Connect wallet</div>
    <button class="maxBtn">MAX</button>
  </div>
  <div class="pcts">
    <button class="pctBtn">25%</button>
    <button class="pctBtn">50%</button>
    <button class="pctBtn">75%</button>
  </div>
  <label>Tu reçois</label>
  <div class="row2">
    <select class="to"></select>
    <input class="out" readonly placeholder="Estimation">
  </div>
  <div class="quote">Quote: —</div>
  <button class="btn swapBtn">Exécuter Swap ${id}</button>
  <div class="status">Ready (connect wallet)</div>
  `;
  swapsEl.appendChild(c);

  const f=c.querySelector(".from");
  const t=c.querySelector(".to");
  Object.keys(TOKENS).forEach(k=>{
    f.innerHTML+=`<option>${k}</option>`;
    t.innerHTML+=`<option>${k}</option>`;
  });
  f.value=from; t.value=to;

  c.querySelector(".maxBtn").onclick=()=>setPercent(c,1);
  c.querySelectorAll(".pctBtn").forEach((b,i)=>{
    b.onclick=()=>setPercent(c,[.25,.5,.75][i]);
  });
  c.querySelector(".amt").oninput=()=>quote(c);
  c.querySelector(".from").onchange=()=>refreshCard(c);
  c.querySelector(".to").onchange=()=>refreshCard(c);
}

makeSwap("A","PLS","PHEX");
makeSwap("B","PLS","ATROPA");
makeSwap("C","PHEX","PLSX");

/* ================= LOGIC ================= */
async function refreshAll(){
  document.querySelectorAll(".card").forEach(refreshCard);
}
async function refreshCard(c){
  if(!user) return;
  const tok=c.querySelector(".from").value;
  let bal;
  if(tok==="PLS") bal=await provider.getBalance(user);
  else{
    const erc=new ethers.Contract(TOKENS[tok].address,ERC20_ABI,provider);
    bal=await erc.balanceOf(user);
  }
  c.querySelector(".bal").textContent=
    "Balance: "+ethers.formatUnits(bal,TOKENS[tok].decimals);
}

function setPercent(c,p){
  if(!user) return alert("Connect wallet");
  const tok=c.querySelector(".from").value;
  const balText=c.querySelector(".bal").textContent.split(": ")[1];
  let bal=ethers.parseUnits(balText.split(" ")[0],TOKENS[tok].decimals);
  if(tok==="PLS") bal-=GAS_RESERVE;
  c.querySelector(".amt").value=
    ethers.formatUnits(bal*p,TOKENS[tok].decimals);
  quote(c);
}

async function quote(c){
  if(!user) return;
  const from=c.querySelector(".from").value;
  const to=c.querySelector(".to").value;
  if(from===to){
    c.querySelector(".status").textContent="Paire invalide";
    return;
  }
  const amt=c.querySelector(".amt").value;
  if(!amt) return;
  const amountIn=ethers.parseUnits(amt,TOKENS[from].decimals);

  const path =
    from==="PLS" ? [WPLS,TOKENS[to].address] :
    to==="PLS"   ? [TOKENS[from].address,WPLS] :
                   [TOKENS[from].address,TOKENS[to].address];

  const router=new ethers.Contract(PULSEX_ROUTER,ROUTER_ABI,provider);
  const out=(await router.getAmountsOut(amountIn,path)).at(-1);
  c.querySelector(".out").value=
    ethers.formatUnits(out,TOKENS[to].decimals);
  c.querySelector(".quote").textContent=
    `Quote: ${amt} ${from} → ~${ethers.formatUnits(out,TOKENS[to].decimals)} ${to}`;
  c.querySelector(".status").textContent="Ready ✅";
  c.querySelector(".status").className="status ok";
}
</script>
</body>
</html>
