<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TRINITY Swap ‚Äî PulseChain</title>

  <!-- Ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

  <style>
    :root{
      --bg:#040817;
      --bg2:#070b1c;
      --card: rgba(255,255,255,.04);
      --card2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.09);
      --border2: rgba(255,255,255,.12);
      --text:#e8e9f2;
      --muted:#a7acc3;
      --muted2:#8a90ab;
      --accent1:#a855f7;
      --accent2:#ec4899;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 20px 70px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1000px 420px at 12% 0%, rgba(168,85,247,.22), transparent 60%),
        radial-gradient(900px 420px at 92% 10%, rgba(236,72,153,.18), transparent 55%),
        radial-gradient(1200px 700px at 50% 120%, rgba(34,197,94,.06), transparent 60%),
        linear-gradient(180deg, var(--bg), #02040e);
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:22px 16px 56px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;margin-bottom:14px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:800;letter-spacing:.2px;
    }
    .logoDot{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      box-shadow: 0 16px 40px rgba(236,72,153,.25);
    }
    .rightTop{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
    }
    .pill .dot{
      width:8px;height:8px;border-radius:99px;background:rgba(255,255,255,.25)
    }
    .btn{
      border:none;cursor:pointer;
      padding:10px 14px;border-radius:999px;
      font-weight:700;color:#fff;
      background: linear-gradient(120deg, var(--accent1), var(--accent2));
      box-shadow: 0 18px 55px rgba(168,85,247,.22);
      transition: transform .08s ease, filter .08s ease;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.98);filter:brightness(.98)}
    .btn2{
      border:none;cursor:pointer;
      padding:10px 14px;border-radius:999px;
      font-weight:700;color:#fff;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border2);
      transition: transform .08s ease, filter .08s ease;
      white-space:nowrap;
    }
    .btn2:active{transform:scale(.98);filter:brightness(.98)}
    .layout{
      display:grid;
      grid-template-columns: 1.35fr .95fr;
      gap:16px;
      margin-top:12px;
    }
    @media(max-width:980px){
      .layout{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardPad{padding:16px}
    .hero h1{
      font-size:38px;line-height:1.05;margin-bottom:10px;
      letter-spacing:-.5px;
    }
    .hero p{color:var(--muted);font-size:13px;max-width:920px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 14px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.09);
      color:#cfd2e7;font-size:12px;
    }
    .chip .ok{width:9px;height:9px;border-radius:99px;background:rgba(34,197,94,.9)}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .warnbar{
      margin-top:14px;
      padding:10px 12px;border-radius:14px;
      background: rgba(245,158,11,.08);
      border:1px solid rgba(245,158,11,.28);
      color:#f5d39b;font-size:12px;
    }

    /* Right settings */
    .settingsHead{
      display:flex;align-items:center;gap:12px;
      padding:16px;border-bottom:1px solid rgba(255,255,255,.06);
    }
    .miniMark{
      width:46px;height:46px;border-radius:16px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      overflow:hidden;
    }
    .miniMark svg{opacity:.9}
    .settingsHead h3{font-size:14px;margin-bottom:2px}
    .settingsHead p{font-size:12px;color:var(--muted)}
    .grid2{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;
      padding:16px;
    }
    .field label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .field input{
      width:100%;padding:10px 12px;border-radius:14px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      outline:none;
    }
    .rowBtn{padding:0 16px 16px}
    .smallLink{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 12px;border-radius:14px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.09);
      color:var(--muted);
      font-size:12px;
      margin: 0 16px 12px;
    }

    /* Swaps */
    .sectionTitle{
      margin-top:16px;margin-bottom:10px;
      font-size:13px;color:#cfd2e7;font-weight:800;letter-spacing:.4px;
    }
    .swapGrid{
      display:grid;grid-template-columns: repeat(3, 1fr);
      gap:14px;
    }
    @media(max-width:980px){.swapGrid{grid-template-columns:1fr}}
    .swapCard{padding:16px}
    .swapTop{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .swapTop b{font-size:14px}
    .swapTop span{font-size:12px;color:var(--muted2)}
    .sub{font-size:12px;color:var(--muted);margin-bottom:8px}
    .line{
      display:grid;grid-template-columns: 1fr 1fr;
      gap:10px;margin-bottom:10px;align-items:center;
    }
    .tokBtn{
      width:100%;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border-radius:14px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      cursor:pointer;
    }
    .tokBtn small{color:var(--muted);font-weight:600}
    .amtWrap{position:relative}
    .amt{
      width:100%;
      padding:10px 12px;border-radius:14px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      outline:none;
    }
    .maxBtn{
      position:absolute;right:8px;top:50%;
      transform:translateY(-50%);
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:800;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;cursor:pointer;
    }
    .balanceRow{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;margin:6px 2px 10px;color:var(--muted);font-size:12px;
    }
    .pctRow{display:flex;gap:8px;margin:0 0 10px}
    .pct{
      padding:6px 10px;border-radius:999px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      color:#d9dbef;font-weight:800;font-size:12px;
      cursor:pointer;
      opacity:.85;
    }
    .pct:hover{opacity:1}
    .swapMid{
      display:flex;justify-content:center;align-items:center;
      margin: 2px 0 10px;
    }
    .flipBtn{
      width:36px;height:36px;border-radius:12px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color:#fff;cursor:pointer;font-weight:900;
    }
    .quoteBox{margin-top:8px;color:var(--muted);font-size:12px}
    .swapAction{display:flex;gap:10px;align-items:center;margin-top:12px}
    .swapGo{
      flex:1;
      padding:12px 14px;border-radius:999px;
      border:none;cursor:pointer;
      font-weight:900;color:#fff;
      background: linear-gradient(120deg, var(--accent2), var(--accent1));
      opacity:.95;
    }
    .swapGo:disabled{opacity:.45;cursor:not-allowed}
    .status{
      margin-top:10px;
      font-size:12px;color:var(--muted);
      display:flex;align-items:center;gap:8px;
    }
    .status .sDot{width:8px;height:8px;border-radius:99px;background:rgba(255,255,255,.25)}
    .status.ok{color:#bff3cf}
    .status.ok .sDot{background:rgba(34,197,94,.95)}
    .status.bad{color:#fecaca}
    .status.bad .sDot{background:rgba(239,68,68,.95)}
    .status.warn{color:#fde68a}
    .status.warn .sDot{background:rgba(245,158,11,.95)}

    /* Bottom area */
    .bottomGrid{
      display:grid;grid-template-columns: 1fr 1fr;gap:14px;margin-top:14px;
    }
    @media(max-width:980px){.bottomGrid{grid-template-columns:1fr}}
    .notes p{color:var(--muted);font-size:12px;line-height:1.45}
    .notes .rule{margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,.06)}
    .paliersWrap{
      margin-top:12px;
      border-radius:16px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .paliersWrap img{
      width:100%;
      display:block;
      max-height: 260px;
      object-fit: cover;
      object-position: center;
      filter: saturate(1.05) contrast(1.02);
    }
    .paliersCap{
      padding:10px 12px;
      font-size:12px;
      color:#cfd2e7;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
    }
    .paliersCap b{font-weight:900}
    .links .item{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;padding:14px 16px;
      border-top:1px solid rgba(255,255,255,.06);
    }
    .links .item:first-child{border-top:none}
    .links h4{font-size:13px}
    .links p{font-size:12px;color:var(--muted);margin-top:2px}
    .links .go{
      padding:10px 14px;border-radius:999px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color:#fff;font-weight:900;cursor:pointer;
      min-width:110px;text-align:center;
    }

    footer{
      margin-top:18px;
      text-align:center;
      color:rgba(255,255,255,.38);
      font-size:11px;
    }

    /* Modal token selector */
    .modalOverlay{
      position:fixed;inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(560px, 96vw);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);
    }
    .modalHead b{font-size:16px}
    .xBtn{
      width:36px;height:36px;border-radius:12px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color:#9ef2c5;
      font-weight:900;cursor:pointer;
    }
    .modalBody{padding:14px 16px 10px}
    .search{
      width:100%;
      padding:11px 12px;border-radius:14px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(34,197,94,.45);
      color:var(--text);
      outline:none;
    }
    .tokList{
      margin-top:12px;
      max-height:360px;
      overflow:auto;
      padding-right:6px;
    }
    .tokRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.22);
      margin-bottom:10px;
      cursor:pointer;
    }
    .tokRow:hover{border-color: rgba(255,255,255,.14)}
    .tokLeft{display:flex;flex-direction:column;gap:2px}
    .tokSym{font-weight:900}
    .tokAddr{font-size:12px;color:var(--muted)}
    .tokRight{display:flex;align-items:center;gap:8px}
    .miniIcon{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
    }
    .miniIcon:hover{filter:brightness(1.06)}
    .balTxt{font-size:12px;color:#d6d9ef;min-width:96px;text-align:right}
    .modalFoot{
      padding:10px 16px 14px;
      color:rgba(255,255,255,.45);
      font-size:11px;
      border-top:1px solid rgba(255,255,255,.06);
    }
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      padding:10px 14px;border-radius:999px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;font-size:12px;
      display:none;
      z-index:10000;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logoDot"></div>
        <div>TRINITY Swap</div>
      </div>

      <div class="rightTop">
        <div class="pill" id="netPill"><span class="dot" id="netDot"></span> R√©seau : <span id="netTxt">‚Äî</span></div>
        <div class="pill" id="walPill"><span class="dot"></span> Wallet : <span id="walTxt">non connect√©</span></div>
        <button class="btn" id="connectBtn">Connect Wallet</button>
      </div>
    </div>

    <div class="layout">
      <!-- Left hero -->
      <div class="card">
        <div class="cardPad hero">
          <h1>Swap 3 tokens en parall√®le.<br/>Une interface, trois actions.</h1>
          <p>
            TRINITY = MultiSwap : tu pr√©pares 3 swaps diff√©rents et tu lances chaque swap avec son propre bouton.
            Mode 1 (PulseX-like) : UI au-dessus du router PulseX ‚Ä¢ non-custodial ‚Ä¢ 0 fee TRINITY.
          </p>

          <div class="chips">
            <div class="chip"><span class="ok"></span> 3 swaps ind√©pendants</div>
            <div class="chip"><span class="ok"></span> Quotes live</div>
            <div class="chip"><span class="ok"></span> Approve auto</div>
            <div class="chip"><span class="ok"></span> MAX + balances</div>
            <div class="chip"><span class="ok"></span> Modal tokens + search</div>
          </div>

          <div class="actions">
            <button class="btn2" id="openModalBtn">üöÄ Ouvrir le MultiSwap</button>
            <button class="btn2" id="runABCBtn">‚ö° Ex√©cuter TRINITY (A‚ÜíB‚ÜíC)</button>
            <a class="btn2" href="../autopilot-pulsechain/" target="_blank" rel="noopener">‚ö° AutoPilot</a>
            <a class="btn2" href="../dca-pulsechain/" target="_blank" rel="noopener">üìà DCA</a>
          </div>

          <div class="warnbar">
            ‚ö†Ô∏è Teste avec de petits montants. TRINITY ne garde pas tes fonds : c‚Äôest ton wallet qui signe.
          </div>
        </div>
      </div>

      <!-- Right settings -->
      <div class="card">
        <div class="settingsHead">
          <div class="miniMark" aria-hidden="true">
            <svg width="34" height="34" viewBox="0 0 84 84" fill="none" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="g3m" x1="14" y1="18" x2="74" y2="72" gradientUnits="userSpaceOnUse">
                  <stop stop-color="#EC4899"/><stop offset="1" stop-color="#7C3AED"/>
                </linearGradient>
              </defs>
              <circle cx="42" cy="42" r="38" fill="rgba(255,255,255,0.03)" stroke="rgba(255,255,255,0.10)"/>
              <g stroke="url(#g3m)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round">
                <path d="M26 34c4-8 12-14 22-14 12 0 22 8 25 19"/>
                <path d="M58 50c-4 8-12 14-22 14-12 0-22-8-25-19"/>
              </g>
            </svg>
          </div>
          <div>
            <h3>TRINITY ‚Ä¢ MultiSwap</h3>
            <p>Interface PulseX-like. 3 swaps s√©par√©s. Non-custodial.</p>
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label>Slippage (%)</label>
            <input id="slippage" type="number" value="2.0" step="0.1" min="0" />
          </div>
          <div class="field">
            <label>Deadline (minutes)</label>
            <input id="deadline" type="number" value="10" step="1" min="1" />
          </div>
        </div>

        <div class="smallLink">
          <span>Explorer :</span>
          <a href="https://otter.pulsechain.com" target="_blank" rel="noopener"><b>otter.pulsechain.com</b></a>
        </div>

        <div class="rowBtn">
          <button class="btn2" id="refreshBtn">‚Üª Refresh balances/quotes</button>
        </div>
      </div>
    </div>

    <div class="sectionTitle">MULTISWAP</div>

    <div class="swapGrid" id="swapGrid"></div>

    <div class="bottomGrid">
      <!-- Notes + IMAGE (remplace l'astuce) -->
      <div class="card notes">
        <div class="cardPad">
          <b>Notes</b>
          <p style="margin-top:8px">
            Mode 1 = pas de fee TRINITY, pas de smart contract maison, chaque swap = 1 transaction.
            Si une quote √©choue, c‚Äôest souvent un manque de liquidit√© sur la paire.
          </p>

          <div class="rule"></div>

          <!-- ‚úÖ ICI : l'image des paliers -->
          <div class="paliersWrap">
            <!-- Mets ton fichier dans le m√™me dossier : paliers.png -->
            <img src="paliers.png" alt="Paliers TRINITY (crevette ‚Üí dauphin ‚Üí requin ‚Üí baleine)" />
            <div class="paliersCap">
              <span><b>Paliers</b> ‚Ä¢ progression</span>
              <span style="color:rgba(255,255,255,.55)">crevette ‚Üí dauphin ‚Üí requin ‚Üí baleine</span>
            </div>
          </div>

        </div>
      </div>

      <!-- Liens rapides -->
      <div class="card links">
        <div class="item">
          <div>
            <h4>PulseX</h4>
            <p>Swap officiel PulseChain.</p>
          </div>
          <a class="go" href="https://pulsex.com" target="_blank" rel="noopener">Ouvrir</a>
        </div>

        <div class="item">
          <div>
            <h4>Otter</h4>
            <p>Explorer / tx / contrats.</p>
          </div>
          <a class="go" href="https://otter.pulsechain.com" target="_blank" rel="noopener">Explorer</a>
        </div>

        <div class="item">
          <div>
            <h4>AutoPilot</h4>
            <p>Tes bots HEX/ATROPA.</p>
          </div>
          <a class="go" href="../autopilot-pulsechain/" target="_blank" rel="noopener">Aller</a>
        </div>

        <div class="item">
          <div>
            <h4>DCA PulseChain</h4>
            <p>8 bots DCA (achat √† l‚Äôunit√©).</p>
          </div>
          <a class="go" href="../dca-pulsechain/" target="_blank" rel="noopener">Aller</a>
        </div>
      </div>
    </div>

    <footer>
      TRINITY Swap ‚Äî PulseChain ‚Ä¢ Mode 1 (PulseX-like) ‚Ä¢ Aucun frais TRINITY<br/>
      Utilise √† tes risques. V√©rifie les adresses et teste petit.
    </footer>
  </div>

  <!-- Modal tokens -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Select a token">
      <div class="modalHead">
        <b>Select a token</b>
        <button class="xBtn" id="closeModal">‚úï</button>
      </div>
      <div class="modalBody">
        <input class="search" id="tokenSearch" placeholder="Search name or paste address (0x...)" />
        <div class="tokList" id="tokList"></div>
      </div>
      <div class="modalFoot">
        Clique sur un token pour le s√©lectionner. üìã copie l‚Äôadresse. ü¶ä ajoute √† MetaMask.
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   CONFIG
========================= */
const PULSECHAIN_ID = 369;

// Router PulseX (celui que tu as dans tes bots / screenshot)
const PULSEX_ROUTER = "0x98bf93ebf5c380C0e6Ae8e192A7e2AE08edAcc02";

// WPLS
const WPLS = "0xA1077a294dDE1B09bB078844df40758a5D0f9a27";

const TOKENS = {
  PLS:  { symbol:"PLS",  address:null, decimals:18, name:"Pulse (native)" },
  WPLS: { symbol:"WPLS", address:WPLS, decimals:18, name:"Wrapped Pulse" },
  PHEX: { symbol:"PHEX", address:"0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39", decimals:8,  name:"PulseChain HEX" },
  ATROPA:{symbol:"ATROPA",address:"0xCc78A0acDF847A2C1714D2A925bB4477df5d48a6", decimals:18, name:"Atropa" },
  PLSX: { symbol:"PLSX", address:"0x95B303987A60C71504D99Aa1b13B4DA07b0790ab", decimals:18, name:"PulseX" },
  DAI:  { symbol:"DAI",  address:"0x6B175474E89094C44Da98b954EedeAC495271d0F", decimals:18, name:"DAI" }
};

const ERC20_ABI = [
  "function name() view returns(string)",
  "function symbol() view returns(string)",
  "function decimals() view returns(uint8)",
  "function balanceOf(address) view returns(uint)",
  "function allowance(address owner,address spender) view returns(uint)",
  "function approve(address spender,uint amount) returns(bool)"
];

const ROUTER_ABI = [
  "function getAmountsOut(uint amountIn,address[] path) external view returns(uint[] memory amounts)",
  "function swapExactTokensForTokens(uint amountIn,uint amountOutMin,address[] path,address to,uint deadline) external returns(uint[] memory amounts)",
  "function swapExactETHForTokens(uint amountOutMin,address[] path,address to,uint deadline) external payable returns(uint[] memory amounts)",
  "function swapExactTokensForETH(uint amountIn,uint amountOutMin,address[] path,address to,uint deadline) external returns(uint[] memory amounts)"
];

/* =========================
   STATE
========================= */
let provider = null;
let signer = null;
let userAddress = null;
let connected = false;

// Modal selection target
let modalTarget = null; // { swapIndex, field: "from"|"to" }

const swaps = [
  { label:"Swap A", tx:"TX #1", from:"PLS", to:"PHEX", amount:"", out:"", quote:"‚Äî", status:"Ready (connect wallet)", statusType:"warn" },
  { label:"Swap B", tx:"TX #2", from:"PLS", to:"ATROPA", amount:"", out:"", quote:"‚Äî", status:"Ready (connect wallet)", statusType:"warn" },
  { label:"Swap C", tx:"TX #3", from:"PHEX", to:"PLSX", amount:"", out:"", quote:"‚Äî", status:"Ready (connect wallet)", statusType:"warn" }
];

const balances = {}; // key: tokenSymbol => { raw: bigint, human: string }

/* =========================
   UI ELEMENTS
========================= */
const connectBtn = document.getElementById("connectBtn");
const netTxt = document.getElementById("netTxt");
const walTxt = document.getElementById("walTxt");
const netDot = document.getElementById("netDot");

const swapGrid = document.getElementById("swapGrid");

const modalOverlay = document.getElementById("modalOverlay");
const closeModal = document.getElementById("closeModal");
const tokenSearch = document.getElementById("tokenSearch");
const tokList = document.getElementById("tokList");
const toast = document.getElementById("toast");

document.getElementById("refreshBtn").addEventListener("click", async () => {
  await refreshAll();
});

document.getElementById("openModalBtn").addEventListener("click", () => {
  // juste scroll vers la section swaps
  document.querySelector(".sectionTitle").scrollIntoView({ behavior:"smooth", block:"start" });
});

document.getElementById("runABCBtn").addEventListener("click", async () => {
  if(!connected) return toastMsg("Connecte ton wallet d'abord.");
  // Ex√©cute A puis B puis C (si amount > 0)
  for(let i=0;i<3;i++){
    const amt = (swaps[i].amount||"").trim();
    if(!amt) continue;
    await doSwap(i);
  }
});

/* =========================
   HELPERS
========================= */
function toastMsg(msg){
  toast.textContent = msg;
  toast.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>toast.style.display="none", 2200);
}
function shortAddr(a){
  return a ? a.slice(0,6)+"‚Ä¶"+a.slice(-4) : "";
}
function isAddr(s){
  return /^0x[a-fA-F0-9]{40}$/.test((s||"").trim());
}
function nowDeadline(){
  const mins = Math.max(1, Number(document.getElementById("deadline").value||10));
  return Math.floor(Date.now()/1000) + Math.floor(mins*60);
}
function slippageBps(){
  const s = Math.max(0, Number(document.getElementById("slippage").value||2));
  // 2.0% -> 200 bps
  return Math.floor(s * 100);
}
function formatHuman(raw, decimals){
  // raw bigint -> string (limit√©)
  try{
    const s = ethers.formatUnits(raw, decimals);
    // limiter √† 6 d√©cimales lisibles
    const [i,d] = s.split(".");
    if(!d) return i;
    return i + "." + d.slice(0,6);
  }catch{
    return "0";
  }
}

/* =========================
   PATH / QUOTE
========================= */
function pathFor(tokenIn, tokenOut){
  // PLS = natif, sur router on passe via WPLS
  const inT = TOKENS[tokenIn];
  const outT = TOKENS[tokenOut];

  if(tokenIn === "PLS" && tokenOut === "PLS") return null;

  if(tokenIn === "PLS"){
    // PLS -> Token
    if(tokenOut === "WPLS") return [WPLS];
    return [WPLS, outT.address];
  }
  if(tokenOut === "PLS"){
    // Token -> PLS
    if(tokenIn === "WPLS") return [WPLS];
    return [inT.address, WPLS];
  }

  // Token -> Token
  return [inT.address, outT.address];
}

async function getQuoteForSwap(i){
  if(!provider) return;
  const s = swaps[i];
  const amt = (s.amount||"").trim();
  if(!amt) return;

  const router = new ethers.Contract(PULSEX_ROUTER, ROUTER_ABI, provider);

  try{
    const amountIn = ethers.parseUnits(amt, TOKENS[s.from].decimals);

    // Try direct path, fallback via WPLS if needed
    let path = pathFor(s.from, s.to);
    if(!path) throw new Error("M√™me token");

    let amounts;
    try{
      amounts = await router.getAmountsOut(amountIn, path);
    }catch(e){
      // fallback: in -> WPLS -> out (si token-token)
      if(s.from !== "PLS" && s.to !== "PLS" && s.from !== "WPLS" && s.to !== "WPLS"){
        const p2 = [TOKENS[s.from].address, WPLS, TOKENS[s.to].address];
        amounts = await router.getAmountsOut(amountIn, p2);
        path = p2;
      }else{
        throw e;
      }
    }

    const outRaw = amounts[amounts.length - 1];
    const outHuman = formatHuman(outRaw, TOKENS[s.to].decimals);

    s.out = outHuman;
    s.quote = `${amt} ${s.from} ‚Üí ~${outHuman} ${s.to}`;

    setStatus(i, "Ready ‚úì", "ok");
    renderSwaps();

  }catch(err){
    s.out = "";
    s.quote = "‚Äî";
    setStatus(i, "Quote impossible (liquidit√©?)", "warn");
    renderSwaps();
  }
}

/* =========================
   BALANCES
========================= */
async function refreshBalances(){
  if(!provider || !connected) {
    // show placeholders
    for(const k of Object.keys(TOKENS)){
      balances[k] = { raw: 0n, human: "Connect wallet" };
    }
    return;
  }

  // PLS balance
  try{
    const b = await provider.getBalance(userAddress);
    balances["PLS"] = { raw: b, human: formatHuman(b, 18) };
  }catch{
    balances["PLS"] = { raw: 0n, human: "‚Äî" };
  }

  // ERC20 balances for used tokens + common ones
  const need = new Set(["WPLS","PHEX","ATROPA","PLSX","DAI"]);
  for(const s of swaps){ need.add(s.from); need.add(s.to); }

  for(const sym of need){
    if(sym === "PLS") continue;
    const t = TOKENS[sym];
    if(!t || !t.address) continue;
    try{
      const c = new ethers.Contract(t.address, ERC20_ABI, provider);
      const r = await c.balanceOf(userAddress);
      balances[sym] = { raw: r, human: formatHuman(r, t.decimals) };
    }catch{
      balances[sym] = { raw: 0n, human: "‚Äî" };
    }
  }
}

function balanceOfSym(sym){
  return balances[sym]?.human ?? (connected ? "‚Äî" : "Connect wallet");
}

/* =========================
   APPROVE + SWAP
========================= */
async function ensureApprove(tokenSym, amountIn){
  if(tokenSym === "PLS") return;
  const t = TOKENS[tokenSym];
  if(!t?.address) return;

  const c = new ethers.Contract(t.address, ERC20_ABI, signer);
  const allowance = await c.allowance(userAddress, PULSEX_ROUTER);
  if(allowance >= amountIn) return;

  // Approve MAX
  await c.approve(PULSEX_ROUTER, ethers.MaxUint256);
}

async function doSwap(i){
  if(!connected) return toastMsg("Connecte ton wallet d'abord.");

  const s = swaps[i];
  const amt = (s.amount||"").trim();
  if(!amt) return toastMsg("Montant manquant.");

  // Validate tokens
  if(!TOKENS[s.from] || !TOKENS[s.to]) return toastMsg("Token invalide.");
  if(s.from === s.to) return toastMsg("From = To.");

  const router = new ethers.Contract(PULSEX_ROUTER, ROUTER_ABI, signer);
  const deadline = nowDeadline();
  const bps = slippageBps();

  try{
    setStatus(i, "Pr√©paration‚Ä¶", "warn");
    renderSwaps();

    const amountIn = ethers.parseUnits(amt, TOKENS[s.from].decimals);

    // Get quote for minOut
    let path = pathFor(s.from, s.to);
    if(!path) throw new Error("M√™me token");

    let amounts;
    try{
      amounts = await router.getAmountsOut(amountIn, path);
    }catch(e){
      if(s.from !== "PLS" && s.to !== "PLS" && s.from !== "WPLS" && s.to !== "WPLS"){
        const p2 = [TOKENS[s.from].address, WPLS, TOKENS[s.to].address];
        amounts = await router.getAmountsOut(amountIn, p2);
        path = p2;
      }else{
        throw e;
      }
    }

    const outRaw = amounts[amounts.length - 1];
    const minOut = outRaw * BigInt(10000 - bps) / 10000n;

    // Approve if needed
    if(s.from !== "PLS"){
      setStatus(i, "Approve (si besoin)‚Ä¶", "warn");
      renderSwaps();
      await ensureApprove(s.from, amountIn);
    }

    // Swap
    setStatus(i, "Transaction‚Ä¶ (MetaMask)", "warn");
    renderSwaps();

    let tx;
    if(s.from === "PLS"){
      // PLS -> Token : swapExactETHForTokens
      tx = await router.swapExactETHForTokens(
        minOut, path, userAddress, deadline,
        { value: amountIn }
      );
    } else if(s.to === "PLS"){
      // Token -> PLS : swapExactTokensForETH
      tx = await router.swapExactTokensForETH(
        amountIn, minOut, path, userAddress, deadline
      );
    } else {
      // Token -> Token
      tx = await router.swapExactTokensForTokens(
        amountIn, minOut, path, userAddress, deadline
      );
    }

    setStatus(i, "Pending‚Ä¶", "warn");
    renderSwaps();

    await tx.wait();

    setStatus(i, "Success ‚úì", "ok");
    renderSwaps();

    // refresh balances after swap
    await refreshAll();

  }catch(err){
    console.error(err);
    setStatus(i, "Erreur (tx refus√©e ?)", "bad");
    renderSwaps();
  }
}

/* =========================
   CONNECT WALLET
========================= */
async function connectWallet(){
  if(!window.ethereum){
    alert("MetaMask requis.");
    return;
  }

  try{
    await window.ethereum.request({ method:"eth_requestAccounts" });
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    userAddress = await signer.getAddress();

    const net = await provider.getNetwork();
    const chainId = Number(net.chainId);

    if(chainId !== PULSECHAIN_ID){
      netTxt.textContent = "mauvais r√©seau";
      netDot.style.background = "rgba(245,158,11,.95)";
      walTxt.textContent = shortAddr(userAddress);
      connected = true;
      // bouton reste utile
      connectBtn.textContent = "Changer r√©seau";
      toastMsg("Passe sur PulseChain (chainId 369).");
    }else{
      netTxt.textContent = "PulseChain";
      netDot.style.background = "rgba(34,197,94,.95)";
      walTxt.textContent = shortAddr(userAddress);
      connected = true;
      connectBtn.textContent = shortAddr(userAddress);
      toastMsg("Wallet connect√©.");
    }

    // Listen changes
    window.ethereum.removeListener?.("accountsChanged", onAccountsChanged);
    window.ethereum.removeListener?.("chainChanged", onChainChanged);
    window.ethereum.on?.("accountsChanged", onAccountsChanged);
    window.ethereum.on?.("chainChanged", onChainChanged);

    await refreshAll();

  }catch(e){
    console.error(e);
    toastMsg("Connexion annul√©e.");
  }
}

async function onAccountsChanged(accs){
  if(!accs || !accs.length){
    connected = false;
    userAddress = null;
    walTxt.textContent = "non connect√©";
    connectBtn.textContent = "Connect Wallet";
    await refreshAll();
    return;
  }
  // reconnect state
  provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();
  userAddress = await signer.getAddress();
  walTxt.textContent = shortAddr(userAddress);
  connectBtn.textContent = shortAddr(userAddress);
  await refreshAll();
}

async function onChainChanged(){
  // reload simple
  location.reload();
}

connectBtn.addEventListener("click", connectWallet);

/* =========================
   MODAL TOKENS
========================= */
function openTokenModal(target){
  modalTarget = target;
  tokenSearch.value = "";
  renderTokenList();
  modalOverlay.style.display = "flex";
  setTimeout(()=>tokenSearch.focus(), 50);
}
function closeTokenModal(){
  modalOverlay.style.display = "none";
  modalTarget = null;
}
closeModal.addEventListener("click", closeTokenModal);
modalOverlay.addEventListener("click", (e)=>{
  if(e.target === modalOverlay) closeTokenModal();
});

function ellAddr(a){
  if(!a) return "";
  return a.slice(0,6)+"‚Ä¶"+a.slice(-4);
}

async function addCustomTokenByAddress(addr){
  if(!provider) {
    toastMsg("Connecte MetaMask pour lire la cha√Æne.");
    return null;
  }
  try{
    const c = new ethers.Contract(addr, ERC20_ABI, provider);
    const [name,symbol,decimals] = await Promise.all([
      c.name(), c.symbol(), c.decimals()
    ]);
    const sym = symbol.toUpperCase();
    if(!TOKENS[sym]){
      TOKENS[sym] = { symbol:sym, address:addr, decimals:Number(decimals), name:name };
    }
    return TOKENS[sym];
  }catch{
    return null;
  }
}

async function watchAsset(token){
  if(!window.ethereum) return toastMsg("MetaMask requis.");
  if(!token.address) return toastMsg("Token natif (PLS).");
  try{
    await window.ethereum.request({
      method: "wallet_watchAsset",
      params: {
        type: "ERC20",
        options: {
          address: token.address,
          symbol: token.symbol,
          decimals: token.decimals
        }
      }
    });
  }catch(e){
    // MetaMask peut refuser / non support√© selon contexte
    console.error(e);
    toastMsg("Ajout refus√©/non support√©.");
  }
}

function copyText(txt){
  navigator.clipboard.writeText(txt).then(()=>toastMsg("Adresse copi√©e."));
}

function renderTokenList(){
  const q = (tokenSearch.value||"").trim().toLowerCase();

  // If user pasted address, try to resolve + show single entry
  const pastedAddr = isAddr(q) ? q : null;

  tokList.innerHTML = "";

  const entries = Object.values(TOKENS)
    .filter(t=>{
      if(!q) return true;
      if(pastedAddr) return true;
      return (t.symbol||"").toLowerCase().includes(q) || (t.name||"").toLowerCase().includes(q);
    })
    .sort((a,b)=> (a.symbol==="PLS" ? -1 : 0) - (b.symbol==="PLS" ? -1 : 0));

  // If pasted address, put it on top
  if(pastedAddr){
    const div = document.createElement("div");
    div.className = "tokRow";
    div.innerHTML = `
      <div class="tokLeft">
        <div class="tokSym">Importer token</div>
        <div class="tokAddr">${ellAddr(pastedAddr)} (via cha√Æne)</div>
      </div>
      <div class="tokRight">
        <div class="balTxt">‚Äî</div>
      </div>
    `;
    div.onclick = async ()=>{
      const t = await addCustomTokenByAddress(pastedAddr);
      if(!t){ toastMsg("Adresse invalide / non ERC20."); return; }
      applyTokenSelection(t.symbol);
      closeTokenModal();
      toastMsg(`Ajout√© : ${t.symbol}`);
      await refreshAll();
    };
    tokList.appendChild(div);
  }

  entries.forEach(t=>{
    const row = document.createElement("div");
    row.className = "tokRow";
    const addr = t.address ? ellAddr(t.address) : "Native";
    const bal = connected ? (balances[t.symbol]?.human ?? "‚Äî") : "‚Äî";
    row.innerHTML = `
      <div class="tokLeft">
        <div class="tokSym">${t.symbol}</div>
        <div class="tokAddr">${addr}</div>
      </div>
      <div class="tokRight">
        <div class="balTxt">${connected ? bal : ""}</div>
        ${t.address ? `
          <div class="miniIcon" title="Copier l'adresse">üìã</div>
          <div class="miniIcon" title="Ajouter √† MetaMask">ü¶ä</div>
        ` : `<div style="width:76px"></div>`}
      </div>
    `;

    // Row click selects token
    row.addEventListener("click", (e)=>{
      // ignore if icon clicked
      if(e.target && e.target.classList && e.target.classList.contains("miniIcon")) return;
      applyTokenSelection(t.symbol);
      closeTokenModal();
    });

    // Icons
    const icons = row.querySelectorAll(".miniIcon");
    if(icons.length){
      icons[0].addEventListener("click", (e)=>{ e.stopPropagation(); copyText(t.address); });
      icons[1].addEventListener("click", async (e)=>{ e.stopPropagation(); await watchAsset(t); });
    }

    tokList.appendChild(row);
  });
}

tokenSearch.addEventListener("input", ()=>{
  renderTokenList();
});

function applyTokenSelection(sym){
  if(!modalTarget) return;
  const { swapIndex, field } = modalTarget;
  swaps[swapIndex][field] = sym;

  // if same token both sides, keep but quote will fail; user can change
  swaps[swapIndex].out = "";
  swaps[swapIndex].quote = "‚Äî";
  setStatus(swapIndex, connected ? "Ready ‚úì" : "Ready (connect wallet)", connected ? "ok" : "warn");

  renderSwaps();
  // refresh quote for this swap
  setTimeout(()=>getQuoteForSwap(swapIndex), 50);
}

/* =========================
   RENDER SWAPS UI
========================= */
function setStatus(i, text, type){
  swaps[i].status = text;
  swaps[i].statusType = type;
}

function renderSwaps(){
  swapGrid.innerHTML = "";

  swaps.forEach((s, i)=>{
    const canSwap = connected && s.amount && s.from && s.to && (s.from !== s.to);

    const card = document.createElement("div");
    card.className = "card swapCard";

    card.innerHTML = `
      <div class="swapTop">
        <div><b>${s.label}</b></div>
        <span>${s.tx}</span>
      </div>

      <div class="sub">Tu payes</div>
      <div class="line">
        <button class="tokBtn" data-open="from"><span>${s.from}</span><small>‚ñæ</small></button>
        <div class="amtWrap">
          <input class="amt" inputmode="decimal" placeholder="Montant" value="${s.amount || ""}" />
          <button class="maxBtn" title="MAX">MAX</button>
        </div>
      </div>

      <div class="balanceRow">
        <div>Balance: <b>${balanceOfSym(s.from)}</b></div>
        <div></div>
      </div>

      <div class="pctRow">
        <button class="pct" data-pct="25">25%</button>
        <button class="pct" data-pct="50">50%</button>
        <button class="pct" data-pct="75">75%</button>
      </div>

      <div class="swapMid">
        <button class="flipBtn" title="Inverser">‚Üï</button>
      </div>

      <div class="sub">Tu re√ßois</div>
      <div class="line">
        <button class="tokBtn" data-open="to"><span>${s.to}</span><small>‚ñæ</small></button>
        <input class="amt" placeholder="Estimation" value="${s.out || ""}" readonly />
      </div>

      <div class="quoteBox"><b>Quote:</b> ${s.quote || "‚Äî"}</div>

      <div class="swapAction">
        <button class="swapGo" ${canSwap ? "" : "disabled"}>Ex√©cuter ${s.label.replace("Swap ","Swap ")}</button>
      </div>

      <div class="status ${s.statusType}">
        <span class="sDot"></span>
        <span>${s.status}</span>
      </div>
    `;

    // handlers
    const tokBtns = card.querySelectorAll(".tokBtn");
    tokBtns.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const which = btn.getAttribute("data-open"); // from|to
        openTokenModal({ swapIndex:i, field:which });
      });
    });

    const amtInput = card.querySelector(".amtWrap .amt");
    const maxBtn = card.querySelector(".maxBtn");
    const flipBtn = card.querySelector(".flipBtn");
    const swapGo = card.querySelector(".swapGo");
    const pctBtns = card.querySelectorAll(".pct");

    // Amount typing -> quote (debounced)
    let t;
    amtInput.addEventListener("input", ()=>{
      swaps[i].amount = amtInput.value;
      clearTimeout(t);
      t = setTimeout(()=>getQuoteForSwap(i), 250);
      renderSwaps(); // keep UI synced
    });

    // MAX
    maxBtn.addEventListener("click", ()=>{
      if(!connected) return toastMsg("Connecte ton wallet d'abord.");
      const b = balances[s.from];
      if(!b) return;
      // For PLS, keep small gas buffer
      let raw = b.raw;
      if(s.from === "PLS"){
        // subtract 1 PLS buffer
        const buffer = ethers.parseUnits("1", 18);
        raw = raw > buffer ? (raw - buffer) : 0n;
      }
      const human = formatHuman(raw, TOKENS[s.from].decimals);
      swaps[i].amount = human;
      renderSwaps();
      setTimeout(()=>getQuoteForSwap(i), 50);
    });

    // 25/50/75
    pctBtns.forEach(p=>{
      p.addEventListener("click", ()=>{
        if(!connected) return toastMsg("Connecte ton wallet d'abord.");
        const pct = Number(p.getAttribute("data-pct"));
        const b = balances[s.from];
        if(!b) return;
        let raw = b.raw * BigInt(pct) / 100n;
        if(s.from === "PLS"){
          const buffer = ethers.parseUnits("1", 18);
          raw = raw > buffer ? (raw - buffer) : 0n;
        }
        const human = formatHuman(raw, TOKENS[s.from].decimals);
        swaps[i].amount = human;
        renderSwaps();
        setTimeout(()=>getQuoteForSwap(i), 50);
      });
    });

    // Flip
    flipBtn.addEventListener("click", ()=>{
      const tmp = swaps[i].from;
      swaps[i].from = swaps[i].to;
      swaps[i].to = tmp;
      swaps[i].out = "";
      swaps[i].quote = "‚Äî";
      renderSwaps();
      setTimeout(()=>getQuoteForSwap(i), 80);
    });

    // Execute
    swapGo.addEventListener("click", async ()=>{
      await doSwap(i);
    });

    swapGrid.appendChild(card);
  });
}

/* =========================
   REFRESH ALL
========================= */
async function refreshAll(){
  // network display
  if(window.ethereum){
    try{
      const p = new ethers.BrowserProvider(window.ethereum);
      const net = await p.getNetwork();
      const chainId = Number(net.chainId);
      if(chainId === PULSECHAIN_ID){
        netTxt.textContent = "PulseChain";
        netDot.style.background = "rgba(34,197,94,.95)";
      }else{
        netTxt.textContent = "‚Äî";
        netDot.style.background = "rgba(255,255,255,.25)";
      }
    }catch{}
  }

  await refreshBalances();

  // update button label
  if(connected && userAddress){
    walTxt.textContent = shortAddr(userAddress);
    connectBtn.textContent = shortAddr(userAddress);
  }else{
    walTxt.textContent = "non connect√©";
    connectBtn.textContent = "Connect Wallet";
  }

  // update statuses
  swaps.forEach((s,i)=>{
    if(!connected){
      setStatus(i, "Ready (connect wallet)", "warn");
    }
  });

  renderSwaps();

  // quotes (only if connected OR provider present)
  if(provider){
    for(let i=0;i<swaps.length;i++){
      if((swaps[i].amount||"").trim()){
        await getQuoteForSwap(i);
      }
    }
  }

  // If modal open, refresh list (balances)
  if(modalOverlay.style.display === "flex"){
    renderTokenList();
  }
}

/* =========================
   INIT
========================= */
renderSwaps();
refreshAll();
</script>
</body>
</html>
