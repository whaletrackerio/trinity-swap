<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TRINITY Swap ‚Äî PulseChain</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

<style>
:root{
  --bg:#050816;
  --card:#0f172a;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --accent:#a855f7;
  --accent2:#ec4899;
  --good:#22c55e;
  --bad:#ef4444;
  --warn:#f59e0b;
  --radius:18px;
  --shadow:0 18px 45px rgba(0,0,0,.55);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
html{ scroll-padding-top: 140px; }
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background: radial-gradient(1200px 700px at 20% 0%, #0b102a 0%, var(--bg) 55%, #020617 100%);
  overflow-x:hidden;
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:
    radial-gradient(1200px 700px at 20% 0%, rgba(11,16,42,.78) 0%, rgba(5,8,22,.86) 55%, rgba(2,6,23,.92) 100%),
    url("./bg.png");
  background-size: cover;
  background-position: center;
  background-repeat:no-repeat;
  filter: saturate(1.15) contrast(1.05);
  opacity:.40;
  z-index:-2;
}
body::after{
  content:"";
  position:fixed;
  inset:0;
  background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.70));
  z-index:-1;
  pointer-events:none;
}
a{color:inherit;text-decoration:none}
.wrap{max-width:1200px;margin:0 auto;padding:22px 14px 90px}

/* HEADER STICKY */
header{
  display:flex;align-items:center;justify-content:space-between;gap:14px;
  position:sticky;top:0;z-index:50;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  background:linear-gradient(180deg, rgba(5,8,22,.92), rgba(5,8,22,.55));
  border-bottom:1px solid rgba(31,41,55,.6);
  padding:14px 12px;
  margin:-22px -14px 18px;
  box-shadow: 0 18px 45px rgba(0,0,0,.35);
  overflow:visible;
  flex-wrap:wrap;
}
.brand{display:flex;align-items:center;gap:12px;flex:0 0 auto}
.brand-logo{
  height:110px;
  width:auto;
  display:block;
  filter: drop-shadow(0 14px 26px rgba(168,85,247,.22));
  user-select:none;
}

/* ‚úÖ FIX: l'image garde sa place, les pills ne passent plus dessus */
.header-rect{
  flex:1 1 520px;
  min-width:520px;
  max-width:760px;
  height:110px;
  border-radius:18px;
  border:1px solid rgba(31,41,55,.80);
  background-color: rgba(2,6,23,.55);
  background-image: url("./header-art.png");
  background-size: cover;
  background-repeat:no-repeat;
  background-position: 72% 62%;
  filter: saturate(1.20) contrast(1.12) brightness(1.10);
  box-shadow: 0 18px 45px rgba(0,0,0,.45);
  overflow:hidden;
}
.top-right{
  display:flex;align-items:center;gap:10px;
  justify-content:flex-end;
  flex:0 0 auto;
  max-width:520px;
  min-width:0;
  flex-wrap:nowrap;
  overflow:visible;
}

/* ‚úÖ on passe en 2 lignes plus t√¥t -> plus de chevauchement sur l'image */
@media (max-width:1180px){
  html{ scroll-padding-top: 120px; }
  .brand-logo{ height:80px; }
  .header-rect{
    width:100%;
    max-width:none;
    min-width:0;
    height:170px;
    margin-top:10px;
    background-position: 70% 70%;
    order:3;
  }
  .top-right{
    order:2;
    width:100%;
    max-width:none;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
}

/* pills + buttons */
.pill{
  font-size:12px;color:var(--muted);
  border:1px solid rgba(31,41,55,.9);
  background:rgba(2,6,23,.60);
  padding:8px 10px;border-radius:999px;
  white-space:nowrap;
}
.btn{
  cursor:pointer;border:none;
  padding:10px 14px;border-radius:999px;
  background:linear-gradient(120deg,var(--accent),var(--accent2));
  color:#fff;font-weight:900;
  box-shadow:0 12px 30px rgba(236,72,153,.15);
  white-space:nowrap;
}
.btn:disabled{opacity:.55;cursor:not-allowed}
.btn2{
  cursor:pointer;border:1px solid rgba(31,41,55,.9);
  padding:10px 14px;border-radius:999px;
  background:rgba(2,6,23,.60);
  color:var(--text);font-weight:900;
  white-space:nowrap;
}
.btn2:disabled{opacity:.55;cursor:not-allowed}

/* ‚úÖ Wallet badge s√©par√© (copie adresse uniquement) */
.walletBadge{
  cursor:pointer;border:none;
  padding:10px 14px;border-radius:999px;
  background:linear-gradient(120deg,var(--accent),var(--accent2));
  color:#fff;font-weight:900;
  box-shadow:0 12px 30px rgba(236,72,153,.15);
  white-space:nowrap;
  max-width:200px;
  overflow:hidden;
  text-overflow:ellipsis;
  display:none;
}

/* page */
.grid2{display:grid;grid-template-columns:1.25fr .75fr;gap:14px;align-items:stretch}
@media(max-width:980px){.grid2{grid-template-columns:1fr}}
.card{
  background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.72));
  border:1px solid rgba(31,41,55,.9);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:16px;
}

/* ‚úÖ SWAP BOXES: √©pais + tr√®s brillant (SAFE) */
.swapbox{
  position:relative;
  border:3px solid rgba(236,72,153,.75) !important;
  border-radius: var(--radius);
  background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.72));
  box-shadow:
    0 18px 45px rgba(0,0,0,.55),
    0 0 0 2px rgba(168,85,247,.25) inset,
    0 0 30px rgba(236,72,153,.28),
    0 0 55px rgba(168,85,247,.18);
  transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
  isolation:isolate;
  contain: paint;
}
.swapbox:hover{
  border-color: rgba(168,85,247,.95) !important;
  box-shadow:
    0 22px 55px rgba(0,0,0,.65),
    0 0 0 2px rgba(236,72,153,.30) inset,
    0 0 42px rgba(236,72,153,.38),
    0 0 80px rgba(168,85,247,.25);
  transform: translateY(-1px);
}

h1{font-size:34px;line-height:1.05}
.sub{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.55}
.hr{height:1px;background:rgba(31,41,55,.7);margin:14px 0}
.chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.chip{
  font-size:12px;color:var(--text);
  border:1px solid rgba(31,41,55,.9);
  background:rgba(2,6,23,.60);
  padding:7px 10px;border-radius:999px;
  display:flex;align-items:center;gap:8px;
}
.okdot{width:10px;height:10px;border-radius:999px;background:var(--good);box-shadow:0 0 0 3px rgba(34,197,94,.15)}
.warnbox{
  border:1px solid rgba(245,158,11,.35);
  background:rgba(245,158,11,.08);
  padding:10px 12px;border-radius:14px;
  font-size:12px;color:var(--muted);
}
.ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
.ctaRow .btn2, .ctaRow .btn{display:inline-flex;align-items:center;gap:8px}
.sectionTitle{
  margin-top:18px;font-weight:900;font-size:14px;letter-spacing:.35px;color:var(--text);
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.sectionTitle small{color:var(--muted);font-weight:800}
.swaps{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:12px;padding-bottom:30px}
@media(max-width:980px){.swaps{grid-template-columns:1fr}}
label{font-size:12px;color:var(--muted)}
input,select{
  width:100%;margin-top:6px;
  padding:10px 11px;border-radius:14px;
  background:rgba(2,6,23,.70);
  border:1px solid rgba(31,41,55,.9);
  color:var(--text);outline:none;
}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.swap-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.swap-title b{font-size:13px}
.swap-title span{font-size:12px;color:var(--muted)}
.switch{display:flex;justify-content:center;margin:10px 0;}
.switch button{
  border:1px solid rgba(31,41,55,.9);
  background:rgba(2,6,23,.60);
  color:var(--text);border-radius:12px;
  padding:7px 10px;cursor:pointer;
}
.balRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px}
.balText{font-size:12px;color:var(--muted)}
.maxBtn,.pctBtn{
  border:1px solid rgba(31,41,55,.9);
  background:rgba(2,6,23,.60);
  color:var(--text);
  border-radius:999px;
  padding:6px 10px;
  cursor:pointer;
  font-weight:900;
  font-size:12px;
}
.maxBtn:disabled,.pctBtn:disabled{opacity:.55;cursor:not-allowed}
.pctRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.status{margin-top:10px;font-size:12px;color:var(--muted)}
.status.good{color:var(--good)}
.status.bad{color:var(--bad)}
.status.warn{color:var(--warn)}
.quoteLine{margin-top:8px;font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.txlink{font-weight:900;text-decoration:none;border-bottom:1px dotted rgba(229,231,235,.35)}
.bottomGrid{display:grid;grid-template-columns:1fr .9fr;gap:14px;margin-top:14px}
@media(max-width:980px){.bottomGrid{grid-template-columns:1fr}}
.linkItem{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:12px;border-radius:16px;
  border:1px solid rgba(31,41,55,.9);
  background:rgba(2,6,23,.50);
  margin-top:10px;
}
.linkItem b{font-size:13px}
.linkItem span{display:block;color:var(--muted);font-size:12px;margin-top:2px}
.linkBtn{padding:8px 12px;border-radius:999px}
footer{margin-top:26px;text-align:center;color:var(--muted);font-size:11px;line-height:1.6}

/* TOKEN MODAL */
#tokenModal{display:none; position:fixed; inset:0; z-index:9999;}
#tmBackdrop{position:absolute; inset:0; background:rgba(0,0,0,.65);}
.tmBox{
  position:relative; max-width:820px; width:calc(100% - 24px);
  margin:6vh auto;
  background:rgba(15,23,42,.96);
  border:1px solid rgba(31,41,55,.9);
  border-radius:18px; box-shadow:0 18px 45px rgba(0,0,0,.55);
  padding:14px;
  overflow:hidden;
}
.tmTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
.tmClose{cursor:pointer; border:none; background:transparent; color:#22c55e; font-size:26px; font-weight:900; line-height:1;}
.tmSearch{
  width:100%; padding:12px 12px; border-radius:14px; outline:none;
  background:rgba(2,6,23,.70); border:1px solid rgba(34,197,94,.35); color:#e5e7eb;
}
.tmList{margin-top:10px; max-height:520px; overflow:auto; padding-right:6px;}
.tmRow{
  display:grid;
  grid-template-columns: 44px 1fr 140px 140px;
  gap:10px;
  align-items:center;
  padding:12px; border-radius:16px; margin-bottom:10px;
  border:1px solid rgba(31,41,55,.9); background:rgba(2,6,23,.50);
  cursor:pointer;
}
@media(max-width:650px){
  .tmRow{grid-template-columns: 44px 1fr 120px; }
  .tmActions{display:none;}
}
.tmIcon{
  width:40px;height:40px;border-radius:14px;
  border:1px solid rgba(31,41,55,.9);
  background:rgba(2,6,23,.55);
  overflow:hidden;
  display:flex;align-items:center;justify-content:center;
  font-weight:900;
  color:#cbd5e1;
  user-select:none;
}
.tmIcon img{width:100%;height:100%;object-fit:cover;display:block}
.tmSym{font-weight:900;font-size:16px}
.tmMeta{color:var(--muted);font-size:12px;margin-top:2px}
.tmBal{
  text-align:right;
  font-size:12px;
  color:var(--muted);
  line-height:1.3;
}
.tmBal b{display:block;color:#e5e7eb;font-size:13px}
.tmActions{display:flex; gap:8px; align-items:center; justify-content:flex-end;}
.tmIconBtn{
  border:1px solid rgba(31,41,55,.9); background:rgba(2,6,23,.60);
  color:#e5e7eb; border-radius:12px; padding:8px 10px; cursor:pointer;
}
.tmBottom{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
  margin-top:10px; color:#9ca3af; font-size:12px;
}
.tmBottom .btn2{padding:8px 12px}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
.tmImport{
  border:1px solid rgba(168,85,247,.45) !important;
  background: rgba(168,85,247,.08) !important;
  cursor:default;
}
</style>
</head>

<body>
<div class="wrap">
<header>
  <div class="brand">
    <img src="./trinity-logo-full.png" alt="TRINITY Swap" class="brand-logo">
  </div>

  <div class="header-rect" aria-label="Header art"></div>

  <div class="top-right">
    <div class="pill" id="rpcPill">RPC : connexion‚Ä¶</div>
    <div class="pill" id="netPill">R√©seau : ‚Äî</div>
    <div class="pill" id="walletPill">Wallet : non connect√©</div>
    <div class="pill" id="plsPill">PLS : ‚Äî</div>

    <button class="btn" id="connectBtn" type="button">Connect Wallet</button>
    <button class="walletBadge" id="walletBadge" type="button" title="Copier l'adresse">‚Äî</button>
    <button class="btn2" id="disconnectBtn" type="button" style="display:none">Disconnect</button>
  </div>
</header>

<section class="grid2">
  <div class="card">
    <h1>Swap 3 tokens en parall√®le.<br/>Une interface, trois actions.</h1>
    <p class="sub">
      TRINITY = MultiSwap : tu pr√©pares 3 swaps diff√©rents et tu lances chaque swap avec son propre bouton.<br/>
      Mode 1 (PulseX-like) : UI au-dessus du router PulseX ‚Ä¢ non-custodial ‚Ä¢ 0 fee TRINITY.
    </p>

    <div class="chips">
      <div class="chip"><span class="okdot"></span>3 swaps ind√©pendants</div>
      <div class="chip"><span class="okdot"></span>Quotes live (sans wallet)</div>
      <div class="chip"><span class="okdot"></span>Approve auto (avec wallet)</div>
      <div class="chip"><span class="okdot"></span>MAX + balances (avec wallet)</div>
    </div>

    <div class="ctaRow">
      <button class="btn" id="openMultiBtn" type="button">üöÄ Ouvrir le MultiSwap</button>
      <button class="btn2" id="execTrinityBtn" type="button" disabled>‚ö° Ex√©cuter TRINITY (A‚ÜíB‚ÜíC)</button>
      <a class="btn2" href="https://whaletrackerio.github.io/autopilot-pulsechain/" target="_blank" rel="noreferrer">‚ö° AutoPilot</a>
      <a class="btn2" href="https://whaletrackerio.github.io/dca-pulsechain/" target="_blank" rel="noreferrer">üìà DCA</a>
      <a class="btn2" href="#support">üíú Soutenir</a>
    </div>

    <div class="hr"></div>
    <div class="warnbox">‚ö†Ô∏è Teste avec de petits montants. TRINITY ne garde pas tes fonds : c‚Äôest ton wallet qui signe.</div>
  </div>

  <div class="card">
    <div style="font-weight:900;font-size:14px">R√©glages</div>
    <p class="sub">Slippage + deadline pour calculer le minOut sur chaque swap.</p>

    <div class="hr"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label>Slippage (%)</label>
        <input id="slippage" type="number" min="0" step="0.1" value="2.0" />
      </div>
      <div>
        <label>Deadline (minutes)</label>
        <input id="deadlineM" type="number" min="1" step="1" value="10" />
      </div>
    </div>

    <div class="hr"></div>
    <div class="warnbox">
      Explorer : <a class="txlink" target="_blank" rel="noreferrer" href="https://otter.pulsechain.com/">otter.pulsechain.com</a>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn2" id="refreshBtn" type="button">‚Üª Refresh balances/quotes</button>
      <button class="btn2" id="openTokensBtn" type="button">ü™ô Ouvrir la liste tokens</button>
    </div>
  </div>
</section>

<div class="sectionTitle" id="multiswap">
  <div>MULTISWAP</div>
  <small>Pr√©pare 3 swaps puis clique sur le bouton de celui que tu veux ex√©cuter.</small>
</div>
<section class="swaps" id="swaps"></section>

<section class="bottomGrid">
  <div class="card" id="support">
    <div style="font-weight:900;font-size:14px">üíú Soutenir TRINITY</div>
    <p class="sub" style="margin-top:10px">
      TRINITY Swap est gratuit, non-custodial et sans frais TRINITY.<br/>
      Si l‚Äôoutil t‚Äôaide et que tu souhaites soutenir le d√©veloppement, tu peux faire un don.
    </p>
    <div class="hr"></div>
    <div class="warnbox" style="display:grid; gap:10px">
      <div style="font-weight:900;color:#e5e7eb">Adresse PulseChain :</div>
      <div class="mono" id="donAddr"
        style="padding:12px;border-radius:14px;border:1px solid rgba(31,41,55,.9);background:rgba(2,6,23,.70);word-break:break-all">
        0x7a23b75434942ddd7d9fe19aa0ed2fea08ed57a1
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
        <button class="btn2" id="copyDonBtn" type="button">üìã Copier l‚Äôadresse</button>
        <span id="copyDonMsg" style="color:var(--muted);font-size:12px"></span>
      </div>
      <div style="color:var(--muted);font-size:12px">Merci √† tous ceux qui soutiennent le projet üôè</div>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:900;font-size:14px">LIENS RAPIDES</div>
    <div class="linkItem">
      <div><b>PulseX</b><span>Swap officiel PulseChain.</span></div>
      <a class="btn2 linkBtn" href="https://pulsex.com" target="_blank" rel="noreferrer">Ouvrir</a>
    </div>
    <div class="linkItem">
      <div><b>Otter</b><span>Explorer / tx / contrats.</span></div>
      <a class="btn2 linkBtn" href="https://otter.pulsechain.com/" target="_blank" rel="noreferrer">Explorer</a>
    </div>
    <div class="linkItem">
      <div><b>AutoPilot</b><span>Tes bots HEX/ATROPA.</span></div>
      <a class="btn2 linkBtn" href="https://whaletrackerio.github.io/autopilot-pulsechain/" target="_blank" rel="noreferrer">Aller</a>
    </div>
    <div class="linkItem">
      <div><b>DCA PulseChain</b><span>8 bots DCA (achat √† l‚Äôunit√©).</span></div>
      <a class="btn2 linkBtn" href="https://whaletrackerio.github.io/dca-pulsechain/" target="_blank" rel="noreferrer">Aller</a>
    </div>
  </div>
</section>

<footer>
  TRINITY Swap ‚Äî PulseChain ‚Ä¢ Mode 1 (PulseX-like) ‚Ä¢ Aucun frais TRINITY<br/>
  Utilise √† tes risques. V√©rifie les adresses et teste petit.
</footer>
</div>

<!-- TOKEN MODAL -->
<div id="tokenModal">
  <div id="tmBackdrop"></div>
  <div class="tmBox">
    <div class="tmTop">
      <div style="font-weight:900;font-size:22px;">Select a token</div>
      <button class="tmClose" id="tmClose" type="button">‚úï</button>
    </div>
    <input class="tmSearch" id="tmSearch" placeholder="Search name or paste address (0x...)" />
    <div class="tmList" id="tmList"></div>
    <div class="tmBottom">
      <div>Coller une adresse 0x... pour importer un token (comme PulseX). üìã copie l‚Äôadresse. ü¶ä ajoute √† MetaMask.</div>
      <button class="btn2" id="tmRefresh" type="button">‚Üª Refresh</button>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const PULSECHAIN_ID = 369;
const PULSECHAIN_HEX = "0x171";
const PULSEX_ROUTER = "0x98bf93ebf5c380C0e6Ae8e192A7e2AE08edAcc02";
const WPLS_ADDR = "0xA1077a294dDE1B09bB078844df40758a5D0f9a27";
const PLS_GAS_RESERVE = ethers.parseUnits("0.05", 18);
const PULSEX_TOKENLIST_URL = "https://tokens.app.pulsex.com/pulsex-extended-v0.1.2.tokenlist.json";
const PITEAS_LOGO_BASE = "https://raw.githubusercontent.com/piteasio/app-tokens/main/token-logo/";
const RPCS = [
  "https://rpc.pulsechain.com",
  "https://pulsechain.publicnode.com",
  "https://pulsechain-rpc.publicnode.com"
];

const $ = (id)=>document.getElementById(id);
function norm(x){ return (x||"").toLowerCase(); }
function isAddr(x){ return /^0x[a-fA-F0-9]{40}$/.test((x||"").trim()); }
function shortAddr(a){ return a ? (a.slice(0,6)+"‚Ä¶"+a.slice(-4)) : ""; }
function safeGetAddress(a){ try{ return ethers.getAddress(a); }catch{ return null; } }
function txUrl(hash){ return `https://otter.pulsechain.com/tx/${hash}`; }
function formatAmountWithDec(decimals, raw){
  const s = ethers.formatUnits(raw, decimals);
  const num = Number(s);
  if(!isFinite(num)) return s;
  if(num === 0) return "0";
  if(num < 0.0001) return num.toExponential(3);
  return num.toLocaleString(undefined, { maximumFractionDigits: 6 });
}
function setStatus(card, txt, cls=""){
  const el = card.querySelector(".status");
  el.className = "status" + (cls ? " "+cls : "");
  el.textContent = txt;
}
function getSettings(){
  const sl = parseFloat($("slippage").value || "2");
  const dl = parseInt($("deadlineM").value || "10", 10);
  return { slippage: Math.max(0, sl), deadlineMin: Math.max(1, dl) };
}
async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); }
  catch{
    const ta=document.createElement("textarea");
    ta.value=txt; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
  }
}

/* ================= PROVIDERS ================= */
let readProvider = null;          // RPC read-only
let provider = null;              // BrowserProvider (wallet)
let signer = null;
let userAddress = null;
let walletOnPulse = false;

/* ‚úÖ anti-bug ‚Äúcopie au reconnect‚Äù (mousedown/mouseup) */
let CONNECTING = false;
let IGNORE_BADGE_UNTIL = 0;

function pickReadProvider(){
  for(const url of RPCS){
    try{ return new ethers.JsonRpcProvider(url, PULSECHAIN_ID); }catch(e){}
  }
  return null;
}
readProvider = pickReadProvider();
function getReadProvider(){ return provider || readProvider; }
function rpcReady(){ return !!getReadProvider(); }

/* ================= WALLET UI (PRO) ================= */
function setWalletUIConnected(){
  $("connectBtn").style.display = "none";

  const badge = $("walletBadge");
  badge.textContent = shortAddr(userAddress);
  badge.style.display = "inline-flex";

  badge.onclick = null;
  setTimeout(()=>{
    badge.onclick = async ()=>{
      if(Date.now() < IGNORE_BADGE_UNTIL) return;
      await copyText(userAddress);
      alert("Adresse copi√©e ‚úÖ");
    };
  }, 350);

  $("disconnectBtn").style.display = "inline-flex";
}
function setWalletUIDisconnected(){
  $("connectBtn").style.display = "inline-flex";
  $("connectBtn").disabled = false;
  $("walletBadge").style.display = "none";
  $("disconnectBtn").style.display = "none";
}
function disconnectWallet(){
  provider = null;
  signer = null;
  userAddress = null;
  walletOnPulse = false;

  $("walletPill").textContent = "Wallet : non connect√©";
  $("netPill").textContent = "R√©seau : (quotes RPC)";
  $("plsPill").textContent = "PLS : ‚Äî";

  setWalletUIDisconnected();
  setConnectedUI(false);
  refreshAll().catch(()=>{});
}
async function connectWallet(){
  if(CONNECTING) return;
  if(!window.ethereum){
    alert("Wallet requis : MetaMask");
    return;
  }

  CONNECTING = true;
  const btn = $("connectBtn");
  btn.disabled = true;

  try{
    await window.ethereum.request({ method:"eth_requestAccounts" });

    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    userAddress = await signer.getAddress();

    const net = await provider.getNetwork();
    let ok = (Number(net.chainId) === PULSECHAIN_ID);

    if(!ok){
      try{
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: PULSECHAIN_HEX }]
        });
        const net2 = await provider.getNetwork();
        ok = (Number(net2.chainId) === PULSECHAIN_ID);
      }catch(e){ console.error(e); }
    }

    walletOnPulse = ok;
    $("walletPill").textContent = "Wallet : " + shortAddr(userAddress);
    $("netPill").textContent = "R√©seau : " + (ok ? "PulseChain ‚úÖ" : "Mauvais r√©seau ‚ùå");

    if(!ok){
      alert("Passe sur PulseChain (chainId 369) puis reconnecte.");
      disconnectWallet();
      return;
    }

    IGNORE_BADGE_UNTIL = Date.now() + 700;

    setWalletUIConnected();
    setConnectedUI(true);
    await refreshAll();

    window.ethereum.on?.("accountsChanged", ()=> location.reload());
    window.ethereum.on?.("chainChanged", ()=> location.reload());
  }finally{
    CONNECTING = false;
    btn.disabled = false;
  }
}

/* ================= TOKENS ================= */
const BASE_FIXED = {
  PLS:  { symbol:"PLS",  address:null, decimals:18, name:"PulseChain", logoURI:null },
  WPLS: { symbol:"WPLS", address:WPLS_ADDR, decimals:18, name:"Wrapped PLS", logoURI:null },
  PHEX: { symbol:"PHEX", address:"0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39", decimals:8, name:"HEX (PulseChain)", logoURI:null },
  PLSX: { symbol:"PLSX", address:"0x95B303987A60C71504D99Aa1b13B4DA07b0790ab", decimals:18, name:"PulseX", logoURI:null },
  ATROPA:{ symbol:"ATROPA", address:"0xCc78A0acDF847A2C1714D2A925bB4477df5d48a6", decimals:18, name:"ATROPA", logoURI:null },
  EHEX: { symbol:"EHEX", address:"0x57fde0a71132198BBeC939B98976993d8D89D225", decimals:8, name:"eHEX", logoURI:null },
  INC:  { symbol:"INC",  address:"0x2fa878Ab3F87CC1C9737Fc071108F904c0B0C95d", decimals:18, name:"Incentive", logoURI:null },
  DAI:  { symbol:"DAI",  address:"0xefD766cCb38EaF1dfd701853BFCe31359239F305", decimals:18, name:"DAI", logoURI:null },
  USDC: { symbol:"USDC", address:"0x15D38573d2feeb82e7ad5187aB8c1D52810B1f07", decimals:6,  name:"USDC", logoURI:null },
  USDT: { symbol:"USDT", address:"0xdAC17F958D2ee523a2206206994597C13D831ec7", decimals:6,  name:"USDT", logoURI:null },
  WETH: { symbol:"WETH", address:"0x02DcdD04e3F455D838cd1249292C58f3B79e3C3C", decimals:18, name:"WETH", logoURI:null },
  WBTC: { symbol:"WBTC", address:"0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599", decimals:8,  name:"WBTC", logoURI:null },
};
let TOKENS = { ...BASE_FIXED };
let TOKENS_BY_ADDR = {};
function rebuildTOKENS_BY_ADDR(){
  TOKENS_BY_ADDR = {};
  for(const t of Object.values(TOKENS)){
    if(t.address) TOKENS_BY_ADDR[norm(t.address)] = t;
  }
}
rebuildTOKENS_BY_ADDR();

const LS_IMPORTED_KEY = "TRINITY_IMPORTED_TOKENS";
function loadImportedTokens(){
  try{
    const raw = localStorage.getItem(LS_IMPORTED_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [];
    return arr.filter(t => t && isAddr(t.address) && t.symbol && t.decimals != null);
  }catch{ return []; }
}
function saveImportedTokens(list){
  localStorage.setItem(LS_IMPORTED_KEY, JSON.stringify(list.slice(0,200)));
}
function addImportedToken(t){
  const cur = loadImportedTokens();
  const a = norm(t.address);
  const exists = cur.some(x => norm(x.address) === a);
  if(!exists){
    cur.unshift({ symbol:t.symbol, address:t.address, decimals:t.decimals, name:t.name||t.symbol, logoURI:t.logoURI||null });
    saveImportedTokens(cur);
  }
}
function addTokenToRuntime(t){
  let sym = (t.symbol||"").toUpperCase().trim();
  if(!sym) sym = "TOKEN";
  let key = sym;
  let i = 2;
  while(TOKENS[key] && TOKENS[key].address && norm(TOKENS[key].address) !== norm(t.address)){
    key = sym + "_" + i; i++;
  }
  TOKENS[key] = { ...t, symbol:key };
  rebuildTOKENS_BY_ADDR();
}

/* ================= ABI ================= */
const ERC20_ABI = [
  "function approve(address spender,uint256 amount) external returns (bool)",
  "function allowance(address owner,address spender) external view returns (uint256)",
  "function balanceOf(address owner) external view returns (uint256)",
  "function decimals() external view returns (uint8)",
  "function symbol() external view returns (string)",
  "function name() external view returns (string)"
];
const ROUTER_ABI = [
  "function getAmountsOut(uint256 amountIn, address[] calldata path) external view returns (uint256[] memory amounts)",
  "function swapExactTokensForTokens(uint256 amountIn,uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) external returns (uint256[] memory amounts)",
  "function swapExactETHForTokens(uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) external payable returns (uint256[] memory amounts)",
  "function swapExactTokensForETH(uint256 amountIn,uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) external returns (uint256[] memory amounts)"
];
function getRouterRead(){ return new ethers.Contract(PULSEX_ROUTER, ROUTER_ABI, getReadProvider()); }
function getRouterWrite(){ if(!signer) throw new Error("No signer"); return new ethers.Contract(PULSEX_ROUTER, ROUTER_ABI, signer); }
function getErc20Read(tokenAddr){ return new ethers.Contract(ethers.getAddress(tokenAddr), ERC20_ABI, getReadProvider()); }
function getErc20Write(tokenAddr){ if(!signer) throw new Error("No signer"); return new ethers.Contract(ethers.getAddress(tokenAddr), ERC20_ABI, signer); }

/* ================= LOGOS ================= */
function normalizeLogoUri(uri){
  if(!uri) return null;
  if(uri.startsWith("ipfs://")) return "https://cloudflare-ipfs.com/ipfs/" + uri.replace("ipfs://","");
  return uri;
}
function buildLogoCandidates(t){
  const out = [];
  const u = normalizeLogoUri(t.logoURI);
  if(u && (u.startsWith("http://") || u.startsWith("https://"))) out.push(u);
  if(t.address){
    try{
      out.push(PITEAS_LOGO_BASE + ethers.getAddress(t.address) + ".png");
      out.push(PITEAS_LOGO_BASE + norm(t.address) + ".png");
    }catch{}
  }else if(t.symbol === "PLS"){
    out.push("https://assets.coingecko.com/coins/images/26304/large/pulsechain.png");
  }
  return out;
}
function fallbackIconText(sym){ return (sym||"?").slice(0,1).toUpperCase(); }
function renderIconHTML(t){
  const candidates = buildLogoCandidates(t);
  if(!candidates.length) return `<div class="tmIcon">${fallbackIconText(t.symbol)}</div>`;
  const payload = encodeURIComponent(JSON.stringify(candidates));
  const sym = (t.symbol||"").replace(/'/g,"");
  return `
    <div class="tmIcon">
      <img
        src="${candidates[0]}"
        alt="${sym}"
        data-cands="${payload}"
        data-idx="0"
        referrerpolicy="no-referrer"
        onerror="
          try{
            const c=JSON.parse(decodeURIComponent(this.dataset.cands));
            let i=parseInt(this.dataset.idx||'0',10)+1;
            if(i<c.length){ this.dataset.idx=String(i); this.src=c[i]; return; }
          }catch(e){}
          this.parentElement.textContent='${fallbackIconText(sym)}';
        "
      />
    </div>`;
}
function tokenMetaLine(t){
  const addr = t.address ? shortAddr(t.address) : "Native";
  const name = t.name ? ` ‚Ä¢ ${t.name}` : "";
  return `<div class="tmMeta mono">${addr}${name}</div>`;
}

/* ================= TOKENLIST (logos) ================= */
async function loadPulseXTokenList(){
  try{
    const r = await fetch(PULSEX_TOKENLIST_URL, { cache:"no-store" });
    const j = await r.json();
    return Array.isArray(j.tokens) ? j.tokens : [];
  }catch(e){
    console.warn("Tokenlist fetch failed:", e);
    return [];
  }
}
function mergeTokenDataFromList(list){
  for(const t of list){
    if(Number(t.chainId) !== PULSECHAIN_ID) continue;
    if(!isAddr(t.address)) continue;
    const addr = safeGetAddress(t.address);
    if(!addr) continue;
    const sym = String(t.symbol||"").toUpperCase().trim();
    const dec = Number(t.decimals ?? 18);

    const known = TOKENS_BY_ADDR[norm(addr)];
    if(known){
      if(!known.logoURI && t.logoURI) known.logoURI = t.logoURI;
      if(!known.name && t.name) known.name = t.name;
      if(!known.decimals && dec) known.decimals = dec;
      continue;
    }

    if(TOKENS[sym] && TOKENS[sym].address && norm(TOKENS[sym].address) === norm(addr)){
      if(!TOKENS[sym].logoURI && t.logoURI) TOKENS[sym].logoURI = t.logoURI;
      if(!TOKENS[sym].name && t.name) TOKENS[sym].name = t.name;
      TOKENS[sym].decimals = TOKENS[sym].decimals ?? dec;
    }
  }
  rebuildTOKENS_BY_ADDR();

  const imported = loadImportedTokens();
  for(const t of imported){
    const sym = (t.symbol||"").toUpperCase();
    const addr = safeGetAddress(t.address);
    if(!sym || !addr) continue;
    if(!TOKENS[sym]) TOKENS[sym] = { ...t, symbol:sym, address:addr, decimals:Number(t.decimals) };
  }
  rebuildTOKENS_BY_ADDR();
}

/* ================= UI BUILD: 3 SWAPS ================= */
const swapsEl = $("swaps");
function swapCardTemplate(i, label){
  return `
  <div class="card swapbox" id="swap${i}">
    <div class="swap-title">
      <b>${label}</b>
      <span>TX #${i}</span>
    </div>

    <label>Tu payes</label>
    <div class="row2">
      <select class="from"></select>
      <input class="amount" inputmode="decimal" placeholder="Montant" />
    </div>

    <div class="balRow">
      <div class="balText">Balance: <span class="balIn">‚Äî</span></div>
      <button class="maxBtn" type="button" disabled>MAX</button>
    </div>

    <div class="pctRow">
      <button class="pctBtn" type="button" data-p="25" disabled>25%</button>
      <button class="pctBtn" type="button" data-p="50" disabled>50%</button>
      <button class="pctBtn" type="button" data-p="75" disabled>75%</button>
    </div>

    <div class="switch"><button class="invert" type="button" title="Inverser">‚Üï</button></div>

    <label>Tu re√ßois</label>
    <div class="row2">
      <select class="to"></select>
      <input class="out" placeholder="Estimation" readonly />
    </div>

    <div class="quoteLine">
      <span>Quote:</span>
      <span class="quoteText">‚Äî</span>
    </div>

    <div class="actions">
      <button class="btn2 approveBtn" type="button" style="display:none" disabled>Approve</button>
      <button class="btn swapBtn" type="button" disabled>Ex√©cuter ${label}</button>
    </div>

    <div class="status">Quotes dispo sans wallet ‚úÖ (connecte pour swap)</div>

    <div class="quoteLine" style="margin-top:10px">
      <a class="txlink txA" target="_blank" rel="noreferrer" style="display:none">Voir TX</a>
    </div>
  </div>`;
}
function buildCards(){
  swapsEl.innerHTML = "";
  swapsEl.insertAdjacentHTML("beforeend", swapCardTemplate(1,"Swap A"));
  swapsEl.insertAdjacentHTML("beforeend", swapCardTemplate(2,"Swap B"));
  swapsEl.insertAdjacentHTML("beforeend", swapCardTemplate(3,"Swap C"));
}
buildCards();

function listSymbolsForUI(){
  const pinned = ["PLS","WPLS","PHEX","EHEX","PLSX","INC","DAI","USDC","USDT","WETH","WBTC","ATROPA"];
  const all = Object.keys(TOKENS).map(s=>s.toUpperCase());
  const set = new Set(all);
  const ordered = [];
  for(const p of pinned){ if(set.has(p)) ordered.push(p); }
  const rest = all.filter(s=>!ordered.includes(s)).sort((a,b)=>a.localeCompare(b));
  return [...ordered, ...rest];
}
function fillSelect(sel, selected){
  const syms = listSymbolsForUI();
  sel.innerHTML = "";
  for(const k of syms){
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = k;
    sel.appendChild(opt);
  }
  sel.value = selected && TOKENS[selected] ? selected : syms[0];
}
function initCardsDefaults(){
  const defaults = [
    {from:"PLS",  to:"PHEX"},
    {from:"PLS",  to:"ATROPA"},
    {from:"PHEX", to:"PLSX"},
  ];
  document.querySelectorAll(".swapbox").forEach((card, idx)=>{
    const fromSel = card.querySelector(".from");
    const toSel   = card.querySelector(".to");
    fillSelect(fromSel, defaults[idx].from);
    fillSelect(toSel, defaults[idx].to);

    card.querySelector(".invert").addEventListener("click", ()=>{
      const a = fromSel.value;
      fromSel.value = toSel.value;
      toSel.value = a;
      triggerQuote(card);
      refreshCardBalance(card).catch(()=>{});
    });

    fromSel.addEventListener("change", ()=>{
      triggerQuote(card);
      refreshCardBalance(card).catch(()=>{});
    });
    toSel.addEventListener("change", ()=> triggerQuote(card));
    card.querySelector(".amount").addEventListener("input", ()=> triggerQuote(card));
  });
}

/* ================= PATH / AMOUNTS ================= */
function buildPath(symIn, symOut){
  if(symIn === symOut) return null;
  const inT = TOKENS[symIn];
  const outT = TOKENS[symOut];
  if(!inT || !outT) return null;

  if(symIn === "PLS"){
    if(!outT.address) return null;
    return [WPLS_ADDR, ethers.getAddress(outT.address)];
  }
  if(symOut === "PLS"){
    if(!inT.address) return null;
    return [ethers.getAddress(inT.address), WPLS_ADDR];
  }
  if(!inT.address || !outT.address) return null;
  return [ethers.getAddress(inT.address), ethers.getAddress(outT.address)];
}
function parseAmount(sym, human){
  const t = TOKENS[sym];
  const dec = t?.decimals ?? 18;
  return ethers.parseUnits(human, dec);
}
function formatAmount(sym, raw){
  const t = TOKENS[sym];
  const dec = t?.decimals ?? 18;
  return formatAmountWithDec(dec, raw);
}
function validatePair(card){
  const from = card.querySelector(".from").value;
  const to = card.querySelector(".to").value;
  if(from === to){
    setStatus(card, "Paire invalide (tokens identiques)", "bad");
    return false;
  }
  return true;
}

/* ================= BALANCES (wallet only) ================= */
async function getBalance(sym){
  if(!provider || !userAddress) return null;
  if(sym === "PLS") return await provider.getBalance(userAddress);
  const t = TOKENS[sym];
  if(!t?.address) return 0n;
  return await getErc20Read(t.address).balanceOf(userAddress);
}
async function refreshHeaderPLS(){
  if(!provider || !userAddress) return;
  const b = await provider.getBalance(userAddress);
  $("plsPill").textContent = "PLS : " + formatAmountWithDec(18, b);
}
async function refreshCardBalance(card){
  const balEl = card.querySelector(".balIn");
  const from = card.querySelector(".from").value;
  if(!provider || !userAddress || !walletOnPulse){
    balEl.textContent = "Connect wallet";
    return;
  }
  const bal = await getBalance(from);
  if(bal == null) { balEl.textContent = "‚Äî"; return; }
  balEl.textContent = formatAmount(from, bal);
}
async function refreshAll(){
  const cards = document.querySelectorAll(".swapbox");
  for(const card of cards){
    await updateQuote(card);
  }
  if(provider && userAddress && walletOnPulse){
    await refreshHeaderPLS();
    for(const card of cards){
      await refreshCardBalance(card);
    }
    if($("tokenModal").style.display === "block"){
      await renderTokenList(($("tmSearch").value||"").trim(), true);
    }
  }else{
    $("plsPill").textContent = "PLS : ‚Äî";
    if($("tokenModal").style.display === "block"){
      await renderTokenList(($("tmSearch").value||"").trim(), false);
    }
  }
}

/* ================= MAX + % (wallet only) ================= */
async function setAmountFromPercent(card, pct){
  if(!provider || !userAddress || !walletOnPulse) return alert("Connecte ton wallet sur PulseChain d‚Äôabord");
  if(!validatePair(card)) return;
  const from = card.querySelector(".from").value;
  let bal = await getBalance(from);
  if(bal == null) return;

  if(from === "PLS"){
    if(bal <= PLS_GAS_RESERVE){
      alert("Balance PLS insuffisante pour le gas");
      return;
    }
    bal = bal - PLS_GAS_RESERVE;
  }
  const amount = bal * BigInt(pct) / 100n;
  const dec = TOKENS[from]?.decimals ?? 18;
  card.querySelector(".amount").value = ethers.formatUnits(amount, dec);
  await updateQuote(card);
}
function wireMaxPctButtons(){
  document.querySelectorAll(".swapbox").forEach(card=>{
    card.querySelector(".maxBtn").addEventListener("click", ()=> setAmountFromPercent(card, 100).catch(console.error));
    card.querySelectorAll(".pctBtn").forEach(b=>{
      b.addEventListener("click", ()=> setAmountFromPercent(card, parseInt(b.dataset.p,10)).catch(console.error));
    });
  });
}
wireMaxPctButtons();

/* ================= QUOTES (RPC ONLY) ================= */
let quoteTimer = null;
function triggerQuote(card){
  if(quoteTimer) clearTimeout(quoteTimer);
  quoteTimer = setTimeout(()=> updateQuote(card).catch(()=>{}), 250);
}
async function updateQuote(card){
  const outInp = card.querySelector(".out");
  const quoteText = card.querySelector(".quoteText");
  const approveBtn = card.querySelector(".approveBtn");
  const from = card.querySelector(".from").value;
  const to = card.querySelector(".to").value;
  const amt = (card.querySelector(".amount").value || "").trim();

  outInp.value = "";
  quoteText.textContent = "‚Äî";
  approveBtn.style.display = "none";
  approveBtn.disabled = true;

  if(!rpcReady()){
    setStatus(card, "RPC indisponible (quotes off) ‚ùå", "bad");
    return;
  }
  if(!validatePair(card)) return;
  if(!amt || Number(amt) <= 0){
    setStatus(card, "Quotes dispo ‚úÖ (mets un montant)", "good");
    return;
  }

  try{
    setStatus(card, "Quoting‚Ä¶", "warn");
    const amountIn = parseAmount(from, amt);
    const path = buildPath(from, to);
    if(!path) throw new Error("Invalid path");
    const router = getRouterRead();
    const amounts = await router.getAmountsOut(amountIn, path);
    const outRaw = amounts[amounts.length - 1];

    outInp.value = formatAmount(to, outRaw);
    quoteText.textContent = `${amt} ${from} ‚Üí ~${formatAmount(to, outRaw)} ${to}`;

    if(provider && userAddress && walletOnPulse){
      setStatus(card, "Ready ‚úÖ (connect√©)", "good");
    }else{
      setStatus(card, "Quote OK ‚úÖ (connecte pour swap)", "good");
    }
  }catch(e){
    console.error(e);
    setStatus(card, "Quote error (pair/liquidit√©?)", "bad");
  }
}

/* ================= APPROVE / SWAP (wallet only) ================= */
async function checkAllowance(symIn, amountRaw){
  if(symIn === "PLS") return true;
  if(!provider || !userAddress || !walletOnPulse) return false;
  const t = TOKENS[symIn];
  if(!t?.address) return true;
  const allowance = await getErc20Read(t.address).allowance(userAddress, PULSEX_ROUTER);
  return allowance >= amountRaw;
}
async function doApprove(symIn, card){
  const t = TOKENS[symIn];
  const erc = getErc20Write(t.address);
  setStatus(card, "Approving‚Ä¶ (MetaMask)", "warn");
  const tx = await erc.approve(PULSEX_ROUTER, ethers.MaxUint256);
  setStatus(card, "Approve pending‚Ä¶", "warn");
  await tx.wait();
  setStatus(card, "Approve OK ‚úÖ", "good");
}
async function executeSwap(card){
  if(!provider || !userAddress || !walletOnPulse) return alert("Connecte ton wallet sur PulseChain");
  if(!validatePair(card)) return;

  const from = card.querySelector(".from").value;
  const to   = card.querySelector(".to").value;
  const amt  = (card.querySelector(".amount").value || "").trim();
  const txLink = card.querySelector(".txA");
  txLink.style.display = "none";

  if(!amt || Number(amt) <= 0){
    setStatus(card, "Montant manquant", "bad");
    return;
  }

  const { slippage, deadlineMin } = getSettings();
  try{
    const routerWrite = getRouterWrite();
    const routerRead  = getRouterRead();
    const amountIn = parseAmount(from, amt);
    const path = buildPath(from, to);
    if(!path) throw new Error("Invalid path");

    if(from !== "PLS"){
      const ok = await checkAllowance(from, amountIn);
      if(!ok) await doApprove(from, card);
    }

    setStatus(card, "Calcul minOut‚Ä¶", "warn");
    const amounts = await routerRead.getAmountsOut(amountIn, path);
    const outRaw  = amounts[amounts.length - 1];
    const bps = Math.round(slippage * 100);
    const minOut = outRaw * BigInt(10000 - bps) / 10000n;
    const deadline = Math.floor(Date.now()/1000) + (deadlineMin * 60);

    let tx;
    setStatus(card, "Signature (MetaMask)‚Ä¶", "warn");
    if(from === "PLS"){
      tx = await routerWrite.swapExactETHForTokens(minOut, path, userAddress, deadline, { value: amountIn });
    }else if(to === "PLS"){
      tx = await routerWrite.swapExactTokensForETH(amountIn, minOut, path, userAddress, deadline);
    }else{
      tx = await routerWrite.swapExactTokensForTokens(amountIn, minOut, path, userAddress, deadline);
    }

    setStatus(card, "Pending‚Ä¶", "warn");
    txLink.href = txUrl(tx.hash);
    txLink.textContent = "Voir TX";
    txLink.style.display = "inline-flex";

    await tx.wait();
    setStatus(card, "Success ‚úÖ", "good");
    await refreshAll();
  }catch(e){
    console.error(e);
    setStatus(card, "Swap error (cancel ? liquidit√© ?)", "bad");
  }
}
function setConnectedUI(isConnected){
  document.querySelectorAll(".swapBtn").forEach(b => b.disabled = !isConnected);
  document.querySelectorAll(".maxBtn").forEach(b => b.disabled = !isConnected);
  document.querySelectorAll(".pctBtn").forEach(b => b.disabled = !isConnected);
  $("execTrinityBtn").disabled = !isConnected;

  document.querySelectorAll(".swapbox").forEach(card=>{
    const approveBtn = card.querySelector(".approveBtn");
    approveBtn.style.display = "none";
    approveBtn.disabled = true;
  });
}
function wireSwapButtons(){
  document.querySelectorAll(".swapbox").forEach(card=>{
    card.querySelector(".swapBtn").addEventListener("click", ()=> executeSwap(card));
  });
}
wireSwapButtons();

/* ================= EXECUTE TRINITY (A‚ÜíB‚ÜíC) ================= */
$("execTrinityBtn").addEventListener("click", async ()=>{
  if(!provider || !userAddress || !walletOnPulse) return alert("Connecte ton wallet sur PulseChain");
  const cards = [ $("swap1"), $("swap2"), $("swap3") ];

  $("multiswap").scrollIntoView({behavior:"smooth", block:"start"});
  window.scrollBy(0, -90);

  for(const card of cards){
    const amt = (card.querySelector(".amount").value || "").trim();
    const from = card.querySelector(".from").value;
    const to = card.querySelector(".to").value;

    if(!amt || Number(amt) <= 0){
      setStatus(card, "Skip (montant vide)", "");
      continue;
    }
    if(from === to){
      setStatus(card, "Skip (tokens identiques)", "bad");
      continue;
    }

    await executeSwap(card);
    const st = (card.querySelector(".status").textContent || "").toLowerCase();
    if(st.includes("error")){
      alert("TRINITY stopp√© (erreur sur un swap).");
      break;
    }
  }
});

/* ================= TOKEN MODAL ================= */
let tokenModalTarget = null;
function openTokenModal(card, side){
  tokenModalTarget = { card, side };
  $("tokenModal").style.display = "block";
  $("tmSearch").value = "";
  renderTokenList("", false);
  setTimeout(()=>$("tmSearch").focus(), 50);
}
function closeTokenModal(){
  $("tokenModal").style.display = "none";
  tokenModalTarget = null;
}
$("tmClose").onclick = closeTokenModal;
$("tmBackdrop").onclick = closeTokenModal;
$("tmSearch").addEventListener("input", (e)=> renderTokenList((e.target.value||"").trim(), false));
$("tmRefresh").addEventListener("click", ()=> refreshAll());

async function addTokenToMetaMask(sym){
  const t = TOKENS[sym];
  if(!window.ethereum) return alert("MetaMask requis");
  if(!t.address) return alert("PLS = token natif (pas ERC20)");
  try{
    const wasAdded = await window.ethereum.request({
      method: "wallet_watchAsset",
      params: {
        type: "ERC20",
        options: {
          address: t.address,
          symbol: sym,
          decimals: t.decimals,
          image: normalizeLogoUri(t.logoURI) || undefined
        }
      }
    });
    if(wasAdded) alert("Token ajout√© √† MetaMask ‚úÖ");
    else throw new Error("Refus MetaMask");
  }catch(e){
    console.warn(e);
    await copyText(t.address);
    alert("Import auto refus√©.\n‚úÖ Adresse copi√©e.\n‚û°Ô∏è Colle dans MetaMask > Import token.");
    window.open("https://otter.pulsechain.com/address/" + t.address, "_blank");
  }
}
async function resolveTokenByAddress(addr){
  const a = safeGetAddress(addr);
  if(!a) throw new Error("Bad address");
  const known = TOKENS_BY_ADDR[norm(a)];
  if(known) return known;
  if(!rpcReady()) throw new Error("No RPC");
  const c = new ethers.Contract(a, ERC20_ABI, getReadProvider());
  const [sym, name, dec] = await Promise.all([ c.symbol(), c.name(), c.decimals() ]);
  return {
    symbol: String(sym).toUpperCase().slice(0,11),
    address: a,
    decimals: Number(dec),
    name: String(name).slice(0,64),
    logoURI: null
  };
}

async function renderTokenList(q, withBalances){
  const listEl = $("tmList");
  const nq = norm(q);
  const tokensArr = [];
  for(const sym of listSymbolsForUI()){
    const t = TOKENS[sym];
    if(t) tokensArr.push(t);
  }

  const wantAddr = isAddr(q) ? safeGetAddress(q) : null;
  const filtered = tokensArr.filter(t=>{
    if(!q) return true;
    if(wantAddr) return t.address && norm(t.address) === norm(wantAddr);
    return norm(t.symbol).includes(nq) || norm(t.name||"").includes(nq);
  });

  let html = "";
  if(wantAddr){
    html += `
      <div class="tmRow tmImport" id="tmImportRow">
        <div class="tmIcon">+</div>
        <div>
          <div class="tmSym">Import par adresse</div>
          <div class="tmMeta mono">${shortAddr(wantAddr)} ‚Ä¢ lecture via RPC PulseChain</div>
        </div>
        <div class="tmBal" id="tmImportMeta"><b>‚Äî</b>Token</div>
        <div class="tmActions">
          <button class="tmIconBtn" id="tmImportBtn" disabled type="button">Import</button>
        </div>
      </div>`;
  }

  html += filtered.map(t=>`
    <div class="tmRow" data-sym="${t.symbol}">
      ${renderIconHTML(t)}
      <div>
        <div class="tmSym">${t.symbol}</div>
        ${tokenMetaLine(t)}
      </div>
      <div class="tmBal"><b>‚Äî</b>Balance</div>
      <div class="tmActions">
        ${t.address ? `
          <button class="tmIconBtn tmCopy" type="button" title="Copy address">üìã</button>
          <button class="tmIconBtn tmAdd" type="button" title="Add to MetaMask">ü¶ä</button>
        ` : `<span style="color:var(--muted)">‚Äî</span>`}
      </div>
    </div>
  `).join("");

  listEl.innerHTML = html;

  listEl.querySelectorAll(".tmRow[data-sym]").forEach(row=>{
    row.addEventListener("click", async (e)=>{
      if(e.target.classList.contains("tmCopy") || e.target.classList.contains("tmAdd")) return;
      const sym = row.dataset.sym;
      if(!tokenModalTarget) return;

      const { card, side } = tokenModalTarget;
      const sel = card.querySelector(side === "from" ? ".from" : ".to");
      fillSelect(sel, sym);
      sel.value = sym;
      closeTokenModal();
      await refreshCardBalance(card).catch(()=>{});
      await updateQuote(card).catch(()=>{});
    });
  });

  listEl.querySelectorAll(".tmCopy").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      const sym = btn.closest(".tmRow").dataset.sym;
      await copyText(TOKENS[sym].address);
      btn.textContent="‚úÖ";
      setTimeout(()=>btn.textContent="üìã", 700);
    });
  });

  listEl.querySelectorAll(".tmAdd").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      const sym = btn.closest(".tmRow").dataset.sym;
      await addTokenToMetaMask(sym);
    });
  });

  if(wantAddr){
    const metaEl = $("tmImportMeta");
    const btn = $("tmImportBtn");
    btn.disabled = true;
    metaEl.innerHTML = `<b>Lecture‚Ä¶</b>Token`;

    try{
      const t = await resolveTokenByAddress(wantAddr);
      const already = TOKENS_BY_ADDR[norm(t.address)];
      if(already){
        metaEl.innerHTML = `<b>${already.symbol}</b>${already.name ? " "+already.name : ""}`;
        btn.textContent = "D√©j√†";
        btn.disabled = true;
      }else{
        metaEl.innerHTML = `<b>${t.symbol}</b>${t.name ? " "+t.name : ""} ‚Ä¢ ${t.decimals} dec`;
        btn.textContent = "Import";
        btn.disabled = false;

        btn.onclick = async ()=>{
          addTokenToRuntime(t);
          addImportedToken(t);

          document.querySelectorAll(".swapbox").forEach(card=>{
            const fromSel = card.querySelector(".from");
            const toSel = card.querySelector(".to");
            const curFrom = fromSel.value;
            const curTo = toSel.value;
            fillSelect(fromSel, curFrom);
            fillSelect(toSel, curTo);
          });

          metaEl.innerHTML = `<b>Import√© ‚úÖ</b>Token`;
          btn.textContent = "OK";
          btn.disabled = true;
          await refreshAll().catch(()=>{});
        };
      }
    }catch(e){
      console.error(e);
      metaEl.innerHTML = `<b>Import impossible</b><div class="tmMeta mono">RPC indisponible ou token invalide</div>`;
      btn.textContent = "Import";
      btn.disabled = true;
    }
  }

  if(withBalances && provider && userAddress && walletOnPulse){
    for(const row of listEl.querySelectorAll(".tmRow[data-sym]")){
      const sym = row.dataset.sym;
      const t = TOKENS[sym];
      const balBox = row.querySelector(".tmBal");
      try{
        if(!t.address){
          const bal = await provider.getBalance(userAddress);
          balBox.innerHTML = `<b>${formatAmountWithDec(18, bal)}</b>Balance`;
        }else{
          const bal = await getErc20Read(t.address).balanceOf(userAddress);
          const dec = t.decimals ?? 18;
          balBox.innerHTML = `<b>${formatAmountWithDec(dec, bal)}</b>Balance`;
        }
      }catch{
        balBox.innerHTML = `<b>‚Äî</b>Balance`;
      }
    }
  }
}

/* open token modal on selects */
document.querySelectorAll(".swapbox").forEach(card=>{
  const fromSel = card.querySelector(".from");
  const toSel   = card.querySelector(".to");
  const openFrom = (e)=>{ e.preventDefault(); openTokenModal(card,"from"); };
  const openTo   = (e)=>{ e.preventDefault(); openTokenModal(card,"to"); };
  fromSel.addEventListener("mousedown", openFrom);
  toSel.addEventListener("mousedown", openTo);
  fromSel.addEventListener("touchstart", openFrom, {passive:false});
  toSel.addEventListener("touchstart", openTo, {passive:false});
});
$("openTokensBtn").addEventListener("click", ()=> openTokenModal($("swap1"), "from"));
$("openMultiBtn").addEventListener("click", ()=>{
  $("multiswap").scrollIntoView({behavior:"smooth", block:"start"});
  window.scrollBy(0, -90);
});

/* ================= HEADER BUTTONS ================= */
$("connectBtn").addEventListener("pointerdown", (e)=>{
  e.preventDefault();
  e.stopPropagation();
  connectWallet();
});
$("disconnectBtn").addEventListener("click", disconnectWallet);
$("refreshBtn").addEventListener("click", ()=> refreshAll());

/* ================= DONATION COPY ================= */
(function initDonationBox(){
  const btn = $("copyDonBtn");
  const msg = $("copyDonMsg");
  const addr = "0x7a23b75434942ddd7d9fe19aa0ed2fea08ed57a1";
  if(!btn) return;
  btn.addEventListener("click", async ()=>{
    await copyText(addr);
    msg.textContent = "Copi√© ‚úÖ";
    btn.textContent = "‚úÖ Copi√©";
    setTimeout(()=>{ msg.textContent=""; btn.textContent="üìã Copier l‚Äôadresse"; }, 1200);
  });
})();

/* ================= INIT ================= */
(async function boot(){
  setWalletUIDisconnected();
  $("rpcPill").textContent = readProvider ? "RPC : OK ‚úÖ (quotes sans wallet)" : "RPC : indisponible ‚ùå";
  $("netPill").textContent = "R√©seau : (quotes RPC)";
  $("walletPill").textContent = "Wallet : non connect√©";
  $("plsPill").textContent = "PLS : ‚Äî";
  setConnectedUI(false);

  const tokenlist = await loadPulseXTokenList();
  mergeTokenDataFromList(tokenlist);

  initCardsDefaults();
  document.querySelectorAll(".swapbox").forEach(card => updateQuote(card).catch(()=>{}));
})();
</script>

</body>
</html>
