<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TRINITY Swap ‚Äî PulseChain</title>

  <!-- Ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

  <style>
    :root{
      --bg:#050816;
      --card:#0f172a;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#a855f7;
      --accent2:#ec4899;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --radius:18px;
      --shadow:0 18px 45px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}

    /* ‚úÖ Fond image visible + overlay */
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(11,16,42,.72) 0%, rgba(5,8,22,.78) 55%, rgba(2,6,23,.88) 100%),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.55)),
        url("./bg.png");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
      overflow-x:hidden;
    }

    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:22px 14px 90px}

    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      position:sticky;top:0;z-index:50;
      backdrop-filter: blur(10px);
      background:linear-gradient(180deg, rgba(5,8,22,.85), rgba(5,8,22,.45));
      border-bottom:1px solid rgba(31,41,55,.6);
      padding:14px 10px;margin:-22px -14px 18px;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.4px}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 10px 25px rgba(168,85,247,.25);
    }
    .top-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid rgba(31,41,55,.9);
      background:rgba(2,6,23,.55);
      padding:8px 10px;border-radius:999px;
    }
    .btn{
      cursor:pointer;border:none;
      padding:10px 14px;border-radius:999px;
      background:linear-gradient(120deg,var(--accent),var(--accent2));
      color:#fff;font-weight:900;
      box-shadow:0 12px 30px rgba(236,72,153,.15);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn2{
      cursor:pointer;border:1px solid rgba(31,41,55,.9);
      padding:10px 14px;border-radius:999px;
      background:rgba(2,6,23,.55);
      color:var(--text);font-weight:900;
    }

    .grid2{display:grid;grid-template-columns:1.25fr .75fr;gap:14px;align-items:stretch}
    @media(max-width:980px){.grid2{grid-template-columns:1fr}}

    .card{
      background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.72));
      border:1px solid rgba(31,41,55,.9);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    h1{font-size:34px;line-height:1.05}
    .sub{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.55}
    .hr{height:1px;background:rgba(31,41,55,.7);margin:14px 0}
    .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .chip{
      font-size:12px;color:var(--text);
      border:1px solid rgba(31,41,55,.9);
      background:rgba(2,6,23,.55);
      padding:7px 10px;border-radius:999px;
      display:flex;align-items:center;gap:8px;
    }
    .okdot{width:10px;height:10px;border-radius:999px;background:var(--good);box-shadow:0 0 0 3px rgba(34,197,94,.15)}
    .warnbox{
      border:1px solid rgba(245,158,11,.35);
      background:rgba(245,158,11,.08);
      padding:10px 12px;border-radius:14px;
      font-size:12px;color:var(--muted);
    }
    .ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .ctaRow .btn2, .ctaRow .btn{display:inline-flex;align-items:center;gap:8px}

    .sectionTitle{
      margin-top:18px;font-weight:900;font-size:14px;letter-spacing:.35px;color:var(--text);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .sectionTitle small{color:var(--muted);font-weight:800}

    .swaps{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:12px;padding-bottom:30px}
    @media(max-width:980px){.swaps{grid-template-columns:1fr}}

    label{font-size:12px;color:var(--muted)}
    input,select{
      width:100%;margin-top:6px;
      padding:10px 11px;border-radius:14px;
      background:rgba(2,6,23,.65);
      border:1px solid rgba(31,41,55,.9);
      color:var(--text);outline:none;
    }
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .swap-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .swap-title b{font-size:13px}
    .swap-title span{font-size:12px;color:var(--muted)}
    .switch{display:flex;justify-content:center;margin:10px 0;}
    .switch button{
      border:1px solid rgba(31,41,55,.9);
      background:rgba(2,6,23,.55);
      color:var(--text);border-radius:12px;
      padding:7px 10px;cursor:pointer;
    }
    .balRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px}
    .balText{font-size:12px;color:var(--muted)}
    .maxBtn,.pctBtn{
      border:1px solid rgba(31,41,55,.9);
      background:rgba(2,6,23,.55);
      color:var(--text);
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .maxBtn:disabled,.pctBtn:disabled{opacity:.55;cursor:not-allowed}
    .pctRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .status{margin-top:10px;font-size:12px;color:var(--muted)}
    .status.good{color:var(--good)}
    .status.bad{color:var(--bad)}
    .status.warn{color:var(--warn)}
    .quoteLine{margin-top:8px;font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .txlink{font-weight:900;text-decoration:none;border-bottom:1px dotted rgba(229,231,235,.35)}
    .bottomGrid{display:grid;grid-template-columns:1fr .9fr;gap:14px;margin-top:14px}
    @media(max-width:980px){.bottomGrid{grid-template-columns:1fr}}
    .linkItem{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;border-radius:16px;
      border:1px solid rgba(31,41,55,.9);
      background:rgba(2,6,23,.45);
      margin-top:10px;
    }
    .linkItem b{font-size:13px}
    .linkItem span{display:block;color:var(--muted);font-size:12px;margin-top:2px}
    .linkBtn{padding:8px 12px;border-radius:999px}
    footer{margin-top:26px;text-align:center;color:var(--muted);font-size:11px;line-height:1.6}

    /* TOKEN MODAL */
    #tokenModal{display:none; position:fixed; inset:0; z-index:9999;}
    #tmBackdrop{position:absolute; inset:0; background:rgba(0,0,0,.65);}
    .tmBox{
      position:relative; max-width:720px; margin:4vh auto;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(31,41,55,.9);
      border-radius:18px; box-shadow:0 18px 45px rgba(0,0,0,.55);
      padding:14px;
    }
    .tmTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
    .tmClose{cursor:pointer; border:none; background:transparent; color:#22c55e; font-size:22px; font-weight:900;}
    .tmSearch{
      width:100%; padding:12px 12px; border-radius:14px; outline:none;
      background:rgba(2,6,23,.65); border:1px solid rgba(34,197,94,.45); color:#e5e7eb;
    }
    .tmList{margin-top:10px; max-height:520px; overflow:auto; padding-right:6px;}
    .tmRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px; border-radius:16px; margin-bottom:10px;
      border:1px solid rgba(31,41,55,.9); background:rgba(2,6,23,.45);
      cursor:pointer;
    }
    .tmRow:hover{border-color:rgba(168,85,247,.45)}
    .tmLeft{display:flex;align-items:center;gap:12px;min-width:0}
    .tmIcon{
      width:36px;height:36px;border-radius:999px;flex:0 0 auto;
      border:1px solid rgba(31,41,55,.9);
      background:rgba(2,6,23,.65);
      display:grid;place-items:center;
      overflow:hidden;
    }
    .tmIcon img{width:100%;height:100%;object-fit:cover;display:block}
    .tmSym{font-weight:900}
    .tmMeta{
      color:var(--muted);font-size:12px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:360px
    }
    .tmMid{
      display:flex;flex-direction:column;align-items:flex-end;gap:2px;min-width:120px
    }
    .tmBalLabel{color:var(--muted);font-size:12px}
    .tmBal{font-weight:900}
    .tmActions{display:flex; gap:8px; align-items:center;}
    .tmIconBtn{
      border:1px solid rgba(31,41,55,.9); background:rgba(2,6,23,.55);
      color:#e5e7eb; border-radius:12px; padding:8px 10px; cursor:pointer;
    }
    .tmBottomBar{
      margin-top:10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      color:#9ca3af;font-size:12px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="brand"><div class="logo"></div><div>TRINITY Swap</div></div>
    <div class="top-right">
      <div class="pill" id="netPill">R√©seau : ‚Äî</div>
      <div class="pill" id="walletPill">Wallet : non connect√©</div>
      <button class="btn" id="connectBtn">Connect Wallet</button>
    </div>
  </header>

  <section class="grid2">
    <div class="card">
      <h1>Swap 3 tokens en parall√®le.<br/>Une interface, trois actions.</h1>
      <p class="sub">
        TRINITY = MultiSwap : tu pr√©pares 3 swaps diff√©rents et tu lances chaque swap avec son propre bouton.
        Mode 1 (PulseX-like) : UI au-dessus du router PulseX ‚Ä¢ non-custodial ‚Ä¢ 0 fee TRINITY.
      </p>

      <div class="chips">
        <div class="chip"><span class="okdot"></span>3 swaps ind√©pendants</div>
        <div class="chip"><span class="okdot"></span>Tokenlist PulseX</div>
        <div class="chip"><span class="okdot"></span>Soldes partout</div>
        <div class="chip"><span class="okdot"></span>Approve auto</div>
      </div>

      <div class="ctaRow">
        <button class="btn" id="openMultiBtn">üöÄ Ouvrir le MultiSwap</button>
        <button class="btn2" id="execTrinityBtn" disabled>‚ö° Ex√©cuter TRINITY (A‚ÜíB‚ÜíC)</button>
        <a class="btn2" href="https://whaletrackerio.github.io/autopilot-pulsechain/" target="_blank" rel="noreferrer">‚ö° AutoPilot</a>
        <a class="btn2" href="https://whaletrackerio.github.io/dca-pulsechain/" target="_blank" rel="noreferrer">üìà DCA</a>
      </div>

      <div class="hr"></div>
      <div class="warnbox">‚ö†Ô∏è Teste avec de petits montants. TRINITY ne garde pas tes fonds : c‚Äôest ton wallet qui signe.</div>
    </div>

    <div class="card">
      <div style="font-weight:900;font-size:14px">R√©glages</div>
      <p class="sub">Slippage + deadline pour calculer le minOut sur chaque swap.</p>

      <div class="hr"></div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>Slippage (%)</label>
          <input id="slippage" type="number" min="0" step="0.1" value="2.0" />
        </div>
        <div>
          <label>Deadline (minutes)</label>
          <input id="deadlineM" type="number" min="1" step="1" value="10" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="warnbox">
        Tokenlist : <a class="txlink" target="_blank" rel="noreferrer" href="https://tokens.app.pulsex.com/pulsex-extended-v0.1.2.tokenlist.json">PulseX extended</a>
        ‚Ä¢ Explorer : <a class="txlink" target="_blank" rel="noreferrer" href="https://otter.pulsechain.com/">otter.pulsechain.com</a>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn2" id="refreshBtn">‚Üª Refresh balances/quotes</button>
        <button class="btn2" id="openTokenListBtn">ü™ô Ouvrir la liste tokens</button>
      </div>
    </div>
  </section>

  <div class="sectionTitle" id="multiswap">
    <div>MULTISWAP</div>
    <small>Pr√©pare 3 swaps puis clique sur le bouton de celui que tu veux ex√©cuter.</small>
  </div>

  <section class="swaps" id="swaps"></section>

  <section class="bottomGrid">
    <div class="card">
      <div style="font-weight:900;font-size:14px">Notes</div>
      <p class="sub">
        Mode 1 = pas de fee TRINITY, pas de smart contract maison, chaque swap = 1 transaction.
        Si une quote √©choue, c‚Äôest souvent un manque de liquidit√© sur la paire.
      </p>
      <div class="hr"></div>
      <div class="warnbox">Astuce : utilise ‚ÄúRefresh‚Äù si tu viens de changer de wallet / r√©seau.</div>
    </div>

    <div class="card">
      <div style="font-weight:900;font-size:14px">LIENS RAPIDES</div>

      <div class="linkItem">
        <div><b>PulseX</b><span>Swap officiel PulseChain.</span></div>
        <a class="btn2 linkBtn" href="https://pulsex.com" target="_blank" rel="noreferrer">Ouvrir</a>
      </div>

      <div class="linkItem">
        <div><b>Otter</b><span>Explorer / tx / contrats.</span></div>
        <a class="btn2 linkBtn" href="https://otter.pulsechain.com/" target="_blank" rel="noreferrer">Explorer</a>
      </div>

      <div class="linkItem">
        <div><b>AutoPilot</b><span>Tes bots HEX/ATROPA.</span></div>
        <a class="btn2 linkBtn" href="https://whaletrackerio.github.io/autopilot-pulsechain/" target="_blank" rel="noreferrer">Aller</a>
      </div>

      <div class="linkItem">
        <div><b>DCA PulseChain</b><span>8 bots DCA (achat √† l‚Äôunit√©).</span></div>
        <a class="btn2 linkBtn" href="https://whaletrackerio.github.io/dca-pulsechain/" target="_blank" rel="noreferrer">Aller</a>
      </div>
    </div>
  </section>

  <footer>
    TRINITY Swap ‚Äî PulseChain ‚Ä¢ Mode 1 (PulseX-like) ‚Ä¢ Aucun frais TRINITY<br/>
    Utilise √† tes risques. V√©rifie les adresses et teste petit.
  </footer>

</div>

<!-- TOKEN MODAL -->
<div id="tokenModal">
  <div id="tmBackdrop"></div>
  <div class="tmBox">
    <div class="tmTop">
      <div style="font-weight:900;font-size:18px;">Select a token</div>
      <button class="tmClose" id="tmClose">‚úï</button>
    </div>

    <input class="tmSearch" id="tmSearch" placeholder="Search name or paste address" />

    <div class="tmList" id="tmList"></div>

    <div class="tmBottomBar">
      <button class="btn2" id="tmRefresh">‚Üª Refresh</button>
      <div>üìã copie l‚Äôadresse ‚Ä¢ ü¶ä ajoute √† MetaMask ‚Ä¢ <b>Balance</b> = ton solde</div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const PULSECHAIN_ID = 369;
const PULSECHAIN_HEX = "0x171"; // 369
const TOKENLIST_URL = "https://tokens.app.pulsex.com/pulsex-extended-v0.1.2.tokenlist.json";

const PULSEX_ROUTER = "0x98bf93ebf5c380C0e6Ae8e192A7e2AE08edAcc02";
const WPLS_ADDRESS  = "0xA1077a294dDE1B09bB078844df40758a5D0f9a27";

const PLS_GAS_RESERVE = ethers.parseUnits("0.05", 18);

const ERC20_ABI = [
  "function approve(address spender,uint256 amount) external returns (bool)",
  "function allowance(address owner,address spender) external view returns (uint256)",
  "function balanceOf(address owner) external view returns (uint256)",
  "function decimals() external view returns (uint8)",
  "function symbol() external view returns (string)",
  "function name() external view returns (string)"
];
const ROUTER_ABI = [
  "function getAmountsOut(uint256 amountIn, address[] calldata path) external view returns (uint256[] memory amounts)",
  "function swapExactTokensForTokens(uint256 amountIn,uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) external returns (uint256[] memory amounts)",
  "function swapExactETHForTokens(uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) external payable returns (uint256[] memory amounts)",
  "function swapExactTokensForETH(uint256 amountIn,uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) external returns (uint256[] memory amounts)"
];

/* ================= TES TOKENS CUSTOM (2 blocs) =================
   => Ajout√©s en plus de la tokenlist PulseX
   (Si PulseX les a d√©j√†, on garde l‚Äôentr√©e PulseX.)
*/
const CUSTOM_TOKENS = [
  // bloc 1
  { symbol:"EHEX", address:"0x57fde0a71132198BBeC939B98976993d8D89D225" },
  { symbol:"INC",  address:"0x2fa878Ab3F87CC1C9737Fc071108F904c0B0C95d" },
  { symbol:"DAI",  address:"0xefD766cCb38EaF1dfd701853BFCe31359239F305" },
  { symbol:"USDC", address:"0x15D38573d2feeb82e7ad5187aB8c1D52810B1f07" },
  { symbol:"WETH", address:"0x02DcdD04e3F455D838cd1249292C58f3B79e3C3C" },
  { symbol:"AXIS", address:"0x8BDB63033b02C15f113De51EA1C3a96Af9e8ecb5" },
  { symbol:"BANANAS", address:"0xC6B28B2E3Bf9fF26299D540a4D654F7ade4dFdB0" },
  { symbol:"CST", address:"0x600136dA8cc6D1Ea07449514604dc4ab7098dB82" },
  { symbol:"EARN", address:"0xb513038BbFdF9D40B676F41606f4F61D4b02c4A2" },
  { symbol:"ELIXIR", address:"0xeCd465A15fac825B0Fe69416A4c7BfE03A50c12E" },
  { symbol:"HDRN", address:"0x3819f64f282bf135d62168C1e513280dAF905e06" },
  { symbol:"HELGO", address:"0x0567CA0dE35606E9C260CC2358404B11DE21DB44" },
  { symbol:"IM", address:"0xBBcF895BFCb57d0f457D050bb806d1499436c0CE" },
  { symbol:"LINK", address:"0x514910771AF9Ca656af840dff83E8264EcF986CA" },
  { symbol:"pBSKR", address:"0x1DcbF345bC44696BbBed402367f7C62e524Fe8B5" },
  { symbol:"PEPE", address:"0x6982508145454Ce325dDbE47a25d4ec3d2311933" },

  // bloc 2
  { symbol:"LOAN", address:"0x9159f1D2a9f51998Fc9Ab03fbd8f265ab14A1b3B" },
  { symbol:"PHUX", address:"0x9663c2d75ffd5F4017310405fCe61720aF45B829" },
  { symbol:"PRS", address:"0xb6B57227150a7097723e0C013752001AaD01248F" },
  { symbol:"pTGC", address:"0x94534EeEe131840b1c0F61847c572228bdfDDE93" },
  { symbol:"PTS", address:"0x2A06a971fE6ffa002fd242d437E3db2b5cC5B433" },
  { symbol:"PXDC", address:"0xeB6b7932Da20c6D7B3a899D5887d86dfB09A6408" },
  { symbol:"RFX", address:"0xF876BDf9D6403AA7D5bF7F523E8f440A841CC596" },
  { symbol:"SHIB", address:"0x95aD61b0a150d79219dCF64E1E6Cc01f0B64C4cE" },
  { symbol:"SOUNDX", address:"0xA301c1871Dbf414261946281C7F62213fae22CfE" },
  { symbol:"TETRAp", address:"0xAeC4C07537B03E3E62fc066EC62401Aed5Fdd361" },
  { symbol:"TEXAN", address:"0xcFCFfE432A48dB53F59c301422d2EdD77B2A88d7" },
  { symbol:"TIME", address:"0xCA35638A3fdDD02fEC597D8c1681198C06b23F58" },
  { symbol:"UFO", address:"0x456548A9B56eFBbD89Ca0309edd17a9E20b04018" },
  { symbol:"UNI", address:"0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984" },
  { symbol:"USDL", address:"0x0dEEd1486bc52aA0d3E6f8849cEC5adD6598A162" },
  { symbol:"USDT", address:"0xdAC17F958D2ee523a2206206994597C13D831ec7" },
  { symbol:"VORTEX", address:"0x73d8a4D01d658E565cF83068397FD39Baf386C48" },
  { symbol:"WATT", address:"0xDfdc2836FD2E63Bba9f0eE07901aD465Bff4DE71" },
  { symbol:"WBTC", address:"0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599" },
];

/* ================= HELPERS ================= */
const $ = (id) => document.getElementById(id);
function shortAddr(a){ return a ? (a.slice(0,6)+"‚Ä¶"+a.slice(-4)) : ""; }
function nowTs(){ return Math.floor(Date.now()/1000); }

function normalizeLogo(uri){
  if(!uri) return "";
  // ipfs://CID/... => gateway
  if(uri.startsWith("ipfs://")){
    return "https://ipfs.io/ipfs/" + uri.replace("ipfs://","").replace(/^ipfs\//,"");
  }
  return uri;
}
function safeAddr(a){
  try { return ethers.getAddress(a); } catch { return null; }
}
function setStatus(card, txt, cls=""){
  const el = card.querySelector(".status");
  el.className = "status" + (cls ? " "+cls : "");
  el.textContent = txt;
}
function getSettings(){
  const sl = parseFloat($("slippage").value || "2");
  const dl = parseInt($("deadlineM").value || "10", 10);
  return { slippage: Math.max(0, sl), deadlineMin: Math.max(1, dl) };
}
function txUrl(hash){ return `https://otter.pulsechain.com/tx/${hash}`; }

function formatUnitsSmart(raw, decimals){
  try{
    const s = ethers.formatUnits(raw, decimals);
    const num = Number(s);
    if(!isFinite(num)) return s;
    if(num === 0) return "0";
    if(num < 0.0001) return num.toExponential(3);
    return num.toLocaleString(undefined, { maximumFractionDigits: 6 });
  }catch{
    return "‚Äî";
  }
}

/* ================= STATE ================= */
let provider, signer, userAddress, networkOk = false;

/* TOKENS STORE
   key by addressLower (ERC20) + special key "native:PLS"
*/
const TOKENS = new Map(); // key -> token
function keyForToken(t){
  if(t.isNative) return "native:PLS";
  return (t.address||"").toLowerCase();
}
function upsertToken(t){
  const k = keyForToken(t);
  const prev = TOKENS.get(k);
  // Priorit√© √† PulseX tokenlist si logoURI existant etc.
  // Si prev vient de PulseX (source="pulsex") on ne l‚Äô√©crase pas par custom.
  if(prev && prev.source === "pulsex" && t.source === "custom") return;
  TOKENS.set(k, { ...prev, ...t });
}
function getTokenBySymbol(sym){
  sym = (sym||"").toUpperCase();
  if(sym === "PLS") return TOKENS.get("native:PLS");
  for(const t of TOKENS.values()){
    if((t.symbol||"").toUpperCase() === sym) return t;
  }
  return null;
}
function getTokenByAddress(addr){
  const a = (addr||"").toLowerCase();
  return TOKENS.get(a) || null;
}

const balanceCache = new Map(); // key -> { raw: bigint, ts: number }
const decimalsCache = new Map(); // addressLower -> decimals

/* ================= WEB3 ================= */
function getRouter(readOnly=true){
  return new ethers.Contract(PULSEX_ROUTER, ROUTER_ABI, readOnly ? provider : signer);
}
function getErc20(tokenAddr, readOnly=true){
  return new ethers.Contract(ethers.getAddress(tokenAddr), ERC20_ABI, readOnly ? provider : signer);
}

/* ================= TOKENLIST LOAD (PulseX) ================= */
async function loadTokenList(){
  // Native PLS
  upsertToken({
    isNative:true,
    symbol:"PLS",
    name:"PulseChain",
    decimals:18,
    logoURI:"", // pas dans tokenlist
    source:"native"
  });

  // WPLS (important)
  upsertToken({
    address: WPLS_ADDRESS,
    symbol:"WPLS",
    name:"Wrapped PLS",
    decimals:18,
    logoURI:"",
    source:"native"
  });

  // Custom tokens (en attente de merge)
  for(const ct of CUSTOM_TOKENS){
    const a = safeAddr(ct.address);
    if(!a) continue;
    upsertToken({
      address:a,
      symbol:(ct.symbol||"").trim(),
      name:ct.symbol,
      decimals:null, // on r√©cup√®re on-chain si besoin
      logoURI:"",
      source:"custom"
    });
  }

  // PulseX tokenlist
  try{
    const r = await fetch(TOKENLIST_URL, { cache:"no-store" });
    const j = await r.json();
    const list = Array.isArray(j.tokens) ? j.tokens : [];
    const seen = new Set(); // dedupe by address lower

    for(const it of list){
      if(!it || !it.address) continue;
      // certaines tokenlists contiennent chainId, on garde PulseChain si pr√©sent
      if(it.chainId && Number(it.chainId) !== PULSECHAIN_ID) continue;

      const addr = safeAddr(it.address);
      if(!addr) continue;
      const key = addr.toLowerCase();
      if(seen.has(key)) continue; // ‚úÖ plus de doubles lignes
      seen.add(key);

      upsertToken({
        address: addr,
        symbol: (it.symbol || "").trim(),
        name: (it.name || it.symbol || "").trim(),
        decimals: (typeof it.decimals === "number" ? it.decimals : null),
        logoURI: normalizeLogo(it.logoURI || ""),
        source:"pulsex"
      });

      // Si c‚Äôest WPLS on met bien l‚Äôadresse (au cas o√π)
      if(addr.toLowerCase() === WPLS_ADDRESS.toLowerCase()){
        // ok
      }
    }

  }catch(e){
    console.error("Tokenlist load error:", e);
  }

  // si WPLS n‚Äôa pas de logo, tente de le r√©cup√©rer via tokenlist par adresse
  const wpls = getTokenByAddress(WPLS_ADDRESS);
  if(wpls && !wpls.logoURI){
    // nothing
  }

  renderAllSelects();
  renderTokenList("");
}

/* ================= BALANCES / DECIMALS ================= */
async function getDecimalsFor(token){
  if(token.isNative) return 18;
  const k = token.address.toLowerCase();
  if(typeof token.decimals === "number") return token.decimals;
  if(decimalsCache.has(k)) return decimalsCache.get(k);

  // lecture on-chain
  try{
    const erc = getErc20(token.address, true);
    const d = await erc.decimals();
    const dn = Number(d);
    if(Number.isFinite(dn)){
      decimalsCache.set(k, dn);
      token.decimals = dn;
      upsertToken(token);
      return dn;
    }
  }catch(e){
    // si token non ERC20 / pas sur chain => fallback 18
  }
  decimalsCache.set(k, 18);
  token.decimals = 18;
  upsertToken(token);
  return 18;
}

async function getBalanceRaw(token){
  if(!networkOk || !userAddress || !provider) return null;

  const k = keyForToken(token);
  const cached = balanceCache.get(k);
  if(cached && (Date.now() - cached.ts) < 8000) return cached.raw;

  try{
    let raw;
    if(token.isNative){
      raw = await provider.getBalance(userAddress);
    }else{
      const erc = getErc20(token.address, true);
      raw = await erc.balanceOf(userAddress);
    }
    balanceCache.set(k, { raw, ts: Date.now() });
    return raw;
  }catch(e){
    // token pas sur PulseChain ou autre => null
    return null;
  }
}

async function getBalanceFormatted(token){
  const raw = await getBalanceRaw(token);
  if(raw === null) return "‚Äî";
  const d = await getDecimalsFor(token);
  return formatUnitsSmart(raw, d);
}

/* ================= UI BUILD SWAPS ================= */
const swapsEl = $("swaps");

function swapCardTemplate(i, label){
  return `
    <div class="card swapbox" id="swap${i}">
      <div class="swap-title">
        <b>${label}</b>
        <span>TX #${i}</span>
      </div>

      <label>Tu payes</label>
      <div class="row2">
        <select class="from"></select>
        <input class="amount" inputmode="decimal" placeholder="Montant" />
      </div>

      <div class="balRow">
        <div class="balText">Balance: <span class="balIn">‚Äî</span></div>
        <button class="maxBtn" type="button" disabled>MAX</button>
      </div>

      <div class="pctRow">
        <button class="pctBtn" type="button" data-p="25" disabled>25%</button>
        <button class="pctBtn" type="button" data-p="50" disabled>50%</button>
        <button class="pctBtn" type="button" data-p="75" disabled>75%</button>
      </div>

      <div class="switch"><button class="invert" title="Inverser">‚Üï</button></div>

      <label>Tu re√ßois</label>
      <div class="row2">
        <select class="to"></select>
        <input class="out" placeholder="Estimation" readonly />
      </div>

      <div class="quoteLine">
        <span>Quote:</span>
        <span class="quoteText">‚Äî</span>
      </div>

      <div class="actions">
        <button class="btn2 approveBtn" style="display:none" disabled>Approve</button>
        <button class="btn swapBtn" disabled>Ex√©cuter ${label}</button>
      </div>

      <div class="status">Ready (connect wallet)</div>
      <div class="quoteLine" style="margin-top:10px">
        <a class="txlink txA" target="_blank" rel="noreferrer" style="display:none">Voir TX</a>
      </div>
    </div>
  `;
}

swapsEl.insertAdjacentHTML("beforeend", swapCardTemplate(1,"Swap A"));
swapsEl.insertAdjacentHTML("beforeend", swapCardTemplate(2,"Swap B"));
swapsEl.insertAdjacentHTML("beforeend", swapCardTemplate(3,"Swap C"));

function tokenOptionsSorted(){
  const arr = Array.from(TOKENS.values());
  // PLS en premier, WPLS ensuite, puis tri alpha symbol
  arr.sort((a,b)=>{
    const sa = (a.symbol||"").toUpperCase();
    const sb = (b.symbol||"").toUpperCase();
    const rank = (t)=>{
      if(t.isNative) return 0;
      if((t.address||"").toLowerCase() === WPLS_ADDRESS.toLowerCase()) return 1;
      return 2;
    };
    const ra = rank(a), rb = rank(b);
    if(ra !== rb) return ra - rb;
    return sa.localeCompare(sb);
  });
  return arr;
}

function fillSelect(sel, selectedSym){
  const selected = (selectedSym||"").toUpperCase();
  sel.innerHTML = "";
  const opts = tokenOptionsSorted();
  for(const t of opts){
    const opt = document.createElement("option");
    opt.value = (t.symbol||"").toUpperCase();
    opt.textContent = (t.symbol||"").toUpperCase();
    sel.appendChild(opt);
  }
  sel.value = selected || "PLS";
}

function renderAllSelects(){
  const defaults = [
    {from:"PLS",  to:"PHEX"},
    {from:"PLS",  to:"ATROPA"},
    {from:"PHEX", to:"PLSX"},
  ];
  document.querySelectorAll(".swapbox").forEach((card, idx)=>{
    const fromSel = card.querySelector(".from");
    const toSel   = card.querySelector(".to");
    fillSelect(fromSel, defaults[idx].from);
    fillSelect(toSel, defaults[idx].to);
  });
}

function initSwapEvents(){
  document.querySelectorAll(".swapbox").forEach((card)=>{
    const fromSel = card.querySelector(".from");
    const toSel   = card.querySelector(".to");

    card.querySelector(".invert").addEventListener("click", ()=>{
      const a = fromSel.value;
      fromSel.value = toSel.value;
      toSel.value = a;
      triggerQuote(card);
      refreshCardBalance(card).catch(()=>{});
    });

    fromSel.addEventListener("change", ()=>{
      refreshCardBalance(card).catch(()=>{});
      triggerQuote(card);
    });
    toSel.addEventListener("change", ()=> triggerQuote(card));
    card.querySelector(".amount").addEventListener("input", ()=> triggerQuote(card));
  });

  document.querySelectorAll(".swapbox").forEach(card=>{
    card.querySelector(".maxBtn").addEventListener("click", ()=> setAmountFromPercent(card, 100).catch(console.error));
    card.querySelectorAll(".pctBtn").forEach(b=>{
      b.addEventListener("click", ()=> setAmountFromPercent(card, parseInt(b.dataset.p,10)).catch(console.error));
    });
    card.querySelector(".swapBtn").addEventListener("click", ()=> executeSwap(card));
  });
}
initSwapEvents();

/* ================= CONNECT UI ================= */
function setConnectedUI(isOk){
  document.querySelectorAll(".swapBtn").forEach(b => b.disabled = !isOk);
  document.querySelectorAll(".approveBtn").forEach(b => b.disabled = !isOk);
  document.querySelectorAll(".maxBtn").forEach(b => b.disabled = !isOk);
  document.querySelectorAll(".pctBtn").forEach(b => b.disabled = !isOk);
  $("execTrinityBtn").disabled = !isOk;

  document.querySelectorAll(".swapbox").forEach(card => {
    const bal = card.querySelector(".balIn");
    bal.textContent = isOk ? "‚Äî" : "Connect wallet";
    if(!isOk) setStatus(card, "Ready (connect wallet)", "");
  });
}

/* ================= SCROLL BTN ================= */
$("openMultiBtn").addEventListener("click", ()=>{
  $("multiswap").scrollIntoView({behavior:"smooth", block:"start"});
  window.scrollBy(0, -90);
});

/* ================= WEB3 CONNECT ================= */
async function connectWallet(){
  if(!window.ethereum){
    alert("Wallet requis : MetaMask");
    return;
  }

  await window.ethereum.request({ method:"eth_requestAccounts" });
  provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();
  userAddress = await signer.getAddress();

  const net = await provider.getNetwork();
  let ok = (Number(net.chainId) === PULSECHAIN_ID);

  if(!ok){
    try{
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: PULSECHAIN_HEX }]
      });
      const net2 = await provider.getNetwork();
      ok = (Number(net2.chainId) === PULSECHAIN_ID);
    }catch(e){
      console.error(e);
    }
  }

  networkOk = ok;
  $("walletPill").textContent = "Wallet : " + shortAddr(userAddress);
  $("netPill").textContent = "R√©seau : " + (ok ? "PulseChain ‚úÖ" : "Mauvais r√©seau ‚ùå");

  // bouton devient adresse + copie
  const btn = $("connectBtn");
  btn.textContent = shortAddr(userAddress);
  btn.onclick = async () => {
    await navigator.clipboard.writeText(userAddress);
    alert("Adresse copi√©e ‚úÖ");
  };

  setConnectedUI(ok);

  if(!ok){
    alert("Passe sur PulseChain (chainId 369) puis reconnecte.");
    return;
  }

  await refreshAll();

  window.ethereum.on?.("accountsChanged", ()=> location.reload());
  window.ethereum.on?.("chainChanged", ()=> location.reload());
}
$("connectBtn").addEventListener("click", connectWallet);
$("refreshBtn").addEventListener("click", ()=> refreshAll());
$("openTokenListBtn").addEventListener("click", ()=>{
  openTokenModal(null, null); // mode ‚Äúliste‚Äù
});

/* ================= BALANCES IN SWAPS ================= */
async function refreshCardBalance(card){
  const balEl = card.querySelector(".balIn");
  if(!networkOk || !userAddress){
    balEl.textContent = "Connect wallet";
    return;
  }
  const fromSym = (card.querySelector(".from").value||"PLS").toUpperCase();
  const t = getTokenBySymbol(fromSym);
  if(!t){
    balEl.textContent = "‚Äî";
    return;
  }
  balEl.textContent = await getBalanceFormatted(t);
}

async function refreshAll(){
  balanceCache.clear();
  // balances swaps
  const cards = document.querySelectorAll(".swapbox");
  for(const card of cards){
    await refreshCardBalance(card);
    await updateQuote(card);
  }
  // balances token modal si ouverte
  if($("tokenModal").style.display === "block"){
    await renderTokenList(($("tmSearch").value||"").trim(), true);
  }
}

/* ================= MAX + % ================= */
function validatePair(card){
  const from = card.querySelector(".from").value;
  const to = card.querySelector(".to").value;
  if(from === to){
    setStatus(card, "Paire invalide (tokens identiques)", "bad");
    return false;
  }
  return true;
}

async function setAmountFromPercent(card, pct){
  if(!networkOk) return alert("Connecte ton wallet d‚Äôabord");
  if(!validatePair(card)) return;

  const fromSym = (card.querySelector(".from").value||"PLS").toUpperCase();
  const t = getTokenBySymbol(fromSym);
  if(!t) return;

  let balRaw = await getBalanceRaw(t);
  if(balRaw === null) return alert("Impossible de lire le solde (token ?)");

  // r√©serve gas pour PLS
  if(t.isNative){
    if(balRaw <= PLS_GAS_RESERVE){
      alert("Balance PLS insuffisante pour le gas");
      return;
    }
    balRaw = balRaw - PLS_GAS_RESERVE;
  }

  const amount = balRaw * BigInt(pct) / 100n;
  const d = await getDecimalsFor(t);
  card.querySelector(".amount").value = ethers.formatUnits(amount, d);
  await updateQuote(card);
}

/* ================= PATH / QUOTES / SWAPS ================= */
function buildPath(symIn, symOut){
  symIn = (symIn||"").toUpperCase();
  symOut = (symOut||"").toUpperCase();
  if(symIn === symOut) return null;

  const inT  = getTokenBySymbol(symIn);
  const outT = getTokenBySymbol(symOut);
  if(!inT || !outT) return null;

  // PLS natif => WPLS
  if(symIn === "PLS"){
    if(outT.isNative) return null;
    return [ ethers.getAddress(WPLS_ADDRESS), ethers.getAddress(outT.address) ];
  }
  if(symOut === "PLS"){
    if(inT.isNative) return null;
    return [ ethers.getAddress(inT.address), ethers.getAddress(WPLS_ADDRESS) ];
  }
  // ERC20 -> ERC20 direct
  if(!inT.address || !outT.address) return null;
  return [ ethers.getAddress(inT.address), ethers.getAddress(outT.address) ];
}

function parseAmount(sym, human){
  const t = getTokenBySymbol(sym);
  const d = (t && typeof t.decimals === "number") ? t.decimals : 18;
  return ethers.parseUnits(human, d);
}

function formatAmount(sym, raw){
  const t = getTokenBySymbol(sym);
  const d = (t && typeof t.decimals === "number") ? t.decimals : 18;
  return formatUnitsSmart(raw, d);
}

/* ================= APPROVE ================= */
async function checkAllowance(symIn, amountRaw){
  symIn = (symIn||"").toUpperCase();
  if(symIn === "PLS") return true;
  const t = getTokenBySymbol(symIn);
  if(!t || !t.address) return false;
  const allowance = await getErc20(t.address, true).allowance(userAddress, PULSEX_ROUTER);
  return allowance >= amountRaw;
}
async function doApprove(symIn, card){
  const t = getTokenBySymbol(symIn);
  if(!t || !t.address) return;
  const erc = getErc20(t.address, false);
  setStatus(card, "Approving‚Ä¶ (MetaMask)", "warn");
  const tx = await erc.approve(PULSEX_ROUTER, ethers.MaxUint256);
  setStatus(card, "Approve pending‚Ä¶", "warn");
  await tx.wait();
  setStatus(card, "Approve OK ‚úÖ", "good");
}

/* ================= QUOTE ================= */
let quoteTimer = null;
function triggerQuote(card){
  if(quoteTimer) clearTimeout(quoteTimer);
  quoteTimer = setTimeout(()=> updateQuote(card).catch(()=>{}), 250);
}

async function updateQuote(card){
  const from = (card.querySelector(".from").value||"").toUpperCase();
  const to   = (card.querySelector(".to").value||"").toUpperCase();
  const amt  = (card.querySelector(".amount").value || "").trim();

  const outInp = card.querySelector(".out");
  const quoteText = card.querySelector(".quoteText");
  const approveBtn = card.querySelector(".approveBtn");

  outInp.value = "";
  quoteText.textContent = "‚Äî";
  approveBtn.style.display = "none";

  if(!networkOk || !userAddress){
    setStatus(card, "Ready (connect wallet)", "");
    return;
  }
  if(!amt || Number(amt) <= 0){
    setStatus(card, "Ready ‚úÖ", "good");
    return;
  }
  if(!validatePair(card)) return;

  try{
    setStatus(card, "Quoting‚Ä¶", "warn");

    // decimals assur√©s
    const inT = getTokenBySymbol(from);
    const outT = getTokenBySymbol(to);
    if(!inT || !outT) throw new Error("token missing");
    inT.decimals = await getDecimalsFor(inT);
    outT.decimals = await getDecimalsFor(outT);

    const amountIn = ethers.parseUnits(amt, inT.decimals);
    const path = buildPath(from, to);
    if(!path) throw new Error("Invalid path");

    const router = getRouter(true);
    const amounts = await router.getAmountsOut(amountIn, path);
    const outRaw = amounts[amounts.length - 1];

    outInp.value = formatUnitsSmart(outRaw, outT.decimals);
    quoteText.textContent = `${amt} ${from} ‚Üí ~${formatUnitsSmart(outRaw, outT.decimals)} ${to}`;

    if(from !== "PLS"){
      const ok = await checkAllowance(from, amountIn);
      if(!ok){
        approveBtn.style.display = "inline-flex";
        approveBtn.disabled = false;
        approveBtn.textContent = "Approve " + from;
        approveBtn.onclick = async ()=>{
          try{
            await doApprove(from, card);
            await updateQuote(card);
          }catch(e){
            console.error(e);
            setStatus(card, "Approve error", "bad");
          }
        };
        setStatus(card, "Allowance insuffisante ‚Üí Approve requis", "warn");
        return;
      }
    }

    setStatus(card, "Ready ‚úÖ", "good");
  }catch(e){
    console.error(e);
    setStatus(card, "Quote error (liquidit√©/pair ?)", "bad");
  }
}

/* ================= SWAP EXECUTION ================= */
async function executeSwap(card){
  if(!networkOk || !userAddress) return alert("Connecte ton wallet sur PulseChain");

  const from = (card.querySelector(".from").value||"").toUpperCase();
  const to   = (card.querySelector(".to").value||"").toUpperCase();
  const amt  = (card.querySelector(".amount").value || "").trim();
  const txLink = card.querySelector(".txA");
  txLink.style.display = "none";

  if(!validatePair(card)) return;
  if(!amt || Number(amt) <= 0){
    setStatus(card, "Montant manquant", "bad");
    return;
  }

  const { slippage, deadlineMin } = getSettings();

  try{
    const inT = getTokenBySymbol(from);
    const outT = getTokenBySymbol(to);
    if(!inT || !outT) throw new Error("token missing");

    inT.decimals = await getDecimalsFor(inT);
    outT.decimals = await getDecimalsFor(outT);

    const routerWrite = getRouter(false);
    const routerRead  = getRouter(true);

    const amountIn = ethers.parseUnits(amt, inT.decimals);
    const path = buildPath(from, to);

    if(from !== "PLS"){
      const ok = await checkAllowance(from, amountIn);
      if(!ok) await doApprove(from, card);
    }

    setStatus(card, "Calcul minOut‚Ä¶", "warn");
    const amounts = await routerRead.getAmountsOut(amountIn, path);
    const outRaw  = amounts[amounts.length - 1];

    const bps = Math.round(slippage * 100); // 2.0% => 200 bps
    const minOut = outRaw * BigInt(10000 - bps) / 10000n;
    const deadline = nowTs() + (deadlineMin * 60);

    let tx;
    setStatus(card, "Signature (MetaMask)‚Ä¶", "warn");

    if(from === "PLS"){
      tx = await routerWrite.swapExactETHForTokens(minOut, path, userAddress, deadline, { value: amountIn });
    }else if(to === "PLS"){
      tx = await routerWrite.swapExactTokensForETH(amountIn, minOut, path, userAddress, deadline);
    }else{
      tx = await routerWrite.swapExactTokensForTokens(amountIn, minOut, path, userAddress, deadline);
    }

    setStatus(card, "Pending‚Ä¶", "warn");
    txLink.href = txUrl(tx.hash);
    txLink.textContent = "Voir TX";
    txLink.style.display = "inline-flex";

    await tx.wait();

    setStatus(card, "Success ‚úÖ", "good");
    await refreshAll();

  }catch(e){
    console.error(e);
    setStatus(card, "Swap error (cancel ? liquidit√© ?)", "bad");
  }
}

/* ================= EXECUTE TRINITY (A‚ÜíB‚ÜíC) ================= */
$("execTrinityBtn").addEventListener("click", async ()=>{
  if(!networkOk) return alert("Connecte ton wallet sur PulseChain");
  const cards = [ $("swap1"), $("swap2"), $("swap3") ];

  $("multiswap").scrollIntoView({behavior:"smooth", block:"start"});
  window.scrollBy(0, -90);

  for(const card of cards){
    const amt = (card.querySelector(".amount").value || "").trim();
    const from = (card.querySelector(".from").value||"").toUpperCase();
    const to = (card.querySelector(".to").value||"").toUpperCase();

    if(!amt || Number(amt) <= 0){
      setStatus(card, "Skip (montant vide)", "");
      continue;
    }
    if(from === to){
      setStatus(card, "Skip (tokens identiques)", "bad");
      continue;
    }

    await executeSwap(card);

    const st = (card.querySelector(".status").textContent || "").toLowerCase();
    if(st.includes("error")){
      alert("TRINITY stopp√© (erreur sur un swap).");
      break;
    }
  }
});

/* ================= Token modal PulseX-like ================= */
let tokenModalTarget = null; // { card, side } ou null
function openTokenModal(card, side){
  tokenModalTarget = (card && side) ? { card, side } : null;
  $("tokenModal").style.display = "block";
  $("tmSearch").value = "";
  renderTokenList("");
  setTimeout(()=>$("tmSearch").focus(), 50);
}
function closeTokenModal(){
  $("tokenModal").style.display = "none";
  tokenModalTarget = null;
}
$("tmClose").onclick = closeTokenModal;
$("tmBackdrop").onclick = closeTokenModal;
$("tmSearch").addEventListener("input", (e)=> renderTokenList((e.target.value||"").trim()));
$("tmRefresh").addEventListener("click", ()=> refreshAll());

function isAddr(x){ return /^0x[a-fA-F0-9]{40}$/.test(x); }
function norm(x){ return (x||"").toLowerCase(); }

async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); }
  catch{
    const ta=document.createElement("textarea");
    ta.value=txt; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
  }
}

async function addTokenToMetaMask(token){
  if(!window.ethereum) return alert("MetaMask requis");
  if(token.isNative) return alert("PLS = token natif (pas ERC20)");

  const dec = await getDecimalsFor(token);

  try{
    const wasAdded = await window.ethereum.request({
      method: "wallet_watchAsset",
      params: {
        type: "ERC20",
        options: {
          address: token.address,
          symbol: (token.symbol||"").slice(0,11),
          decimals: dec,
          image: token.logoURI || undefined
        }
      }
    });

    if(wasAdded){
      alert("Token ajout√© ‚úÖ");
    }else{
      alert("Ajout refus√© (cancel)");
    }
  }catch(e){
    console.error(e);
    try{ await copyText(token.address); }catch(_){}
    alert("Impossible d‚Äôajouter automatiquement.\n‚úÖ Adresse copi√©e.\n‚û°Ô∏è Ajoute-la via Import token dans MetaMask.");
    window.open("https://otter.pulsechain.com/address/" + token.address, "_blank");
  }
}

function tokenMatchesQuery(t, q){
  if(!q) return true;
  const nq = norm(q);
  if(isAddr(q)){
    if(t.isNative) return false;
    return norm(t.address) === nq;
  }
  return norm(t.symbol).includes(nq) || norm(t.name).includes(nq);
}

async function renderTokenList(q, forceBalances=false){
  const list = $("tmList");
  const tokens = tokenOptionsSorted().filter(t=>tokenMatchesQuery(t,q));

  list.innerHTML = tokens.map(t=>{
    const sym = (t.symbol||"").toUpperCase();
    const addr = t.isNative ? "Native ‚Ä¢ PulseChain" : (shortAddr(t.address) + (t.name ? " ‚Ä¢ " + t.name : ""));
    const showBtns = !t.isNative;
    const logo = t.logoURI ? `<img src="${t.logoURI}" alt="${sym}" onerror="this.remove();">` : `<span style="font-weight:900;color:#cbd5e1">${sym.slice(0,1)}</span>`;
    return `
      <div class="tmRow" data-key="${keyForToken(t)}">
        <div class="tmLeft">
          <div class="tmIcon">${logo}</div>
          <div style="min-width:0">
            <div class="tmSym">${sym}</div>
            <div class="tmMeta">${addr}</div>
          </div>
        </div>

        <div class="tmMid">
          <div class="tmBalLabel">Balance</div>
          <div class="tmBal" data-bal="${keyForToken(t)}">‚Äî</div>
        </div>

        <div class="tmActions">
          ${showBtns ? `
            <button class="tmIconBtn tmCopy" title="Copy address">üìã</button>
            <button class="tmIconBtn tmAdd" title="Add to MetaMask">ü¶ä</button>
          ` : ``}
        </div>
      </div>
    `;
  }).join("");

  // events
  list.querySelectorAll(".tmRow").forEach(row=>{
    row.addEventListener("click", async (e)=>{
      if(e.target.classList.contains("tmCopy") || e.target.classList.contains("tmAdd")) return;

      const key = row.dataset.key;
      const token = (key === "native:PLS") ? TOKENS.get("native:PLS") : TOKENS.get(key);
      if(!token) return;

      if(!tokenModalTarget){
        // mode ‚Äúliste‚Äù seulement
        return;
      }
      const { card, side } = tokenModalTarget;
      const sel = card.querySelector(side === "from" ? ".from" : ".to");
      sel.value = (token.symbol||"PLS").toUpperCase();
      closeTokenModal();
      await refreshCardBalance(card).catch(()=>{});
      await updateQuote(card).catch(()=>{});
    });
  });

  list.querySelectorAll(".tmCopy").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      const row = btn.closest(".tmRow");
      const key = row.dataset.key;
      const token = (key === "native:PLS") ? TOKENS.get("native:PLS") : TOKENS.get(key);
      if(!token || token.isNative) return;
      await copyText(token.address);
      btn.textContent="‚úÖ";
      setTimeout(()=>btn.textContent="üìã", 700);
    });
  });

  list.querySelectorAll(".tmAdd").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      const row = btn.closest(".tmRow");
      const key = row.dataset.key;
      const token = (key === "native:PLS") ? TOKENS.get("native:PLS") : TOKENS.get(key);
      if(!token) return;
      await addTokenToMetaMask(token);
    });
  });

  // balances
  if(networkOk && userAddress){
    // petit throttling : on affiche vite PLS/WPLS + tokens visibles
    const balanceEls = list.querySelectorAll("[data-bal]");
    for(const el of balanceEls){
      const key = el.getAttribute("data-bal");
      const token = (key === "native:PLS") ? TOKENS.get("native:PLS") : TOKENS.get(key);
      if(!token) continue;
      // lecture balance
      getBalanceFormatted(token).then(v=>{ el.textContent = v; }).catch(()=>{ el.textContent = "‚Äî"; });
    }
  }else{
    // pas connect√©
    list.querySelectorAll("[data-bal]").forEach(el=> el.textContent = "‚Äî");
  }
}

// Hook : ouvrir modal au clic sur les selects (PulseX-like)
document.querySelectorAll(".swapbox").forEach(card=>{
  const fromSel = card.querySelector(".from");
  const toSel   = card.querySelector(".to");
  fromSel.addEventListener("mousedown", (e)=>{ e.preventDefault(); openTokenModal(card,"from"); });
  toSel.addEventListener("mousedown", (e)=>{ e.preventDefault(); openTokenModal(card,"to"); });
});

/* ================= INIT ================= */
setConnectedUI(false);
loadTokenList().then(()=>{
  // defaults + refresh balances placeholders
  const cards = document.querySelectorAll(".swapbox");
  cards.forEach(c=>{ refreshCardBalance(c).catch(()=>{}); updateQuote(c).catch(()=>{}); });
});
</script>
</body>
</html>
