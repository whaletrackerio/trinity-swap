<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TRINITY Swap ‚Äî PulseChain</title>

  <!-- Ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

  <style>
    :root{
      --bg:#050816;
      --card:#0f172a;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#a855f7;
      --accent2:#ec4899;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --radius:18px;
      --shadow:0 18px 45px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html, body{height:100%; background:#020617;}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      min-height:100vh;
      overflow-x:hidden;
      position:relative;
    }

    /* ‚úÖ FOND BG VISIBLE (pas ‚Äúmang√©‚Äù par un overlay trop opaque) */
    body::before{
      content:"";
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(11,16,42,.55) 0%, rgba(5,8,22,.55) 55%, rgba(2,6,23,.65) 100%),
        url("./bg.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: saturate(1.12) contrast(1.05);
      opacity:.62; /* ‚Üê rend l‚Äôimage VRAIMENT visible */
      pointer-events:none;
      z-index:-2;
    }
    /* l√©ger voile (mais faible) pour garder lisible */
    body::after{
      content:"";
      position:fixed; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.35));
      pointer-events:none;
      z-index:-1;
    }

    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:22px 14px 90px}

    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      position:sticky;top:0;z-index:50;
      backdrop-filter: blur(12px);
      background:linear-gradient(180deg, rgba(5,8,22,.72), rgba(5,8,22,.35));
      border-bottom:1px solid rgba(31,41,55,.55);
      padding:14px 10px;margin:-22px -14px 18px;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.4px}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 10px 25px rgba(168,85,247,.25);
    }
    .top-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid rgba(31,41,55,.75);
      background:rgba(2,6,23,.40);
      padding:8px 10px;border-radius:999px;
      backdrop-filter: blur(10px);
    }
    .btn{
      cursor:pointer;border:none;
      padding:10px 14px;border-radius:999px;
      background:linear-gradient(120deg,var(--accent),var(--accent2));
      color:#fff;font-weight:900;
      box-shadow:0 12px 30px rgba(236,72,153,.15);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn2{
      cursor:pointer;border:1px solid rgba(31,41,55,.75);
      padding:10px 14px;border-radius:999px;
      background:rgba(2,6,23,.40);
      color:var(--text);font-weight:900;
      backdrop-filter: blur(10px);
    }

    .grid2{display:grid;grid-template-columns:1.25fr .75fr;gap:14px;align-items:stretch}
    @media(max-width:980px){.grid2{grid-template-columns:1fr}}

    .card{
      background:linear-gradient(180deg, rgba(15,23,42,.82), rgba(15,23,42,.55));
      border:1px solid rgba(31,41,55,.70);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(14px);
    }
    h1{font-size:34px;line-height:1.05}
    .sub{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.55}
    .hr{height:1px;background:rgba(31,41,55,.55);margin:14px 0}
    .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .chip{
      font-size:12px;color:var(--text);
      border:1px solid rgba(31,41,55,.70);
      background:rgba(2,6,23,.35);
      padding:7px 10px;border-radius:999px;
      display:flex;align-items:center;gap:8px;
      backdrop-filter: blur(10px);
    }
    .okdot{width:10px;height:10px;border-radius:999px;background:var(--good);box-shadow:0 0 0 3px rgba(34,197,94,.15)}
    .warnbox{
      border:1px solid rgba(245,158,11,.30);
      background:rgba(245,158,11,.06);
      padding:10px 12px;border-radius:14px;
      font-size:12px;color:var(--muted);
      backdrop-filter: blur(10px);
    }
    .ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .ctaRow .btn2, .ctaRow .btn{display:inline-flex;align-items:center;gap:8px}

    .sectionTitle{
      margin-top:18px;font-weight:900;font-size:14px;letter-spacing:.35px;color:var(--text);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .sectionTitle small{color:var(--muted);font-weight:800}

    .swaps{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:12px;padding-bottom:30px}
    @media(max-width:980px){.swaps{grid-template-columns:1fr}}

    label{font-size:12px;color:var(--muted)}
    input,select{
      width:100%;margin-top:6px;
      padding:10px 11px;border-radius:14px;
      background:rgba(2,6,23,.45);
      border:1px solid rgba(31,41,55,.70);
      color:var(--text);outline:none;
      backdrop-filter: blur(10px);
    }
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .swap-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .swap-title b{font-size:13px}
    .swap-title span{font-size:12px;color:var(--muted)}
    .switch{display:flex;justify-content:center;margin:10px 0;}
    .switch button{
      border:1px solid rgba(31,41,55,.70);
      background:rgba(2,6,23,.40);
      color:var(--text);border-radius:12px;
      padding:7px 10px;cursor:pointer;
      backdrop-filter: blur(10px);
    }
    .balRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px}
    .balText{font-size:12px;color:var(--muted)}
    .maxBtn,.pctBtn{
      border:1px solid rgba(31,41,55,.70);
      background:rgba(2,6,23,.40);
      color:var(--text);
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      backdrop-filter: blur(10px);
    }
    .maxBtn:disabled,.pctBtn:disabled{opacity:.55;cursor:not-allowed}
    .pctRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .status{margin-top:10px;font-size:12px;color:var(--muted)}
    .status.good{color:var(--good)}
    .status.bad{color:var(--bad)}
    .status.warn{color:var(--warn)}
    .quoteLine{margin-top:8px;font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .txlink{font-weight:900;text-decoration:none;border-bottom:1px dotted rgba(229,231,235,.35)}
    .bottomGrid{display:grid;grid-template-columns:1fr .9fr;gap:14px;margin-top:14px}
    @media(max-width:980px){.bottomGrid{grid-template-columns:1fr}}
    .linkItem{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;border-radius:16px;
      border:1px solid rgba(31,41,55,.70);
      background:rgba(2,6,23,.32);
      margin-top:10px;
      backdrop-filter: blur(12px);
    }
    .linkItem b{font-size:13px}
    .linkItem span{display:block;color:var(--muted);font-size:12px;margin-top:2px}
    .linkBtn{padding:8px 12px;border-radius:999px}
    footer{margin-top:26px;text-align:center;color:var(--muted);font-size:11px;line-height:1.6}

    /* ================= TOKEN MODAL ================= */
    #tokenModal{display:none; position:fixed; inset:0; z-index:9999;}
    #tmBackdrop{position:absolute; inset:0; background:rgba(0,0,0,.62);}
    .tmBox{
      position:relative; max-width:760px; margin:5vh auto;
      background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.70));
      border:1px solid rgba(31,41,55,.75);
      border-radius:20px; box-shadow:0 18px 45px rgba(0,0,0,.60);
      padding:14px;
      backdrop-filter: blur(18px);
    }
    .tmTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
    .tmClose{cursor:pointer; border:none; background:transparent; color:#22c55e; font-size:26px; font-weight:900; line-height:1;}
    .tmSearch{
      width:100%; padding:12px 12px; border-radius:14px; outline:none;
      background:rgba(2,6,23,.45); border:1px solid rgba(34,197,94,.45); color:#e5e7eb;
      backdrop-filter: blur(12px);
    }

    .tmList{margin-top:10px; max-height:58vh; overflow:auto; padding-right:6px;}
    .tmRow{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px; border-radius:16px; margin-bottom:10px;
      border:1px solid rgba(31,41,55,.70); background:rgba(2,6,23,.30);
      cursor:pointer;
      backdrop-filter: blur(14px);
    }
    .tmLeft{display:flex; align-items:center; gap:12px; min-width:260px;}
    .tmLogo{
      width:34px; height:34px; border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid; place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .tmLogo img{width:100%; height:100%; object-fit:cover; display:block;}
    .tmSym{font-weight:950; font-size:15px}
    .tmAddr{color:var(--muted); font-size:12px; margin-top:2px}
    .tmMid{display:flex; flex-direction:column; align-items:flex-end; gap:2px; min-width:140px;}
    .tmBalLabel{color:var(--muted); font-size:11px}
    .tmBalVal{font-weight:900; font-size:13px}
    .tmActions{display:flex; gap:8px; align-items:center;}
    .tmIconBtn{
      border:1px solid rgba(31,41,55,.70); background:rgba(2,6,23,.35);
      color:#e5e7eb; border-radius:12px; padding:8px 10px; cursor:pointer;
      backdrop-filter: blur(10px);
    }
    .tmFoot{
      margin-top:10px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      color:#9ca3af; font-size:12px;
      flex-wrap:wrap;
    }
    .tmRefresh{
      border:1px solid rgba(31,41,55,.70);
      background:rgba(2,6,23,.35);
      border-radius:999px;
      padding:10px 14px;
      color:#e5e7eb;
      cursor:pointer;
      font-weight:900;
      backdrop-filter: blur(10px);
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="brand"><div class="logo"></div><div>TRINITY Swap</div></div>
    <div class="top-right">
      <div class="pill" id="netPill">R√©seau : ‚Äî</div>
      <div class="pill" id="walletPill">Wallet : non connect√©</div>
      <button class="btn" id="connectBtn">Connect Wallet</button>
    </div>
  </header>

  <section class="grid2">
    <div class="card">
      <h1>Swap 3 tokens en parall√®le.<br/>Une interface, trois actions.</h1>
      <p class="sub">
        TRINITY = MultiSwap : tu pr√©pares 3 swaps diff√©rents et tu lances chaque swap avec son propre bouton.
        Mode 1 (PulseX-like) : UI au-dessus du router PulseX ‚Ä¢ non-custodial ‚Ä¢ 0 fee TRINITY.
      </p>

      <div class="chips">
        <div class="chip"><span class="okdot"></span>3 swaps ind√©pendants</div>
        <div class="chip"><span class="okdot"></span>Quotes live</div>
        <div class="chip"><span class="okdot"></span>Approve auto</div>
        <div class="chip"><span class="okdot"></span>MAX + balances</div>
      </div>

      <div class="ctaRow">
        <button class="btn" id="openMultiBtn">üöÄ Ouvrir le MultiSwap</button>
        <button class="btn2" id="execTrinityBtn" disabled>‚ö° Ex√©cuter TRINITY (A‚ÜíB‚ÜíC)</button>
        <a class="btn2" href="https://whaletrackerio.github.io/autopilot-pulsechain/" target="_blank" rel="noreferrer">‚ö° AutoPilot</a>
        <a class="btn2" href="https://whaletrackerio.github.io/dca-pulsechain/" target="_blank" rel="noreferrer">üìà DCA</a>
      </div>

      <div class="hr"></div>
      <div class="warnbox">‚ö†Ô∏è Teste avec de petits montants. TRINITY ne garde pas tes fonds : c‚Äôest ton wallet qui signe.</div>
    </div>

    <div class="card">
      <div style="font-weight:900;font-size:14px">R√©glages</div>
      <p class="sub">Slippage + deadline pour calculer le minOut sur chaque swap.</p>

      <div class="hr"></div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>Slippage (%)</label>
          <input id="slippage" type="number" min="0" step="0.1" value="2.0" />
        </div>
        <div>
          <label>Deadline (minutes)</label>
          <input id="deadlineM" type="number" min="1" step="1" value="10" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="warnbox">
        Explorer : <a class="txlink" target="_blank" rel="noreferrer" href="https://otter.pulsechain.com/">otter.pulsechain.com</a>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn2" id="refreshBtn">‚Üª Refresh balances/quotes</button>
        <button class="btn2" id="openTokenListBtn">ü™ô Liste tokens</button>
      </div>
    </div>
  </section>

  <div class="sectionTitle" id="multiswap">
    <div>MULTISWAP</div>
    <small>Pr√©pare 3 swaps puis clique sur le bouton de celui que tu veux ex√©cuter.</small>
  </div>

  <section class="swaps" id="swaps"></section>

  <section class="bottomGrid">
    <div class="card">
      <div style="font-weight:900;font-size:14px">Notes</div>
      <p class="sub">
        Mode 1 = pas de fee TRINITY, pas de smart contract maison, chaque swap = 1 transaction.
        Si une quote √©choue, c‚Äôest souvent un manque de liquidit√© sur la paire.
      </p>
      <div class="hr"></div>
      <!-- (Astuce supprim√©e comme demand√©) -->
      <div class="warnbox">üí° Si un token n‚Äôaffiche pas de balance, v√©rifie que son adresse est bien celle de PulseChain (bridg√©).</div>
    </div>

    <div class="card">
      <div style="font-weight:900;font-size:14px">LIENS RAPIDES</div>

      <div class="linkItem">
        <div><b>PulseX</b><span>Swap officiel PulseChain.</span></div>
        <a class="btn2 linkBtn" href="https://pulsex.com" target="_blank" rel="noreferrer">Ouvrir</a>
      </div>

      <div class="linkItem">
        <div><b>Otter</b><span>Explorer / tx / contrats.</span></div>
        <a class="btn2 linkBtn" href="https://otter.pulsechain.com/" target="_blank" rel="noreferrer">Explorer</a>
      </div>

      <div class="linkItem">
        <div><b>AutoPilot</b><span>Tes bots HEX/ATROPA.</span></div>
        <a class="btn2 linkBtn" href="https://whaletrackerio.github.io/autopilot-pulsechain/" target="_blank" rel="noreferrer">Aller</a>
      </div>

      <div class="linkItem">
        <div><b>DCA PulseChain</b><span>8 bots DCA (achat √† l‚Äôunit√©).</span></div>
        <a class="btn2 linkBtn" href="https://whaletrackerio.github.io/dca-pulsechain/" target="_blank" rel="noreferrer">Aller</a>
      </div>
    </div>
  </section>

  <footer>
    TRINITY Swap ‚Äî PulseChain ‚Ä¢ Mode 1 (PulseX-like) ‚Ä¢ Aucun frais TRINITY<br/>
    Utilise √† tes risques. V√©rifie les adresses et teste petit.
  </footer>

</div>

<!-- TOKEN MODAL -->
<div id="tokenModal">
  <div id="tmBackdrop"></div>
  <div class="tmBox">
    <div class="tmTop">
      <div style="font-weight:950;font-size:22px;">Select a token</div>
      <button class="tmClose" id="tmClose">‚úï</button>
    </div>

    <input class="tmSearch" id="tmSearch" placeholder="Search name or paste address" />

    <div class="tmList" id="tmList"></div>

    <div class="tmFoot">
      <button class="tmRefresh" id="tmRefresh">‚Üª Refresh</button>
      <div>üìã copie l‚Äôadresse ‚Ä¢ ü¶ä ajoute √† MetaMask ‚Ä¢ <span class="mono">Balance</span> = ton solde</div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const PULSECHAIN_ID = 369;
const PULSECHAIN_HEX = "0x171"; // 369
const PULSEX_ROUTER = "0x98bf93ebf5c380C0e6Ae8e192A7e2AE08edAcc02";
const WPLS = "0xA1077a294dDE1B09bB078844df40758a5D0f9a27";
const PLS_GAS_RESERVE = ethers.parseUnits("0.05", 18);

/* =========================================================
   TOKENS (tes 2 blocs ajout√©s)
   - Mets decimals si tu veux √™tre ultra pr√©cis.
   - logo: optionnel (url). Sinon fallback propre.
========================================================= */
const TOKENS = {
  // Natifs / base
  PLS:    { symbol:"PLS",   address:null, decimals:18, chain:"pulse" },
  WPLS:   { symbol:"WPLS",  address:WPLS, decimals:18, chain:"pulse" },
  PLSX:   { symbol:"PLSX",  address:"0x95B303987A60C71504D99Aa1b13B4DA07b0790ab", decimals:18, chain:"pulse" },
  PHEX:   { symbol:"PHEX",  address:"0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39", decimals:8,  chain:"pulse" },
  EHEX:   { symbol:"EHEX",  address:"0x57fde0a71132198BBeC939B98976993d8D89D225", decimals:8,  chain:"pulse" },
  ATROPA: { symbol:"ATROPA",address:"0xCc78A0acDF847A2C1714D2A925bB4477df5d48a6", decimals:18, chain:"pulse" },

  // Bloc 1 (tes adresses)
  INC:    { symbol:"INC",   address:"0x2fa878Ab3F87CC1C9737Fc071108F904c0B0C95d", decimals:18, chain:"pulse" },
  DAI:    { symbol:"DAI",   address:"0xefD766cCb38EaF1dfd701853BFCe31359239F305", decimals:18, chain:"pulse" },
  USDC:   { symbol:"USDC",  address:"0x15D38573d2feeb82e7ad5187aB8c1D52810B1f07", decimals:6,  chain:"pulse" },
  WETH:   { symbol:"WETH",  address:"0x02DcdD04e3F455D838cd1249292C58f3B79e3C3C", decimals:18, chain:"pulse" },

  AXIS:   { symbol:"AXIS",  address:"0x8BDB63033b02C15f113De51EA1C3a96Af9e8ecb5", decimals:18, chain:"pulse" },
  BANANAS:{ symbol:"BANANAS",address:"0xC6B28B2E3Bf9fF26299D540a4D654F7ade4dFdB0", decimals:18, chain:"pulse" },
  CST:    { symbol:"CST",   address:"0x600136dA8cc6D1Ea07449514604dc4ab7098dB82", decimals:18, chain:"pulse" },
  EARN:   { symbol:"EARN",  address:"0xb513038BbFdF9D40B676F41606f4F61D4b02c4A2", decimals:18, chain:"pulse" },
  ELIXIR: { symbol:"ELIXIR",address:"0xeCd465A15fac825B0Fe69416A4c7BfE03A50c12E", decimals:18, chain:"pulse" },
  HDRN:   { symbol:"HDRN",  address:"0x3819f64f282bf135d62168C1e513280dAF905e06", decimals:9,  chain:"pulse" },
  HELGO:  { symbol:"HELGO", address:"0x0567CA0dE35606E9C260CC2358404B11DE21DB44", decimals:18, chain:"pulse" },
  IM:     { symbol:"IM",    address:"0xBBcF895BFCb57d0f457D050bb806d1499436c0CE", decimals:18, chain:"pulse" },
  LINK:   { symbol:"LINK",  address:"0x514910771AF9Ca656af840dff83E8264EcF986CA", decimals:18, chain:"eth"  },
  pBSKR:  { symbol:"pBSKR", address:"0x1DcbF345bC44696BbBed402367f7C62e524Fe8B5", decimals:18, chain:"pulse" },
  PEPE:   { symbol:"PEPE",  address:"0x6982508145454Ce325dDbE47a25d4ec3d2311933", decimals:18, chain:"eth"  },

  // Bloc 2 (tes adresses)
  LOAN:   { symbol:"LOAN",  address:"0x9159f1D2a9f51998Fc9Ab03fbd8f265ab14A1b3B", decimals:18, chain:"pulse" },
  PHUX:   { symbol:"PHUX",  address:"0x9663c2d75ffd5F4017310405fCe61720aF45B829", decimals:18, chain:"pulse" },
  PRS:    { symbol:"PRS",   address:"0xb6B57227150a7097723e0C013752001AaD01248F", decimals:18, chain:"pulse" },
  pTGC:   { symbol:"pTGC",  address:"0x94534EeEe131840b1c0F61847c572228bdfDDE93", decimals:18, chain:"pulse" },
  PTS:    { symbol:"PTS",   address:"0x2A06a971fE6ffa002fd242d437E3db2b5cC5B433", decimals:18, chain:"pulse" },
  PXDC:   { symbol:"PXDC",  address:"0xeB6b7932Da20c6D7B3a899D5887d86dfB09A6408", decimals:18, chain:"pulse" },
  RFX:    { symbol:"RFX",   address:"0xF876BDf9D6403AA7D5bF7F523E8f440A841CC596", decimals:18, chain:"pulse" },
  SHIB:   { symbol:"SHIB",  address:"0x95aD61b0a150d79219dCF64E1E6Cc01f0B64C4cE", decimals:18, chain:"eth"  },
  SOUNDX: { symbol:"SOUNDX",address:"0xA301c1871Dbf414261946281C7F62213fae22CfE", decimals:18, chain:"pulse" },
  TETRAp: { symbol:"TETRAp",address:"0xAeC4C07537B03E3E62fc066EC62401Aed5Fdd361", decimals:18, chain:"pulse" },
  TEXAN:  { symbol:"TEXAN", address:"0xcFCFfE432A48dB53F59c301422d2EdD77B2A88d7", decimals:18, chain:"pulse" },
  TIME:   { symbol:"TIME",  address:"0xCA35638A3fdDD02fEC597D8c1681198C06b23F58", decimals:18, chain:"pulse" },
  UFO:    { symbol:"UFO",   address:"0x456548A9B56eFBbD89Ca0309edd17a9E20b04018", decimals:18, chain:"pulse" },
  UNI:    { symbol:"UNI",   address:"0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984", decimals:18, chain:"eth"  },
  USDL:   { symbol:"USDL",  address:"0x0dEEd1486bc52aA0d3E6f8849cEC5adD6598A162", decimals:18, chain:"pulse" },
  USDT:   { symbol:"USDT",  address:"0xdAC17F958D2ee523a2206206994597C13D831ec7", decimals:6,  chain:"eth"  },
  VORTEX: { symbol:"VORTEX",address:"0x73d8a4D01d658E565cF83068397FD39Baf386C48", decimals:18, chain:"pulse" },
  WATT:   { symbol:"WATT",  address:"0xDfdc2836FD2E63Bba9f0eE07901aD465Bff4DE71", decimals:18, chain:"pulse" },
  WBTC:   { symbol:"WBTC",  address:"0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599", decimals:8,  chain:"eth"  },
};

const ERC20_ABI = [
  "function approve(address spender,uint256 amount) external returns (bool)",
  "function allowance(address owner,address spender) external view returns (uint256)",
  "function balanceOf(address owner) external view returns (uint256)",
  "function decimals() external view returns (uint8)",
];
const ROUTER_ABI = [
  "function getAmountsOut(uint256 amountIn, address[] calldata path) external view returns (uint256[] memory amounts)",
  "function swapExactTokensForTokens(uint256 amountIn,uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) external returns (uint256[] memory amounts)",
  "function swapExactETHForTokens(uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) external payable returns (uint256[] memory amounts)",
  "function swapExactTokensForETH(uint256 amountIn,uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) external returns (uint256[] memory amounts)"
];

/* ================= HELPERS ================= */
const $ = (id) => document.getElementById(id);
function shortAddr(a){ return a ? (a.slice(0,6)+"‚Ä¶"+a.slice(-4)) : ""; }
function isAddr(x){ return /^0x[a-fA-F0-9]{40}$/.test(x); }
function norm(x){ return (x||"").toLowerCase(); }
function txUrl(hash){ return `https://otter.pulsechain.com/tx/${hash}`; }

function setStatus(card, txt, cls=""){
  const el = card.querySelector(".status");
  el.className = "status" + (cls ? " "+cls : "");
  el.textContent = txt;
}
function getSettings(){
  const sl = parseFloat($("slippage").value || "2");
  const dl = parseInt($("deadlineM").value || "10", 10);
  return { slippage: Math.max(0, sl), deadlineMin: Math.max(1, dl) };
}

function buildPath(symIn, symOut){
  if(symIn === symOut) return null;
  const inT = TOKENS[symIn];
  const outT = TOKENS[symOut];
  if(symIn === "PLS") return [WPLS, ethers.getAddress(outT.address)];
  if(symOut === "PLS") return [ethers.getAddress(inT.address), WPLS];
  return [ethers.getAddress(inT.address), ethers.getAddress(outT.address)];
}

function formatAmount(sym, raw){
  const dec = TOKENS[sym].decimals ?? 18;
  const s = ethers.formatUnits(raw, dec);
  const num = Number(s);
  if(!isFinite(num)) return s;
  if(num === 0) return "0";
  if(num < 0.0001) return num.toExponential(3);
  return num.toLocaleString(undefined, { maximumFractionDigits: 6 });
}
function parseAmount(sym, human){
  return ethers.parseUnits(human, TOKENS[sym].decimals ?? 18);
}
function validatePair(card){
  const from = card.querySelector(".from").value;
  const to = card.querySelector(".to").value;
  if(from === to){
    setStatus(card, "Paire invalide (tokens identiques)", "bad");
    return false;
  }
  return true;
}

/* ================= STATE ================= */
let provider, signer, userAddress, networkOk = false;

/* ================= UI BUILD (Swap cards) ================= */
const swapsEl = $("swaps");
function swapCardTemplate(i, label){
  return `
    <div class="card swapbox" id="swap${i}">
      <div class="swap-title">
        <b>${label}</b>
        <span>TX #${i}</span>
      </div>

      <label>Tu payes</label>
      <div class="row2">
        <select class="from"></select>
        <input class="amount" inputmode="decimal" placeholder="Montant" />
      </div>

      <div class="balRow">
        <div class="balText">Balance: <span class="balIn">Connect wallet</span></div>
        <button class="maxBtn" type="button" disabled>MAX</button>
      </div>

      <div class="pctRow">
        <button class="pctBtn" type="button" data-p="25" disabled>25%</button>
        <button class="pctBtn" type="button" data-p="50" disabled>50%</button>
        <button class="pctBtn" type="button" data-p="75" disabled>75%</button>
      </div>

      <div class="switch"><button class="invert" title="Inverser">‚Üï</button></div>

      <label>Tu re√ßois</label>
      <div class="row2">
        <select class="to"></select>
        <input class="out" placeholder="Estimation" readonly />
      </div>

      <div class="quoteLine">
        <span>Quote:</span>
        <span class="quoteText">‚Äî</span>
      </div>

      <div class="actions">
        <button class="btn2 approveBtn" style="display:none" disabled>Approve</button>
        <button class="btn swapBtn" disabled>Ex√©cuter ${label}</button>
      </div>

      <div class="status">Ready (connect wallet)</div>
      <div class="quoteLine" style="margin-top:10px">
        <a class="txlink txA" target="_blank" rel="noreferrer" style="display:none">Voir TX</a>
      </div>
    </div>
  `;
}
swapsEl.insertAdjacentHTML("beforeend", swapCardTemplate(1,"Swap A"));
swapsEl.insertAdjacentHTML("beforeend", swapCardTemplate(2,"Swap B"));
swapsEl.insertAdjacentHTML("beforeend", swapCardTemplate(3,"Swap C"));

function fillSelect(sel, selected){
  sel.innerHTML = "";
  for(const k of Object.keys(TOKENS)){
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = k;
    sel.appendChild(opt);
  }
  sel.value = selected;
}
function initCardsDefaults(){
  const defaults = [
    {from:"PLS",  to:"PHEX"},
    {from:"PLS",  to:"ATROPA"},
    {from:"PHEX", to:"PLSX"},
  ];
  document.querySelectorAll(".swapbox").forEach((card, idx)=>{
    const fromSel = card.querySelector(".from");
    const toSel   = card.querySelector(".to");
    fillSelect(fromSel, defaults[idx].from);
    fillSelect(toSel, defaults[idx].to);

    card.querySelector(".invert").addEventListener("click", ()=>{
      const a = fromSel.value;
      fromSel.value = toSel.value;
      toSel.value = a;
      triggerQuote(card);
      refreshCardBalance(card).catch(()=>{});
    });

    fromSel.addEventListener("change", ()=>{
      triggerQuote(card);
      refreshCardBalance(card).catch(()=>{});
    });
    toSel.addEventListener("change", ()=> triggerQuote(card));
    card.querySelector(".amount").addEventListener("input", ()=> triggerQuote(card));
  });
}
initCardsDefaults();

/* ================= CONNECT UI ================= */
function setConnectedUI(isOk){
  document.querySelectorAll(".swapBtn").forEach(b => b.disabled = !isOk);
  document.querySelectorAll(".approveBtn").forEach(b => b.disabled = !isOk);
  document.querySelectorAll(".maxBtn").forEach(b => b.disabled = !isOk);
  document.querySelectorAll(".pctBtn").forEach(b => b.disabled = !isOk);
  $("execTrinityBtn").disabled = !isOk;

  document.querySelectorAll(".swapbox").forEach(card => {
    const bal = card.querySelector(".balIn");
    bal.textContent = isOk ? "‚Äî" : "Connect wallet";
    if(!isOk) setStatus(card, "Ready (connect wallet)", "");
  });
}

/* ================= SCROLL BTN ================= */
$("openMultiBtn").addEventListener("click", ()=>{
  $("multiswap").scrollIntoView({behavior:"smooth", block:"start"});
  window.scrollBy(0, -90);
});

/* ================= WEB3 CONNECT ================= */
async function connectWallet(){
  if(!window.ethereum){
    alert("Wallet requis : MetaMask");
    return;
  }

  await window.ethereum.request({ method:"eth_requestAccounts" });
  provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();
  userAddress = await signer.getAddress();

  const net = await provider.getNetwork();
  let ok = (Number(net.chainId) === PULSECHAIN_ID);

  if(!ok){
    try{
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: PULSECHAIN_HEX }]
      });
      const net2 = await provider.getNetwork();
      ok = (Number(net2.chainId) === PULSECHAIN_ID);
    }catch(e){
      console.error(e);
    }
  }

  networkOk = ok;
  $("walletPill").textContent = "Wallet : " + shortAddr(userAddress);
  $("netPill").textContent = "R√©seau : " + (ok ? "PulseChain ‚úÖ" : "Mauvais r√©seau ‚ùå");

  // bouton devient adresse + copie
  const btn = $("connectBtn");
  btn.textContent = shortAddr(userAddress);
  btn.onclick = async () => {
    await navigator.clipboard.writeText(userAddress);
    alert("Adresse copi√©e ‚úÖ");
  };

  setConnectedUI(ok);

  if(!ok){
    alert("Passe sur PulseChain (chainId 369) puis reconnecte.");
    return;
  }

  await refreshAll();
  await refreshTokenModalBalances().catch(()=>{});

  window.ethereum.on?.("accountsChanged", ()=> location.reload());
  window.ethereum.on?.("chainChanged", ()=> location.reload());
}
$("connectBtn").addEventListener("click", connectWallet);
$("refreshBtn").addEventListener("click", ()=> refreshAll());

/* ================= CONTRACT HELPERS ================= */
function getRouter(readOnly=true){
  return new ethers.Contract(PULSEX_ROUTER, ROUTER_ABI, readOnly ? provider : signer);
}
function getErc20(tokenAddr, readOnly=true){
  return new ethers.Contract(ethers.getAddress(tokenAddr), ERC20_ABI, readOnly ? provider : signer);
}

/* ================= BALANCES ================= */
async function getBalance(sym){
  if(sym === "PLS") return await provider.getBalance(userAddress);
  return await getErc20(TOKENS[sym].address, true).balanceOf(userAddress);
}

async function refreshCardBalance(card){
  const balEl = card.querySelector(".balIn");
  if(!networkOk || !userAddress){
    balEl.textContent = "Connect wallet";
    return;
  }
  const from = card.querySelector(".from").value;
  try{
    const bal = await getBalance(from);
    balEl.textContent = formatAmount(from, bal);
  }catch(e){
    console.error(e);
    balEl.textContent = "‚Äî";
  }
}

async function refreshAll(){
  const cards = document.querySelectorAll(".swapbox");
  for(const card of cards){
    await refreshCardBalance(card);
    await updateQuote(card);
  }
  // si modal ouverte, update aussi
  if($("tokenModal").style.display === "block"){
    await refreshTokenModalBalances().catch(()=>{});
  }
}

/* ================= MAX + % ================= */
async function setAmountFromPercent(card, pct){
  if(!networkOk) return alert("Connecte ton wallet d‚Äôabord");
  if(!validatePair(card)) return;

  const from = card.querySelector(".from").value;
  let bal = await getBalance(from);

  if(from === "PLS"){
    if(bal <= PLS_GAS_RESERVE){
      alert("Balance PLS insuffisante pour le gas");
      return;
    }
    bal = bal - PLS_GAS_RESERVE;
  }

  const amount = bal * BigInt(pct) / 100n;
  card.querySelector(".amount").value = ethers.formatUnits(amount, TOKENS[from].decimals ?? 18);
  await updateQuote(card);
}
document.querySelectorAll(".swapbox").forEach(card=>{
  card.querySelector(".maxBtn").addEventListener("click", ()=> setAmountFromPercent(card, 100).catch(console.error));
  card.querySelectorAll(".pctBtn").forEach(b=>{
    b.addEventListener("click", ()=> setAmountFromPercent(card, parseInt(b.dataset.p,10)).catch(console.error));
  });
});

/* ================= QUOTES + APPROVE ================= */
async function checkAllowance(symIn, amountRaw){
  if(symIn === "PLS") return true;
  const allowance = await getErc20(TOKENS[symIn].address, true).allowance(userAddress, PULSEX_ROUTER);
  return allowance >= amountRaw;
}
async function doApprove(symIn, card){
  const erc = getErc20(TOKENS[symIn].address, false);
  setStatus(card, "Approving‚Ä¶ (MetaMask)", "warn");
  const tx = await erc.approve(PULSEX_ROUTER, ethers.MaxUint256);
  setStatus(card, "Approve pending‚Ä¶", "warn");
  await tx.wait();
  setStatus(card, "Approve OK ‚úÖ", "good");
}

let quoteTimer = null;
function triggerQuote(card){
  if(quoteTimer) clearTimeout(quoteTimer);
  quoteTimer = setTimeout(()=> updateQuote(card).catch(()=>{}), 250);
}

async function updateQuote(card){
  const from = card.querySelector(".from").value;
  const to = card.querySelector(".to").value;
  const amt = (card.querySelector(".amount").value || "").trim();

  const outInp = card.querySelector(".out");
  const quoteText = card.querySelector(".quoteText");
  const approveBtn = card.querySelector(".approveBtn");

  outInp.value = "";
  quoteText.textContent = "‚Äî";
  approveBtn.style.display = "none";

  if(!networkOk || !userAddress){
    setStatus(card, "Ready (connect wallet)", "");
    return;
  }
  if(!amt || Number(amt) <= 0){
    setStatus(card, "Ready ‚úÖ", "good");
    return;
  }
  if(!validatePair(card)) return;

  try{
    setStatus(card, "Quoting‚Ä¶", "warn");
    const amountIn = parseAmount(from, amt);
    const path = buildPath(from, to);
    if(!path) throw new Error("Invalid path");

    const router = getRouter(true);
    const amounts = await router.getAmountsOut(amountIn, path);
    const outRaw = amounts[amounts.length - 1];

    outInp.value = formatAmount(to, outRaw);
    quoteText.textContent = `${amt} ${from} ‚Üí ~${formatAmount(to, outRaw)} ${to}`;

    if(from !== "PLS"){
      const ok = await checkAllowance(from, amountIn);
      if(!ok){
        approveBtn.style.display = "inline-flex";
        approveBtn.disabled = false;
        approveBtn.textContent = "Approve " + from;
        approveBtn.onclick = async ()=>{
          try{
            await doApprove(from, card);
            await updateQuote(card);
          }catch(e){
            console.error(e);
            setStatus(card, "Approve error", "bad");
          }
        };
        setStatus(card, "Allowance insuffisante ‚Üí Approve requis", "warn");
        return;
      }
    }

    setStatus(card, "Ready ‚úÖ", "good");
  }catch(e){
    console.error(e);
    setStatus(card, "Quote error (liquidit√©/pair ?)", "bad");
  }
}

/* ================= SWAP EXECUTION ================= */
async function executeSwap(card){
  if(!networkOk || !userAddress) return alert("Connecte ton wallet sur PulseChain");

  const from = card.querySelector(".from").value;
  const to   = card.querySelector(".to").value;
  const amt  = (card.querySelector(".amount").value || "").trim();
  const txLink = card.querySelector(".txA");
  txLink.style.display = "none";

  if(!validatePair(card)) return;
  if(!amt || Number(amt) <= 0){
    setStatus(card, "Montant manquant", "bad");
    return;
  }

  const { slippage, deadlineMin } = getSettings();

  try{
    const routerWrite = getRouter(false);
    const routerRead  = getRouter(true);
    const amountIn = parseAmount(from, amt);
    const path = buildPath(from, to);

    if(from !== "PLS"){
      const ok = await checkAllowance(from, amountIn);
      if(!ok) await doApprove(from, card);
    }

    setStatus(card, "Calcul minOut‚Ä¶", "warn");
    const amounts = await routerRead.getAmountsOut(amountIn, path);
    const outRaw  = amounts[amounts.length - 1];

    const bps = Math.round(slippage * 100);
    const minOut = outRaw * BigInt(10000 - bps) / 10000n;
    const deadline = Math.floor(Date.now()/1000) + (deadlineMin * 60);

    let tx;
    setStatus(card, "Signature (MetaMask)‚Ä¶", "warn");

    if(from === "PLS"){
      tx = await routerWrite.swapExactETHForTokens(minOut, path, userAddress, deadline, { value: amountIn });
    }else if(to === "PLS"){
      tx = await routerWrite.swapExactTokensForETH(amountIn, minOut, path, userAddress, deadline);
    }else{
      tx = await routerWrite.swapExactTokensForTokens(amountIn, minOut, path, userAddress, deadline);
    }

    setStatus(card, "Pending‚Ä¶", "warn");
    txLink.href = txUrl(tx.hash);
    txLink.textContent = "Voir TX";
    txLink.style.display = "inline-flex";

    await tx.wait();

    setStatus(card, "Success ‚úÖ", "good");
    await refreshAll();

  }catch(e){
    console.error(e);
    setStatus(card, "Swap error (cancel ? liquidit√© ?)", "bad");
  }
}
document.querySelectorAll(".swapbox").forEach(card=>{
  card.querySelector(".swapBtn").addEventListener("click", ()=> executeSwap(card));
});

/* ================= EXECUTE TRINITY (A‚ÜíB‚ÜíC) ================= */
$("execTrinityBtn").addEventListener("click", async ()=>{
  if(!networkOk) return alert("Connecte ton wallet sur PulseChain");
  const cards = [ $("swap1"), $("swap2"), $("swap3") ];

  $("multiswap").scrollIntoView({behavior:"smooth", block:"start"});
  window.scrollBy(0, -90);

  for(const card of cards){
    const amt = (card.querySelector(".amount").value || "").trim();
    const from = card.querySelector(".from").value;
    const to = card.querySelector(".to").value;

    if(!amt || Number(amt) <= 0){
      setStatus(card, "Skip (montant vide)", "");
      continue;
    }
    if(from === to){
      setStatus(card, "Skip (tokens identiques)", "bad");
      continue;
    }

    await executeSwap(card);

    const st = (card.querySelector(".status").textContent || "").toLowerCase();
    if(st.includes("error")){
      alert("TRINITY stopp√© (erreur sur un swap).");
      break;
    }
  }
});

/* ================= TOKEN MODAL (PulseX-like) ================= */
let tokenModalTarget = null;
let tokenBalancesCache = {}; // sym -> string

function openTokenModal(card, side){
  tokenModalTarget = { card, side };
  $("tokenModal").style.display = "block";
  $("tmSearch").value = "";
  renderTokenList("");
  setTimeout(()=>$("tmSearch").focus(), 50);

  // charge balances si connect√©
  refreshTokenModalBalances().catch(()=>{});
}
function closeTokenModal(){
  $("tokenModal").style.display = "none";
  tokenModalTarget = null;
}
$("tmClose").onclick = closeTokenModal;
$("tmBackdrop").onclick = closeTokenModal;
$("openTokenListBtn").onclick = () => openTokenModal($("swap1"), "from"); // ouvre ‚Äújuste la liste‚Äù
$("tmSearch").addEventListener("input", (e)=> renderTokenList((e.target.value||"").trim()));
$("tmRefresh").addEventListener("click", ()=> refreshTokenModalBalances(true).catch(()=>{}));

async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); }
  catch{
    const ta=document.createElement("textarea");
    ta.value=txt; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
  }
}

async function addTokenToMetaMask(sym){
  const t = TOKENS[sym];
  if(!window.ethereum) return alert("MetaMask requis");
  if(!t.address) return alert("PLS = token natif (pas ERC20)");

  try{
    const wasAdded = await window.ethereum.request({
      method: "wallet_watchAsset",
      params: {
        type: "ERC20",
        options: {
          address: t.address,
          symbol: sym,
          decimals: t.decimals ?? 18
        }
      }
    });

    if(wasAdded){
      alert("Token ajout√© ‚úÖ");
    }else{
      alert("Ajout refus√© (cancel)");
    }
  }catch(e){
    console.error(e);
    try{ await copyText(t.address); }catch(_){}
    alert("Impossible d‚Äôajouter automatiquement.\n‚úÖ Adresse copi√©e.\n‚û°Ô∏è Ajoute-la via Import token dans MetaMask.");
    window.open("https://otter.pulsechain.com/address/" + t.address, "_blank");
  }
}

/* --------- LOGOS : strat√©gie clean ----------
   1) Si TOKENS[sym].logo existe => on affiche.
   2) Sinon, si token ‚Äúeth‚Äù connu => TrustWallet logo auto.
   3) Sinon fallback : ‚Äúic√¥ne‚Äù avec initiales.
-------------------------------------------- */
function checksum(addr){
  try{ return ethers.getAddress(addr); }catch{return addr;}
}
function trustWalletLogo(addr){
  // Ethereum (si dispo dans trustwallet)
  // URL raw GitHub trustwallet
  const cs = checksum(addr);
  return "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/" + cs + "/logo.png";
}
function makeFallbackSVG(sym){
  const initials = (sym||"?").slice(0,3);
  const bg = "rgba(255,255,255,.06)";
  const stroke = "rgba(255,255,255,.12)";
  const grad1 = "#a855f7", grad2="#ec4899";
  const svg =
    `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="${grad1}"/>
          <stop offset="1" stop-color="${grad2}"/>
        </linearGradient>
      </defs>
      <rect x="1" y="1" width="62" height="62" rx="18" fill="${bg}" stroke="${stroke}"/>
      <circle cx="32" cy="32" r="18" fill="url(#g)" opacity=".22"/>
      <text x="32" y="38" font-family="system-ui,Segoe UI,Roboto,Arial" font-size="18" font-weight="900"
        fill="#e5e7eb" text-anchor="middle">${initials}</text>
    </svg>`;
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}
function getLogoUrl(sym){
  const t = TOKENS[sym];
  if(!t) return makeFallbackSVG(sym);
  if(t.logo) return t.logo;
  if(t.address && t.chain === "eth") return trustWalletLogo(t.address);
  return makeFallbackSVG(sym);
}

async function refreshTokenModalBalances(force=false){
  if(!networkOk || !userAddress || !provider){
    // not connected
    tokenBalancesCache = {};
    renderTokenList(($("tmSearch").value||"").trim());
    return;
  }

  // petit cache (√©vite spam RPC)
  if(!force && Object.keys(tokenBalancesCache).length > 0){
    renderTokenList(($("tmSearch").value||"").trim());
    return;
  }

  const keys = Object.keys(TOKENS);
  const next = {};
  for(const sym of keys){
    try{
      const bal = await getBalance(sym);
      next[sym] = formatAmount(sym, bal);
    }catch(e){
      next[sym] = "‚Äî";
    }
  }
  tokenBalancesCache = next;
  renderTokenList(($("tmSearch").value||"").trim());
}

function renderTokenList(q){
  const list = $("tmList");
  const keys = Object.keys(TOKENS);
  const nq = norm(q);

  const filtered = keys.filter(sym=>{
    if(!q) return true;
    const t = TOKENS[sym];
    if(isAddr(q)) return t.address && norm(t.address) === nq;
    return norm(sym).includes(nq);
  });

  list.innerHTML = filtered.map(sym=>{
    const t = TOKENS[sym];
    const addr = t.address ? shortAddr(t.address) : "Native";
    const showBtns = !!t.address;
    const bal = tokenBalancesCache[sym] ?? "‚Äî";
    const logo = getLogoUrl(sym);
    return `
      <div class="tmRow" data-sym="${sym}">
        <div class="tmLeft">
          <div class="tmLogo"><img src="${logo}" alt="${sym}" onerror="this.src='${makeFallbackSVG(sym)}'"></div>
          <div>
            <div class="tmSym">${sym}</div>
            <div class="tmAddr">${addr}</div>
          </div>
        </div>

        <div class="tmMid">
          <div class="tmBalLabel">Balance</div>
          <div class="tmBalVal">${bal}</div>
        </div>

        <div class="tmActions">
          ${showBtns ? `
            <button class="tmIconBtn tmCopy" title="Copy address">üìã</button>
            <button class="tmIconBtn tmAdd" title="Add to MetaMask">ü¶ä</button>
          ` : `<span class="mono" style="color:#9ca3af;">‚Äî</span>`}
        </div>
      </div>
    `;
  }).join("");

  list.querySelectorAll(".tmRow").forEach(row=>{
    row.addEventListener("click", async (e)=>{
      const sym = row.dataset.sym;
      if(e.target.classList.contains("tmCopy") || e.target.classList.contains("tmAdd")) return;
      if(!tokenModalTarget) return;

      const { card, side } = tokenModalTarget;
      const sel = card.querySelector(side === "from" ? ".from" : ".to");
      sel.value = sym;

      closeTokenModal();
      await refreshCardBalance(card).catch(()=>{});
      await updateQuote(card).catch(()=>{});
    });
  });

  list.querySelectorAll(".tmCopy").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      const sym = btn.closest(".tmRow").dataset.sym;
      await copyText(TOKENS[sym].address);
      btn.textContent="‚úÖ";
      setTimeout(()=>btn.textContent="üìã", 700);
    });
  });

  list.querySelectorAll(".tmAdd").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      const sym = btn.closest(".tmRow").dataset.sym;
      await addTokenToMetaMask(sym);
    });
  });
}

/* Hook : ouvrir modal au clic sur les selects (PulseX-like) */
document.querySelectorAll(".swapbox").forEach(card=>{
  const fromSel = card.querySelector(".from");
  const toSel   = card.querySelector(".to");
  fromSel.addEventListener("mousedown", (e)=>{ e.preventDefault(); openTokenModal(card,"from"); });
  toSel.addEventListener("mousedown", (e)=>{ e.preventDefault(); openTokenModal(card,"to"); });
});

/* ================= INIT ================= */
setConnectedUI(false);
</script>
</body>
</html>
